<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover Your Financial DNA | Kou Talks Money</title>
    <meta property="og:title" content="Discover Your Financial DNA">
    <meta property="og:description" content="6 questions. 5 archetypes. Find the money system wired to your psychology.">
    <meta name="twitter:card" content="summary_large_image">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700;800&display=swap" rel="stylesheet">

    <!-- No self-redirect logic. Beehiiv redirects to budget-bridge.html -->

    <style>
        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #161923;
            --bg-card: #1c2030;
            --bg-input: #12141c;
            --accent: #f59e0b;
            --accent-glow: rgba(245,158,11,0.25);
            --accent-dim: rgba(245,158,11,0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #2a2f3e;
            --border-light: rgba(255,255,255,0.08);
            --green: #10b981;
            --blue: #60a5fa;
            --purple: #a78bfa;
            --pink: #f472b6;
            --red: #ef4444;
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            font-family:'Inter',-apple-system,sans-serif;
            background:var(--bg-primary);
            color:var(--text-primary);
            min-height:100vh;
            overflow-x:hidden;
        }
        .bg-ambient{
            position:fixed;inset:0;pointer-events:none;z-index:0;
            background:
                radial-gradient(ellipse at 20% 80%,rgba(99,59,159,0.15) 0%,transparent 50%),
                radial-gradient(ellipse at 80% 10%,rgba(59,99,159,0.12) 0%,transparent 50%);
        }
        .container{
            max-width:720px;margin:0 auto;padding:24px 16px;
            position:relative;z-index:1;min-height:100vh;
        }

        /* === HEADER === */
        .header{text-align:center;margin-bottom:28px;}
        .header-brand{
            font-size:0.7rem;color:var(--text-muted);
            text-transform:uppercase;letter-spacing:0.12em;margin-bottom:4px;
        }
        .header-brand a{color:var(--text-muted);text-decoration:none;}
        .header-brand a:hover{color:var(--accent);}
        .header-social{font-size:0.65rem;color:var(--text-muted);margin-bottom:16px;}
        .header-title{
            font-size:clamp(1.6rem,5vw,2.2rem);font-weight:800;
            letter-spacing:-0.02em;margin-bottom:6px;
            background:linear-gradient(135deg,#f1f5f9 30%,#94a3b8);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
            background-clip:text;
        }
        .header-sub{font-size:0.95rem;color:var(--text-secondary);line-height:1.5;}

        /* === MAIN CARD === */
        .main-card{
            background:var(--bg-secondary);
            border:1px solid var(--border-light);
            border-radius:16px;overflow:hidden;
            min-height:400px;position:relative;
        }

        /* === SECTIONS (only one visible at a time) === */
        .section{display:none;animation:fadeSlide 0.4s ease;}
        .section.active{display:block;}
        @keyframes fadeSlide{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

        /* === INTRO === */
        .intro{padding:48px 32px;text-align:center;}
        .intro-icon{
            width:80px;height:80px;border-radius:50%;
            background:var(--accent-dim);
            display:flex;align-items:center;justify-content:center;
            margin:0 auto 24px;
        }
        .intro-icon svg{width:40px;height:40px;stroke:var(--accent);fill:none;stroke-width:1.5;}
        .intro h2{font-size:1.4rem;font-weight:700;margin-bottom:12px;}
        .intro p{color:var(--text-secondary);max-width:420px;margin:0 auto 28px;line-height:1.6;font-size:0.9rem;}
        .intro-stats{
            display:flex;justify-content:center;gap:32px;
            margin-bottom:28px;
        }
        .intro-stat{text-align:center;}
        .intro-stat-val{
            font-family:'JetBrains Mono',monospace;font-size:1.3rem;
            font-weight:800;color:var(--accent);
        }
        .intro-stat-label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-top:2px;}

        /* === BUTTONS === */
        .btn-primary{
            background:var(--accent);color:#000;border:none;
            border-radius:10px;padding:14px 32px;
            font-family:'JetBrains Mono',monospace;font-size:0.85rem;
            font-weight:700;text-transform:uppercase;letter-spacing:0.04em;
            cursor:pointer;transition:all 0.3s;
        }
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px var(--accent-glow);}
        .btn-secondary{
            background:transparent;color:var(--text-secondary);border:1px solid var(--border);
            border-radius:8px;padding:10px 20px;font-size:0.8rem;font-weight:600;
            cursor:pointer;transition:all 0.2s;
        }
        .btn-secondary:hover{border-color:var(--accent);color:var(--accent);}

        /* === QUIZ === */
        .quiz{padding:24px 24px 32px;}
        .quiz-progress{height:3px;background:var(--bg-card);border-radius:2px;margin-bottom:24px;overflow:hidden;}
        .quiz-progress-bar{height:100%;background:var(--accent);border-radius:2px;transition:width 0.4s ease;}
        .quiz-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
        .quiz-step{
            font-family:'JetBrains Mono',monospace;font-size:0.7rem;
            color:var(--accent);text-transform:uppercase;letter-spacing:0.1em;font-weight:700;
        }
        .quiz-back{
            font-size:0.75rem;color:var(--text-muted);cursor:pointer;
            background:none;border:none;padding:4px 8px;transition:color 0.2s;
            display:none;
        }
        .quiz-back:hover{color:var(--text-primary);}
        .quiz-back.visible{display:inline-block;}
        .quiz-question{
            font-size:clamp(1.1rem,3.5vw,1.4rem);font-weight:700;
            line-height:1.35;margin-bottom:20px;color:var(--text-primary);
        }
        .quiz-options{display:flex;flex-direction:column;gap:10px;}
        .quiz-opt{
            background:var(--bg-card);border:1px solid var(--border-light);
            border-radius:10px;padding:14px 18px;cursor:pointer;
            transition:all 0.2s;display:flex;align-items:center;
            justify-content:space-between;gap:12px;
        }
        .quiz-opt:hover{border-color:rgba(245,158,11,0.4);background:rgba(245,158,11,0.05);}
        .quiz-opt-text{font-size:0.9rem;color:var(--text-secondary);line-height:1.4;}
        .quiz-opt:hover .quiz-opt-text{color:var(--text-primary);}
        .quiz-opt-arrow{
            color:var(--text-muted);font-size:0.8rem;opacity:0;
            transition:opacity 0.2s;flex-shrink:0;
        }
        .quiz-opt:hover .quiz-opt-arrow{opacity:1;color:var(--accent);}

        /* === PROCESSING THEATER === */
        .processing{padding:60px 32px;text-align:center;}
        .proc-spinner{
            width:56px;height:56px;margin:0 auto 24px;position:relative;
        }
        .proc-spinner-ring{
            width:100%;height:100%;border:3px solid var(--border);
            border-top-color:var(--accent);border-radius:50%;
            animation:spin 1s linear infinite;
        }
        @keyframes spin{to{transform:rotate(360deg);}}
        .proc-label{
            font-family:'JetBrains Mono',monospace;font-size:0.8rem;
            color:var(--accent);margin-bottom:6px;font-weight:600;
        }
        .proc-step{font-size:0.7rem;color:var(--text-muted);}
        .proc-steps-list{
            max-width:340px;margin:20px auto 0;text-align:left;
        }
        .proc-step-item{
            display:flex;align-items:center;gap:10px;
            padding:6px 0;font-size:0.75rem;color:var(--text-muted);
            transition:color 0.3s;
        }
        .proc-step-item.active{color:var(--accent);}
        .proc-step-item.done{color:var(--green);}
        .proc-check{
            width:16px;height:16px;border-radius:50%;
            border:2px solid var(--border);flex-shrink:0;
            display:flex;align-items:center;justify-content:center;
            font-size:0.6rem;transition:all 0.3s;
        }
        .proc-step-item.active .proc-check{border-color:var(--accent);background:var(--accent-dim);}
        .proc-step-item.done .proc-check{border-color:var(--green);background:rgba(16,185,129,0.15);color:var(--green);}

        /* === REVEAL + GATE === */
        .reveal{padding:0;}
        .reveal-header{
            padding:32px 24px;text-align:center;
            background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(245,158,11,0.02));
            border-bottom:1px solid rgba(245,158,11,0.15);
        }
        .reveal-eyebrow{
            font-family:'JetBrains Mono',monospace;font-size:0.65rem;
            color:var(--accent);text-transform:uppercase;letter-spacing:0.15em;
            margin-bottom:8px;font-weight:700;
        }
        .reveal-archetype{
            font-size:clamp(1.5rem,5vw,2rem);font-weight:800;
            letter-spacing:-0.02em;margin-bottom:4px;
        }
        .reveal-system{font-size:0.9rem;color:var(--text-secondary);margin-bottom:16px;}
        .reveal-why-summary{
            font-size:0.8rem;color:var(--text-muted);
            max-width:400px;margin:0 auto;line-height:1.6;
        }
        .reveal-why-summary strong{color:var(--text-secondary);}

        /* Gate overlay */
        .gate-wrapper{position:relative;min-height:300px;}
        .gate-overlay{
            position:absolute;inset:0;z-index:20;
            display:flex;flex-direction:column;align-items:center;
            justify-content:center;padding:32px 24px;
            background:linear-gradient(180deg,rgba(15,17,23,0.3) 0%,rgba(15,17,23,0.95) 40%);
            transition:opacity 0.5s ease,transform 0.5s ease;
        }
        .gate-overlay.hidden-gate{opacity:0;transform:translateY(-10px);pointer-events:none;}
        .gate-lock-icon{
            width:48px;height:48px;border-radius:50%;
            background:var(--accent-dim);border:2px solid rgba(245,158,11,0.3);
            display:flex;align-items:center;justify-content:center;
            margin-bottom:16px;
        }
        .gate-lock-icon svg{width:22px;height:22px;stroke:var(--accent);fill:none;stroke-width:2;}
        .gate-title{font-size:1.1rem;font-weight:700;margin-bottom:6px;text-align:center;}
        .gate-text{
            font-size:0.8rem;color:var(--text-secondary);text-align:center;
            max-width:360px;margin:0 auto 20px;line-height:1.5;
        }
        .gate-beehiiv{width:100%;max-width:460px;margin:0 auto;}
        .gate-beehiiv iframe{
            width:100%;height:320px;border:none;border-radius:12px;
            background:transparent;display:block;
        }
        .gate-skip{
            margin-top:12px;font-size:0.7rem;color:var(--text-muted);
            cursor:pointer;background:none;border:none;
            text-decoration:underline;display:none;
        }
        .gate-skip.visible{display:inline-block;}

        /* Blurred dashboard preview behind gate */
        .dash-preview{
            filter:blur(10px);user-select:none;pointer-events:none;
            padding:24px;opacity:0.4;
        }
        .dash-preview.unlocked{
            filter:none;user-select:auto;pointer-events:auto;opacity:1;
            transition:all 0.6s ease;
        }

        /* === DASHBOARD === */
        .dashboard{padding:0;}
        .dash-banner{
            padding:12px 20px;text-align:center;
            background:rgba(16,185,129,0.08);border-bottom:1px solid rgba(16,185,129,0.15);
            font-size:0.8rem;color:var(--green);font-weight:600;
            display:none;
        }
        .dash-banner.visible{display:block;animation:fadeSlide 0.4s ease;}
        .dash-header{
            padding:24px;text-align:center;
            background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(245,158,11,0.02));
            border-bottom:1px solid rgba(245,158,11,0.15);
        }
        .dash-archetype{
            font-size:clamp(1.3rem,4vw,1.7rem);font-weight:800;
            letter-spacing:-0.02em;margin-bottom:2px;
        }
        .dash-system-name{font-size:0.85rem;color:var(--text-secondary);}

        .dash-body{padding:24px;}

        /* Income input */
        .income-section{
            background:var(--bg-card);border:1px solid var(--border-light);
            border-radius:12px;padding:16px 20px;margin-bottom:24px;
        }
        .income-label{
            font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;
            letter-spacing:0.12em;font-weight:700;margin-bottom:10px;
            display:flex;align-items:center;gap:8px;
        }
        .income-imported{
            font-size:0.6rem;color:var(--green);font-weight:600;
            background:rgba(16,185,129,0.1);padding:2px 8px;border-radius:10px;
        }
        .income-row{display:flex;gap:10px;align-items:stretch;}
        .income-field{
            flex:1;position:relative;
        }
        .income-field span{
            position:absolute;left:12px;top:50%;transform:translateY(-50%);
            color:var(--text-muted);font-size:0.9rem;
        }
        .income-field input{
            width:100%;background:var(--bg-input);border:2px solid var(--border);
            border-radius:8px;padding:12px 12px 12px 28px;color:var(--text-primary);
            font-size:1rem;font-weight:600;outline:none;transition:border-color 0.2s;
            font-family:'Inter',sans-serif;
        }
        .income-field input:focus{border-color:var(--accent);}
        .income-field input::placeholder{color:var(--text-muted);font-weight:400;}
        .income-toggle{
            display:flex;background:var(--bg-input);border:1px solid var(--border);
            border-radius:8px;overflow:hidden;flex-shrink:0;
        }
        .income-toggle button{
            padding:10px 16px;font-size:0.75rem;font-weight:600;
            background:transparent;border:none;color:var(--text-muted);
            cursor:pointer;transition:all 0.2s;white-space:nowrap;
        }
        .income-toggle button.active{background:var(--accent);color:#000;}

        /* Content grid */
        .dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px;}
        @media(max-width:640px){.dash-grid{grid-template-columns:1fr;}}

        .dash-col h3{font-size:0.95rem;font-weight:700;margin-bottom:8px;}

        /* Description and Why sections */
        .dash-desc{font-size:0.85rem;color:var(--text-secondary);line-height:1.6;}
        .dash-why{font-size:0.85rem;color:rgba(245,158,11,0.85);line-height:1.6;}
        .dash-why-dynamic{
            margin-top:12px;padding:12px 16px;
            background:var(--accent-dim);border:1px solid rgba(245,158,11,0.15);
            border-radius:10px;font-size:0.8rem;color:var(--text-secondary);line-height:1.6;
        }
        .dash-why-dynamic strong{color:var(--accent);}

        /* CSS Doughnut */
        .doughnut-wrap{
            display:flex;align-items:center;justify-content:center;
            padding:16px;
        }
        .doughnut-container{
            position:relative;width:240px;height:240px;
        }
        .doughnut-ring{
            width:100%;height:100%;border-radius:50%;
            transition:background 0.5s ease;
            -webkit-mask:radial-gradient(circle,transparent 56%,black 57%);
            mask:radial-gradient(circle,transparent 56%,black 57%);
        }
        .doughnut-center{
            position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
            text-align:center;
        }
        .doughnut-center-value{
            font-family:'JetBrains Mono',monospace;font-size:1.2rem;
            font-weight:800;color:var(--text-primary);
        }
        .doughnut-center-label{
            font-size:0.65rem;color:var(--text-muted);margin-top:2px;
        }
        .doughnut-legend{
            display:flex;flex-direction:column;gap:6px;margin-top:12px;
        }
        .doughnut-legend-item{
            display:flex;align-items:center;justify-content:space-between;
            font-size:0.8rem;padding:8px 12px;
            background:var(--bg-card);border:1px solid var(--border-light);
            border-radius:8px;
        }
        .doughnut-legend-left{display:flex;align-items:center;gap:8px;}
        .doughnut-legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
        .doughnut-legend-label{color:var(--text-secondary);font-weight:500;}
        .doughnut-legend-value{
            font-family:'JetBrains Mono',monospace;font-weight:700;
            color:var(--text-primary);
        }

        /* System tabs */
        .tabs-section{
            border-top:1px solid var(--border-light);padding-top:20px;margin-bottom:24px;
        }
        .tabs-title{
            text-align:center;font-size:0.65rem;color:var(--text-muted);
            text-transform:uppercase;letter-spacing:0.12em;margin-bottom:12px;font-weight:700;
        }
        .tabs-row{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;}
        .sys-tab{
            padding:8px 14px;border-radius:20px;font-size:0.72rem;font-weight:600;
            border:1px solid var(--border);background:transparent;
            color:var(--text-muted);cursor:pointer;transition:all 0.2s;
            white-space:nowrap;
        }
        .sys-tab:hover{border-color:var(--accent);color:var(--accent);}
        .sys-tab.active{background:var(--accent);color:#000;border-color:var(--accent);}
        .sys-tab-score{
            font-family:'JetBrains Mono',monospace;font-size:0.6rem;
            margin-left:4px;opacity:0.7;
        }

        /* Cross-sell CTA */
        .cross-sell{
            background:linear-gradient(135deg,rgba(16,185,129,0.08),rgba(16,185,129,0.02));
            border:1px solid rgba(16,185,129,0.2);border-radius:12px;
            padding:20px;text-align:center;margin-bottom:24px;
        }
        .cross-sell-eyebrow{
            font-family:'JetBrains Mono',monospace;font-size:0.6rem;
            color:var(--green);text-transform:uppercase;letter-spacing:0.12em;
            margin-bottom:6px;font-weight:700;
        }
        .cross-sell-title{font-size:1rem;font-weight:700;margin-bottom:4px;}
        .cross-sell-text{font-size:0.8rem;color:var(--text-secondary);margin-bottom:14px;line-height:1.5;}
        .cross-sell-amount{
            font-family:'JetBrains Mono',monospace;font-size:1.4rem;
            font-weight:800;color:var(--green);margin-bottom:14px;
        }
        .cross-sell-btn{
            display:inline-flex;align-items:center;gap:8px;
            background:var(--green);color:#000;padding:12px 24px;
            border-radius:8px;font-family:'JetBrains Mono',monospace;
            font-size:0.8rem;font-weight:700;text-decoration:none;
            transition:all 0.3s;text-transform:uppercase;letter-spacing:0.04em;
        }
        .cross-sell-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(16,185,129,0.3);}

        /* Identity Card */
        .card-section{
            border-top:1px solid var(--border-light);padding-top:20px;
        }
        .card-section-title{
            text-align:center;font-size:0.65rem;color:var(--text-muted);
            text-transform:uppercase;letter-spacing:0.12em;margin-bottom:16px;font-weight:700;
        }
        .id-card{
            width:100%;max-width:400px;margin:0 auto;
            aspect-ratio:1.586/1;border-radius:16px;overflow:hidden;
            position:relative;
            background:linear-gradient(135deg,#0c0e1a 0%,#1a1d32 50%,#0e1020 100%);
            border:1px solid rgba(245,158,11,0.2);
            padding:24px;display:flex;flex-direction:column;
            justify-content:space-between;
        }
        .id-card-holo{
            position:absolute;top:-50%;right:-30%;width:300px;height:300px;
            background:conic-gradient(from 0deg,transparent,rgba(245,158,11,0.06),transparent,rgba(96,165,250,0.05),transparent);
            border-radius:50%;animation:holoSpin 8s linear infinite;pointer-events:none;
        }
        @keyframes holoSpin{to{transform:rotate(360deg);}}
        .id-card-top{display:flex;justify-content:space-between;align-items:flex-start;position:relative;z-index:1;}
        .id-card-badge{
            font-family:'JetBrains Mono',monospace;font-size:0.5rem;
            color:var(--accent);text-transform:uppercase;letter-spacing:0.15em;
            font-weight:700;border:1px solid rgba(245,158,11,0.3);
            padding:4px 10px;border-radius:4px;
        }
        .id-card-brand{
            font-family:'JetBrains Mono',monospace;font-size:0.55rem;
            color:var(--text-muted);text-align:right;
        }
        .id-card-mid{position:relative;z-index:1;}
        .id-card-archetype{
            font-family:'JetBrains Mono',monospace;font-size:clamp(1rem,3.5vw,1.3rem);
            font-weight:800;color:var(--accent);letter-spacing:0.06em;
            text-transform:uppercase;margin-bottom:2px;
        }
        .id-card-system{font-size:0.75rem;color:var(--text-secondary);margin-bottom:8px;}
        .id-card-alloc{display:flex;gap:12px;}
        .id-card-alloc-item{text-align:center;}
        .id-card-alloc-val{
            font-family:'JetBrains Mono',monospace;font-size:0.85rem;
            font-weight:700;color:var(--text-primary);
        }
        .id-card-alloc-lbl{font-size:0.5rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;}
        .id-card-bottom{
            display:flex;justify-content:space-between;align-items:flex-end;
            position:relative;z-index:1;
        }
        .id-card-income-val{
            font-family:'JetBrains Mono',monospace;font-size:1rem;
            font-weight:800;color:var(--text-primary);
        }
        .id-card-income-lbl{font-size:0.5rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;}
        .id-card-footer-brand{
            font-family:'JetBrains Mono',monospace;font-size:0.55rem;
            color:var(--accent);font-weight:700;
        }
        .card-actions{
            display:flex;justify-content:center;gap:10px;
            margin-top:16px;flex-wrap:wrap;
        }
        .card-download-btn{
            display:inline-flex;align-items:center;gap:8px;
            background:var(--accent);color:#000;padding:10px 20px;
            border:none;border-radius:8px;font-family:'JetBrains Mono',monospace;
            font-size:0.75rem;font-weight:700;cursor:pointer;transition:all 0.3s;
            text-transform:uppercase;
        }
        .card-download-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px var(--accent-glow);}
        .card-download-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
        .card-share-hint{
            text-align:center;font-size:0.7rem;color:var(--text-muted);margin-top:10px;
        }

        /* === FOOTER === */
        .footer{
            text-align:center;padding:20px 0 12px;margin-top:28px;
            border-top:1px solid var(--border-light);
        }
        .footer-privacy{font-size:0.7rem;color:var(--text-muted);margin-bottom:8px;line-height:1.5;}
        .footer-links{display:flex;justify-content:center;gap:16px;flex-wrap:wrap;}
        .footer-link{font-size:0.7rem;color:var(--text-muted);text-decoration:none;transition:color 0.2s;}
        .footer-link:hover{color:var(--accent);}

        /* === RESPONSIVE === */
        @media(max-width:480px){
            .container{padding:16px 12px;}
            .intro{padding:32px 20px;}
            .quiz{padding:20px 16px 28px;}
            .dash-body{padding:16px;}
            .income-row{flex-direction:column;}
            .income-toggle{align-self:stretch;}
            .income-toggle button{flex:1;}
            .doughnut-container{width:200px;height:200px;}
            .id-card{padding:18px;}
            .id-card-archetype{font-size:0.95rem;}
            .card-actions{flex-direction:column;align-items:stretch;}
        }
    </style>
</head>
<body>
    <div class="bg-ambient"></div>

    <div class="container">
        <header class="header">
            <div class="header-brand"><a href="https://instagram.com/koutalksmoney" target="_blank">made by kou</a></div>
            <div class="header-social">Instagram: @koutalksmoney &middot; YouTube: @FinanceWithKou</div>
            <h1 class="header-title" id="headerTitle">Discover Your Financial DNA</h1>
            <p class="header-sub" id="headerSub">6 questions. 5 archetypes. Find the money system wired to your psychology.</p>
        </header>

        <main class="main-card">

            <!-- INTRO -->
            <section id="s-intro" class="section intro active">
                <div class="intro-icon">
                    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg>
                </div>
                <h2>Stop guessing. Start engineering.</h2>
                <p>Answer 6 questions to discover which financial archetype matches your psychology, income pattern, and goals. Then we build the blueprint.</p>
                <div class="intro-stats">
                    <div class="intro-stat"><div class="intro-stat-val">6</div><div class="intro-stat-label">Questions</div></div>
                    <div class="intro-stat"><div class="intro-stat-val">5</div><div class="intro-stat-label">Archetypes</div></div>
                    <div class="intro-stat"><div class="intro-stat-val">90s</div><div class="intro-stat-label">To Complete</div></div>
                </div>
                <button class="btn-primary" id="startBtn">Start Assessment</button>
            </section>

            <!-- QUIZ -->
            <section id="s-quiz" class="section quiz">
                <div class="quiz-progress"><div class="quiz-progress-bar" id="quizBar"></div></div>
                <div class="quiz-meta">
                    <div class="quiz-step" id="quizStep">Question 1 of 6</div>
                    <button class="quiz-back" id="quizBack" onclick="goBack()">&#8592; Back</button>
                </div>
                <div class="quiz-question" id="quizQ"></div>
                <div class="quiz-options" id="quizOpts"></div>
            </section>

            <!-- PROCESSING -->
            <section id="s-processing" class="section processing">
                <div class="proc-spinner"><div class="proc-spinner-ring"></div></div>
                <div class="proc-label" id="procLabel">Analyzing responses...</div>
                <div class="proc-steps-list" id="procSteps"></div>
            </section>

            <!-- REVEAL + GATE -->
            <section id="s-reveal" class="section reveal">
                <div class="reveal-header">
                    <div class="reveal-eyebrow">Based on 6 answers, you are</div>
                    <div class="reveal-archetype" id="revealArchetype"></div>
                    <div class="reveal-system" id="revealSystem"></div>
                    <div class="reveal-why-summary" id="revealWhy"></div>
                </div>
                <div class="gate-wrapper">
                    <div class="gate-overlay" id="gateOverlay">
                        <div class="gate-lock-icon">
                            <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        </div>
                        <div class="gate-title">Your blueprint is ready.</div>
                        <div class="gate-text">6 answers analyzed. 1 archetype matched. Enter your email to unlock your full breakdown, dollar allocations, and comparison tools.</div>
                        <div class="gate-beehiiv">
                            <iframe id="beehiivFrame" src="https://subscribe-forms.beehiiv.com/e01f8d58-517b-4b46-afbf-78c51d559c90" scrolling="no"></iframe>
                        </div>
                        <button class="gate-skip" id="gateSkip" onclick="window.location.href='budget-bridge.html'">Already submitted? Click here</button>
                    </div>
                    <div class="dash-preview" id="dashPreview">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                            <div style="background:var(--bg-card);border-radius:10px;height:120px;border:1px solid var(--border-light);"></div>
                            <div style="background:var(--bg-card);border-radius:10px;height:120px;border:1px solid var(--border-light);"></div>
                        </div>
                        <div style="background:var(--bg-card);border-radius:10px;height:80px;margin-top:16px;border:1px solid var(--border-light);"></div>
                        <div style="background:var(--bg-card);border-radius:10px;height:60px;margin-top:16px;border:1px solid var(--border-light);"></div>
                    </div>
                </div>
            </section>

            <!-- DASHBOARD -->
            <section id="s-dashboard" class="section dashboard">
                <div class="dash-banner" id="dashBanner">&#10003; Blueprint Unlocked. Your personalized system is ready.</div>
                <div class="dash-header">
                    <div class="reveal-eyebrow">Your Financial Archetype</div>
                    <div class="dash-archetype" id="dashArchetype"></div>
                    <div class="dash-system-name" id="dashSystemName"></div>
                </div>
                <div class="dash-body">
                    <!-- Income Input -->
                    <div class="income-section">
                        <div class="income-label">
                            <span>Enter Your Income</span>
                            <span class="income-imported" id="incomeImported" style="display:none;">Imported from Autopilot</span>
                        </div>
                        <div class="income-row">
                            <div class="income-field">
                                <span>$</span>
                                <input type="number" id="incomeInput" placeholder="e.g. 5000" inputmode="numeric">
                            </div>
                            <div class="income-toggle">
                                <button id="btnMonthly" class="active" onclick="setPeriod('monthly')">Monthly</button>
                                <button id="btnAnnual" onclick="setPeriod('annual')">Annual</button>
                            </div>
                        </div>
                    </div>

                    <!-- Content Grid -->
                    <div class="dash-grid">
                        <div class="dash-col">
                            <h3>How it works</h3>
                            <div class="dash-desc" id="dashDesc"></div>
                            <div style="height:16px;"></div>
                            <h3>Why this matches you</h3>
                            <div class="dash-why" id="dashWhy"></div>
                            <div class="dash-why-dynamic" id="dashWhyDynamic"></div>
                        </div>
                        <div class="dash-col">
                            <div class="doughnut-wrap">
                                <div>
                                    <div class="doughnut-container">
                                        <div class="doughnut-ring" id="doughnutRing"></div>
                                        <div class="doughnut-center">
                                            <div class="doughnut-center-value" id="doughnutValue">--</div>
                                            <div class="doughnut-center-label" id="doughnutLabel">Enter income</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="doughnut-legend" id="doughnutLegend"></div>
                        </div>
                    </div>

                    <!-- System Tabs -->
                    <div class="tabs-section">
                        <div class="tabs-title">Explore All Archetypes</div>
                        <div class="tabs-row" id="tabsRow"></div>
                    </div>

                    <!-- Autopilot Cross-Sell -->
                    <div class="cross-sell" id="crossSell">
                        <div class="cross-sell-eyebrow">Next Step: Automate It</div>
                        <div class="cross-sell-title" id="crossSellTitle">Your system says invest. This tool does it.</div>
                        <div class="cross-sell-text" id="crossSellText">You've mapped the allocation. Now wire the automation.</div>
                        <div class="cross-sell-amount" id="crossSellAmount"></div>
                        <a href="#" class="cross-sell-btn" id="crossSellBtn">Install The Autopilot System &#8594;</a>
                    </div>

                    <!-- Identity Card -->
                    <div class="card-section">
                        <div class="card-section-title">Your Financial DNA Card</div>
                        <div class="id-card" id="idCard">
                            <div class="id-card-holo"></div>
                            <div class="id-card-top">
                                <div class="id-card-badge">Financial DNA</div>
                                <div class="id-card-brand">@koutalksmoney</div>
                            </div>
                            <div class="id-card-mid">
                                <div class="id-card-archetype" id="cardArchetype"></div>
                                <div class="id-card-system" id="cardSystem"></div>
                                <div class="id-card-alloc" id="cardAlloc"></div>
                            </div>
                            <div class="id-card-bottom">
                                <div>
                                    <div class="id-card-income-val" id="cardIncome">--</div>
                                    <div class="id-card-income-lbl">Monthly Income</div>
                                </div>
                                <div class="id-card-footer-brand">KOU TALKS MONEY</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-download-btn" id="cardDownloadBtn" onclick="downloadCard()">
                                <span id="cardBtnText">Download Card</span>
                            </button>
                        </div>
                        <div class="card-share-hint">Share your Financial DNA on Instagram, LinkedIn, or TikTok</div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <div class="footer-privacy">Your data stays on your device. Nothing is sent to our servers.</div>
            <div class="footer-links">
                <a href="https://spacekou5-oss.github.io/cashvault-funnel/autopilot-system.html" class="footer-link">Autopilot System</a>
                <a href="https://spacekou5-oss.github.io/cashvault-funnel/800-club.html" class="footer-link">800-Club</a>
                <a href="https://spacekou5-oss.github.io/cashvault-funnel/freedom-calculator.html" class="footer-link">Freedom Calculator</a>
                <a href="https://instagram.com/koutalksmoney" target="_blank" class="footer-link">Instagram</a>
            </div>
        </footer>
    </div>

    <script>
    // =========================================
    // 1. CONSTANTS & SYSTEM DATA
    // =========================================
    const AUTOPILOT_URL = 'https://spacekou5-oss.github.io/cashvault-funnel/autopilot-system.html';

    const SYSTEMS = {
        '50-30-20': {
            archetype: 'THE BALANCED STRATEGIST',
            title: '50/30/20 Rule',
            desc: '50% for Needs, 30% for Wants, 20% for Savings & Debt. The classic three-bucket system that works because it removes overthinking.',
            advantage: 'Clear percentages. Easy to remember. No spreadsheets required. You set the rails once and your money follows the tracks.',
            segments: [
                { label: 'Needs', pct: 50, color: '#f59e0b' },
                { label: 'Wants', pct: 30, color: '#818cf8' },
                { label: 'Savings & Debt', pct: 20, color: '#60a5fa' }
            ],
            investPct: 20,
            investLabel: 'savings/debt allocation'
        },
        'wealth-builder': {
            archetype: 'THE COMPOUND COMMANDER',
            title: 'Wealth Builder',
            desc: '50% for Needs, 25% for Investing, 15% for Wants, 10% for Savings. Four buckets engineered to prioritize compound growth over consumption.',
            advantage: 'Your money works harder than you do. Future wealth is the priority. Safety net stays intact. Wants get disciplined, not eliminated.',
            segments: [
                { label: 'Needs', pct: 50, color: '#f59e0b' },
                { label: 'Investing', pct: 25, color: '#10b981' },
                { label: 'Wants', pct: 15, color: '#818cf8' },
                { label: 'Savings', pct: 10, color: '#60a5fa' }
            ],
            investPct: 25,
            investLabel: 'investing allocation'
        },
        'pay-yourself-first': {
            archetype: 'THE AUTOMATION GHOST',
            title: 'Pay Yourself First',
            desc: '20% auto-transferred to savings or investing the moment income hits your account. The remaining 80% is yours to manage however you want.',
            advantage: 'Set the auto-transfer once. Never think about it again. Willpower removed from the equation. Your future self gets paid before your present self can spend it.',
            segments: [
                { label: 'Auto-Save/Invest', pct: 20, color: '#60a5fa' },
                { label: 'Everything Else', pct: 80, color: '#818cf8' }
            ],
            investPct: 20,
            investLabel: 'auto-save allocation'
        },
        '80-20': {
            archetype: 'THE MINIMALIST OPERATOR',
            title: '80/20 Budget',
            desc: '20% to Savings & Debt, 80% is one flexible pool for everything else. One rule. Maximum freedom.',
            advantage: 'Lowest maintenance system possible. Save first, then spend the rest guilt-free. No categories, no tracking, no spreadsheets. Just one clean split.',
            segments: [
                { label: 'Savings & Debt', pct: 20, color: '#60a5fa' },
                { label: 'Everything Else', pct: 80, color: '#818cf8' }
            ],
            investPct: 20,
            investLabel: 'savings/debt allocation'
        },
        'envelope': {
            archetype: 'THE CASH WARLORD',
            title: 'Envelope System',
            desc: 'Hard spending limits by category. When the envelope is empty, spending stops. No exceptions, no negotiations, no "I\'ll make up for it next month."',
            advantage: 'The nuclear option for overspenders. Forces instant feedback: you see the envelope balance drop in real time. Spending becomes a conscious act instead of an unconscious habit.',
            segments: [
                { label: 'Groceries', pct: 15, color: '#f472b6' },
                { label: 'Fun', pct: 10, color: '#a78bfa' },
                { label: 'Shopping', pct: 7.5, color: '#34d399' },
                { label: 'Fixed + Savings', pct: 67.5, color: '#64748b' }
            ],
            investPct: 15,
            investLabel: 'savings component'
        }
    };

    // =========================================
    // 2. QUIZ QUESTIONS (6, cut from 11)
    // =========================================
    const QUESTIONS = [
        {
            text: 'What is your #1 money goal for the next 12 months?',
            options: [
                { label: 'Get control of overspending', score: { 'envelope': 4, '50-30-20': 2 }, reason: 'controlling overspending is your top priority' },
                { label: 'Build an emergency savings buffer', score: { 'pay-yourself-first': 3, '80-20': 2 }, reason: 'building emergency savings is your focus' },
                { label: 'Aggressively invest and grow wealth', score: { 'wealth-builder': 4 }, reason: 'aggressive wealth growth is your #1 goal' },
                { label: 'Pay off debt faster', score: { 'envelope': 3, '50-30-20': 3 }, reason: 'eliminating debt is your primary objective' },
                { label: 'Keep things simple and stress-free', score: { '80-20': 4, 'pay-yourself-first': 3 }, reason: 'simplicity and low stress matter most to you' }
            ]
        },
        {
            text: 'How predictable is your income each month?',
            options: [
                { label: 'Very stable (same amount every month)', score: { 'wealth-builder': 2, '50-30-20': 2 }, reason: 'your stable income supports structured allocation' },
                { label: 'Somewhat stable (small swings)', score: { '50-30-20': 2 }, reason: 'your semi-stable income needs moderate flexibility' },
                { label: 'Very irregular (hours, tips, commissions)', score: { '80-20': 3, 'pay-yourself-first': 3 }, reason: 'your irregular income demands a flexible system' }
            ]
        },
        {
            text: 'Do you currently spend close to 100% of what you earn?',
            options: [
                { label: 'Yes, almost always', score: { 'envelope': 3, 'pay-yourself-first': 2 }, reason: 'you\'re spending nearly everything you earn' },
                { label: 'Sometimes, depends on the month', score: { '50-30-20': 2 }, reason: 'your spending occasionally hits your ceiling' },
                { label: 'No, I usually have money left over', score: { 'wealth-builder': 2, '80-20': 1 }, reason: 'you already have margin in your budget' }
            ]
        },
        {
            text: 'How aggressively do you want to save and invest right now?',
            options: [
                { label: 'Light: just want to start the habit', score: { '80-20': 3, 'pay-yourself-first': 2 }, reason: 'you want to start the savings habit without pressure' },
                { label: 'Moderate: consistent but comfortable', score: { '50-30-20': 3 }, reason: 'you want consistent, comfortable savings' },
                { label: 'Aggressive: I\'ll cut wants to build wealth faster', score: { 'wealth-builder': 4 }, reason: 'you\'re willing to sacrifice wants for faster wealth' }
            ]
        },
        {
            text: 'Do you have high-interest debt (credit cards, personal loans)?',
            options: [
                { label: 'Yes, a significant amount', score: { 'envelope': 4 }, reason: 'high-interest debt needs aggressive containment' },
                { label: 'Some, but manageable', score: { '50-30-20': 2 }, reason: 'your manageable debt allows balanced allocation' },
                { label: 'Very little or none', score: { 'wealth-builder': 2, 'pay-yourself-first': 1 }, reason: 'minimal debt frees your cash for investing' }
            ]
        },
        {
            text: 'Be honest: how likely are you to overspend if there are no hard limits?',
            options: [
                { label: 'Very likely. I swipe first, think later.', score: { 'envelope': 5 }, reason: 'you need hard spending limits to stay on track' },
                { label: 'Sometimes, depends on the category', score: { '50-30-20': 2 }, reason: 'occasional overspending benefits from guardrails' },
                { label: 'Not very likely. I\'m naturally cautious.', score: { 'wealth-builder': 2, '80-20': 2 }, reason: 'your natural spending discipline allows more freedom' }
            ]
        }
    ];

    const PROC_STEPS = [
        'Scoring 6 responses across 5 financial archetypes...',
        'Evaluating spending psychology profile...',
        'Matching income pattern to system requirements...',
        'Calculating optimal allocation ratios...',
        'Generating Financial DNA report...'
    ];

    // =========================================
    // 3. STATE
    // =========================================
    let state = {
        currentSection: 'intro',
        questionIndex: 0,
        scores: { '50-30-20': 0, 'wealth-builder': 0, 'pay-yourself-first': 0, '80-20': 0, 'envelope': 0 },
        answerHistory: [],   // { qi, oi, scoreMap }
        selectedSystem: '50-30-20',
        income: 0,
        incomePeriod: 'monthly',
        isUnlocked: false
    };

    // =========================================
    // 4. DOM REFS
    // =========================================
    const $ = id => document.getElementById(id);

    // =========================================
    // 5. UTILITY
    // =========================================
    function fmt(n) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n || 0);
    }
    function fmtShort(n) {
        if (n >= 1000000) return '$' + (n / 1000000).toFixed(1) + 'M';
        if (n >= 1000) return '$' + (n / 1000).toFixed(0) + 'K';
        return '$' + n;
    }
    function getMonthly() {
        return state.incomePeriod === 'annual' ? state.income / 12 : state.income;
    }

    // =========================================
    // 6. SECTION MANAGEMENT
    // =========================================
    function showSection(id) {
        state.currentSection = id;
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        $(id).classList.add('active');

        var sub = $('headerSub');
        if (id === 's-dashboard') {
            sub.textContent = 'Your personalized financial blueprint.';
        } else {
            sub.textContent = '6 questions. 5 archetypes. Find the money system wired to your psychology.';
        }
    }

    // =========================================
    // 7. QUIZ ENGINE
    // =========================================
    function renderQuestion() {
        var q = QUESTIONS[state.questionIndex];
        var total = QUESTIONS.length;
        var pct = (state.questionIndex / total) * 100;

        $('quizBar').style.width = pct + '%';
        $('quizStep').textContent = 'Question ' + (state.questionIndex + 1) + ' of ' + total;
        $('quizQ').textContent = q.text;

        var backBtn = $('quizBack');
        if (state.questionIndex > 0) backBtn.classList.add('visible');
        else backBtn.classList.remove('visible');

        var container = $('quizOpts');
        container.innerHTML = '';
        q.options.forEach(function(opt, oi) {
            var btn = document.createElement('div');
            btn.className = 'quiz-opt';
            btn.innerHTML = '<span class="quiz-opt-text">' + opt.label + '</span><span class="quiz-opt-arrow">&#8594;</span>';
            btn.onclick = function() { selectAnswer(state.questionIndex, oi); };
            container.appendChild(btn);
        });
    }

    function selectAnswer(qi, oi) {
        var opt = QUESTIONS[qi].options[oi];
        // Record answer for undo + dynamic why
        state.answerHistory.push({ qi: qi, oi: oi, scoreMap: Object.assign({}, opt.score) });
        // Apply scores
        Object.keys(opt.score).forEach(function(sys) {
            state.scores[sys] += opt.score[sys];
        });

        if (state.questionIndex < QUESTIONS.length - 1) {
            state.questionIndex++;
            renderQuestion();
        } else {
            finishQuiz();
        }
    }

    function goBack() {
        if (state.answerHistory.length === 0) return;
        var last = state.answerHistory.pop();
        // Subtract scores
        Object.keys(last.scoreMap).forEach(function(sys) {
            state.scores[sys] -= last.scoreMap[sys];
        });
        state.questionIndex--;
        renderQuestion();
    }

    // =========================================
    // 8. QUIZ COMPLETION
    // =========================================
    function finishQuiz() {
        // Determine winner
        var winner = '50-30-20';
        var maxScore = -1;
        Object.keys(state.scores).forEach(function(sys) {
            if (state.scores[sys] > maxScore) {
                maxScore = state.scores[sys];
                winner = sys;
            }
        });
        state.selectedSystem = winner;

        // Persist
        localStorage.setItem('budget_quiz_completed', 'true');
        localStorage.setItem('budget_selected_system', winner);
        localStorage.setItem('budget_scores', JSON.stringify(state.scores));
        localStorage.setItem('budget_answers', JSON.stringify(state.answerHistory));

        // Processing theater
        showSection('s-processing');
        runProcessingTheater();
    }

    // =========================================
    // 9. PROCESSING THEATER
    // =========================================
    function runProcessingTheater() {
        var container = $('procSteps');
        container.innerHTML = '';
        PROC_STEPS.forEach(function(text) {
            var el = document.createElement('div');
            el.className = 'proc-step-item';
            el.innerHTML = '<div class="proc-check"></div><span>' + text + '</span>';
            container.appendChild(el);
        });

        var items = container.querySelectorAll('.proc-step-item');
        var i = 0;
        var interval = setInterval(function() {
            if (i > 0) {
                items[i - 1].classList.remove('active');
                items[i - 1].classList.add('done');
                items[i - 1].querySelector('.proc-check').innerHTML = '&#10003;';
            }
            if (i < items.length) {
                items[i].classList.add('active');
                $('procLabel').textContent = PROC_STEPS[i];
                i++;
            } else {
                clearInterval(interval);
                setTimeout(showReveal, 400);
            }
        }, 750);
    }

    // =========================================
    // 10. REVEAL + GATE
    // =========================================
    function showReveal() {
        var sys = SYSTEMS[state.selectedSystem];
        $('revealArchetype').textContent = sys.archetype;
        $('revealSystem').textContent = sys.title;

        // Dynamic why summary from top answers
        var contributions = state.answerHistory
            .map(function(a) {
                var opt = QUESTIONS[a.qi].options[a.oi];
                return { reason: opt.reason, pts: opt.score[state.selectedSystem] || 0 };
            })
            .filter(function(c) { return c.pts > 0; })
            .sort(function(a, b) { return b.pts - a.pts; })
            .slice(0, 3);

        if (contributions.length > 0) {
            var reasons = contributions.map(function(c, i) { return '<strong>(' + (i + 1) + ')</strong> ' + c.reason; });
            $('revealWhy').innerHTML = 'You told us: ' + reasons.join('. ') + '. This archetype is built for that exact profile.';
        }

        showSection('s-reveal');

        // Show skip button after 15s
        setTimeout(function() {
            $('gateSkip').classList.add('visible');
        }, 15000);
    }

    // =========================================
    // 11. UNLOCK LOGIC (returning users via localStorage, set by bridge page)
    // =========================================
    // No unlockDashboard() needed here. Email flow redirects to budget-bridge.html.
    // Returning users with budget_unlocked=true in localStorage are routed
    // directly to dashboard in init().

    // =========================================
    // 12. DASHBOARD RENDERER
    // =========================================
    function renderDashboard() {
        var sys = SYSTEMS[state.selectedSystem];

        $('dashArchetype').textContent = sys.archetype;
        $('dashSystemName').textContent = sys.title;
        $('dashDesc').textContent = sys.desc;
        $('dashWhy').textContent = sys.advantage;

        // Dynamic why from answers
        renderDynamicWhy();

        // Render tabs
        renderTabs();

        // Render chart + legend
        updateChartAndLegend();

        // Render cross-sell
        updateCrossSell();

        // Render identity card
        updateIdCard();
    }

    function renderDynamicWhy() {
        var el = $('dashWhyDynamic');
        var answers = state.answerHistory;
        if (!answers || answers.length === 0) {
            // Try restore from localStorage
            try {
                var saved = JSON.parse(localStorage.getItem('budget_answers') || '[]');
                if (saved.length > 0) answers = saved;
            } catch(e) {}
        }
        if (!answers || answers.length === 0) {
            el.style.display = 'none';
            return;
        }
        el.style.display = 'block';

        var contributions = answers
            .map(function(a) {
                var opt = QUESTIONS[a.qi] ? QUESTIONS[a.qi].options[a.oi] : null;
                if (!opt) return null;
                return { reason: opt.reason, pts: opt.score[state.selectedSystem] || 0 };
            })
            .filter(function(c) { return c && c.pts > 0; })
            .sort(function(a, b) { return b.pts - a.pts; })
            .slice(0, 3);

        if (contributions.length === 0) {
            el.style.display = 'none';
            return;
        }
        var lines = contributions.map(function(c, i) { return '<strong>(' + (i + 1) + ')</strong> ' + c.reason; });
        el.innerHTML = 'Based on your answers: ' + lines.join('. ') + '.';
    }

    function renderTabs() {
        var row = $('tabsRow');
        row.innerHTML = '';
        var savedScores = state.scores;
        if (!savedScores || Object.values(savedScores).every(function(v){return v === 0;})) {
            try { savedScores = JSON.parse(localStorage.getItem('budget_scores') || '{}'); } catch(e) {}
        }

        Object.keys(SYSTEMS).forEach(function(key) {
            var sys = SYSTEMS[key];
            var btn = document.createElement('button');
            btn.className = 'sys-tab' + (key === state.selectedSystem ? ' active' : '');
            var scoreText = savedScores[key] ? '<span class="sys-tab-score">(' + savedScores[key] + ')</span>' : '';
            btn.innerHTML = sys.archetype.replace('THE ', '') + scoreText;
            btn.onclick = function() {
                state.selectedSystem = key;
                localStorage.setItem('budget_selected_system', key);
                renderDashboard();
            };
            row.appendChild(btn);
        });
    }

    // =========================================
    // 13. CSS DOUGHNUT CHART
    // =========================================
    function updateChartAndLegend() {
        var sys = SYSTEMS[state.selectedSystem];
        var monthly = getMonthly();
        var ring = $('doughnutRing');
        var centerVal = $('doughnutValue');
        var centerLbl = $('doughnutLabel');
        var legend = $('doughnutLegend');

        // Build conic gradient
        var stops = [];
        var cum = 0;
        sys.segments.forEach(function(seg) {
            stops.push(seg.color + ' ' + cum + '% ' + (cum + seg.pct) + '%');
            cum += seg.pct;
        });
        ring.style.background = 'conic-gradient(' + stops.join(', ') + ')';

        // Center text
        if (monthly > 0) {
            centerVal.textContent = fmt(monthly);
            centerLbl.textContent = 'Monthly';
        } else {
            // Show system shorthand when no income
            centerVal.textContent = sys.segments.map(function(s){return s.pct + '%';}).join('/');
            centerLbl.textContent = sys.title;
        }

        // Legend
        legend.innerHTML = '';
        sys.segments.forEach(function(seg) {
            var val = monthly > 0 ? fmt(monthly * seg.pct / 100) : seg.pct + '%';
            var el = document.createElement('div');
            el.className = 'doughnut-legend-item';
            el.innerHTML = '<div class="doughnut-legend-left"><div class="doughnut-legend-dot" style="background:' + seg.color + ';"></div><span class="doughnut-legend-label">' + seg.label + '</span></div><span class="doughnut-legend-value">' + val + '</span>';
            legend.appendChild(el);
        });
    }

    // =========================================
    // 14. CROSS-SELL CTA
    // =========================================
    function updateCrossSell() {
        var sys = SYSTEMS[state.selectedSystem];
        var monthly = getMonthly();
        var investAmt = Math.round(monthly * sys.investPct / 100);

        if (monthly > 0) {
            $('crossSellTitle').textContent = 'Your ' + sys.archetype + ' system allocates ' + sys.investPct + '% to ' + sys.investLabel + '.';
            $('crossSellAmount').textContent = fmt(investAmt) + '/mo on autopilot';
            $('crossSellAmount').style.display = 'block';
            $('crossSellBtn').href = AUTOPILOT_URL + '?source=budget&monthly=' + investAmt;
        } else {
            $('crossSellTitle').textContent = 'Your ' + sys.archetype + ' system says invest ' + sys.investPct + '%.';
            $('crossSellAmount').style.display = 'none';
            $('crossSellBtn').href = AUTOPILOT_URL + '?source=budget';
        }
        $('crossSellText').textContent = 'You\'ve mapped the allocation. Now wire the automation so it runs without you.';
    }

    // =========================================
    // 15. IDENTITY CARD
    // =========================================
    function updateIdCard() {
        var sys = SYSTEMS[state.selectedSystem];
        var monthly = getMonthly();

        $('cardArchetype').textContent = sys.archetype;
        $('cardSystem').textContent = sys.title + ' | ' + sys.segments.map(function(s){return s.pct + '%';}).join('/');

        var alloc = $('cardAlloc');
        alloc.innerHTML = '';
        sys.segments.forEach(function(seg) {
            var val = monthly > 0 ? fmt(monthly * seg.pct / 100) : seg.pct + '%';
            var el = document.createElement('div');
            el.className = 'id-card-alloc-item';
            el.innerHTML = '<div class="id-card-alloc-val">' + val + '</div><div class="id-card-alloc-lbl">' + seg.label + '</div>';
            alloc.appendChild(el);
        });

        $('cardIncome').textContent = monthly > 0 ? fmt(monthly) : '--';
    }

    function downloadCard() {
        var btn = $('cardDownloadBtn');
        var btnText = $('cardBtnText');
        btn.disabled = true;
        btnText.textContent = 'Generating...';

        // Dynamically load html2canvas
        if (window.html2canvas) {
            captureCard();
        } else {
            var script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.onload = captureCard;
            script.onerror = function() {
                btnText.textContent = 'Download Failed';
                setTimeout(function(){ btn.disabled = false; btnText.textContent = 'Download Card'; }, 2000);
            };
            document.head.appendChild(script);
        }
    }

    function captureCard() {
        var card = $('idCard');
        html2canvas(card, {
            scale: 3,
            backgroundColor: '#0c0e1a',
            useCORS: true,
            logging: false
        }).then(function(canvas) {
            var link = document.createElement('a');
            link.download = 'financial-dna-' + SYSTEMS[state.selectedSystem].archetype.replace(/\s+/g, '-').toLowerCase() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            $('cardBtnText').textContent = 'Downloaded!';
            setTimeout(function(){
                $('cardDownloadBtn').disabled = false;
                $('cardBtnText').textContent = 'Download Card';
            }, 2000);
        }).catch(function() {
            $('cardBtnText').textContent = 'Download Failed';
            setTimeout(function(){
                $('cardDownloadBtn').disabled = false;
                $('cardBtnText').textContent = 'Download Card';
            }, 2000);
        });
    }

    // =========================================
    // 16. INCOME INPUT HANDLERS
    // =========================================
    $('incomeInput').addEventListener('input', function(e) {
        var val = parseFloat(e.target.value);
        state.income = isNaN(val) ? 0 : val;
        localStorage.setItem('budget_income', state.income.toString());
        updateChartAndLegend();
        updateCrossSell();
        updateIdCard();
    });

    function setPeriod(p) {
        state.incomePeriod = p;
        localStorage.setItem('budget_income_period', p);
        $('btnMonthly').classList.toggle('active', p === 'monthly');
        $('btnAnnual').classList.toggle('active', p === 'annual');
        updateChartAndLegend();
        updateCrossSell();
        updateIdCard();
    }

    // =========================================
    // 17. START BUTTON
    // =========================================
    $('startBtn').addEventListener('click', function() {
        state.questionIndex = 0;
        state.scores = { '50-30-20': 0, 'wealth-builder': 0, 'pay-yourself-first': 0, '80-20': 0, 'envelope': 0 };
        state.answerHistory = [];
        showSection('s-quiz');
        renderQuestion();
    });

    // =========================================
    // 18. INITIALIZATION
    // =========================================
    (function init() {
        var quizDone = localStorage.getItem('budget_quiz_completed') === 'true';
        var isUnlocked = localStorage.getItem('budget_unlocked') === 'true';
        var savedSystem = localStorage.getItem('budget_selected_system');
        var savedIncome = localStorage.getItem('budget_income');
        var savedPeriod = localStorage.getItem('budget_income_period');
        var savedScores = null;
        var savedAnswers = null;

        try { savedScores = JSON.parse(localStorage.getItem('budget_scores')); } catch(e) {}
        try { savedAnswers = JSON.parse(localStorage.getItem('budget_answers')); } catch(e) {}

        // Ghost Handshake: import income from Autopilot if available
        var autopilotImported = false;
        if (!savedIncome || savedIncome === '0') {
            try {
                var apData = JSON.parse(localStorage.getItem('autopilot_system_data') || 'null');
                if (apData && apData.income && apData.income > 0) {
                    savedIncome = apData.income.toString();
                    localStorage.setItem('budget_income', savedIncome);
                    autopilotImported = true;
                }
            } catch(e) {}
        }

        // URL param overrides
        var params = new URLSearchParams(window.location.search);
        if (params.get('sys') && SYSTEMS[params.get('sys')]) {
            savedSystem = params.get('sys');
            localStorage.setItem('budget_selected_system', savedSystem);
        }
        if (params.get('inc')) {
            savedIncome = params.get('inc');
            localStorage.setItem('budget_income', savedIncome);
        }
        if (params.get('per')) {
            savedPeriod = params.get('per');
            localStorage.setItem('budget_income_period', savedPeriod);
        }

        // Restore state
        if (savedSystem && SYSTEMS[savedSystem]) state.selectedSystem = savedSystem;
        if (savedIncome) state.income = parseFloat(savedIncome) || 0;
        if (savedPeriod) state.incomePeriod = savedPeriod;
        if (savedScores) state.scores = savedScores;
        if (savedAnswers) state.answerHistory = savedAnswers;

        // Populate inputs
        if (state.income > 0) {
            $('incomeInput').value = state.income;
            if (autopilotImported) $('incomeImported').style.display = 'inline-block';
        }
        if (state.incomePeriod === 'annual') {
            $('btnAnnual').classList.add('active');
            $('btnMonthly').classList.remove('active');
        }

        // Route to correct section
        if (quizDone && isUnlocked) {
            // Returning unlocked user: straight to dashboard
            state.isUnlocked = true;
            renderDashboard();
            showSection('s-dashboard');
        } else if (quizDone && !isUnlocked) {
            // Quiz done but not unlocked: show reveal with gate
            var sys = SYSTEMS[state.selectedSystem];
            $('revealArchetype').textContent = sys.archetype;
            $('revealSystem').textContent = sys.title;
            renderDynamicWhyForReveal();
            showSection('s-reveal');
            setTimeout(function() { $('gateSkip').classList.add('visible'); }, 15000);
        } else {
            // Fresh user
            showSection('s-intro');
        }
    })();

    function renderDynamicWhyForReveal() {
        var answers = state.answerHistory;
        if (!answers || answers.length === 0) return;
        var contributions = answers
            .map(function(a) {
                var opt = QUESTIONS[a.qi] ? QUESTIONS[a.qi].options[a.oi] : null;
                if (!opt) return null;
                return { reason: opt.reason, pts: opt.score[state.selectedSystem] || 0 };
            })
            .filter(function(c) { return c && c.pts > 0; })
            .sort(function(a, b) { return b.pts - a.pts; })
            .slice(0, 3);
        if (contributions.length > 0) {
            var reasons = contributions.map(function(c, i) { return '<strong>(' + (i + 1) + ')</strong> ' + c.reason; });
            $('revealWhy').innerHTML = 'You told us: ' + reasons.join('. ') + '. This archetype is built for that exact profile.';
        }
    }
    </script>
</body>
</html>
