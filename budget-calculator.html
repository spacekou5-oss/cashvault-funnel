<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover Your Financial DNA | Kou Talks Money</title>
    <meta property="og:title" content="Discover Your Financial DNA">
    <meta property="og:description" content="6 questions. Your personalized allocation blueprint. Find the system wired to your psychology.">
    <meta name="twitter:card" content="summary_large_image">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #161923;
            --bg-card: #1c2030;
            --bg-input: #12141c;
            --accent: #f59e0b;
            --accent-glow: rgba(245,158,11,0.25);
            --accent-dim: rgba(245,158,11,0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #2a2f3e;
            --border-light: rgba(255,255,255,0.08);
            --green: #10b981;
            --blue: #60a5fa;
            --purple: #a78bfa;
            --pink: #f472b6;
            --red: #ef4444;
            --cyan: #00F0FF;
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            font-family:'Inter',-apple-system,sans-serif;
            background:var(--bg-primary);
            color:var(--text-primary);
            min-height:100vh;
            overflow-x:hidden;
        }
        .bg-ambient{
            position:fixed;inset:0;pointer-events:none;z-index:0;
            background:
                radial-gradient(ellipse at 20% 80%,rgba(99,59,159,0.15) 0%,transparent 50%),
                radial-gradient(ellipse at 80% 10%,rgba(59,99,159,0.12) 0%,transparent 50%);
        }
        .container{
            max-width:720px;margin:0 auto;padding:24px 16px;
            position:relative;z-index:1;min-height:100vh;
        }
        .header{text-align:center;margin-bottom:28px;}
        .header-brand{
            font-size:0.65rem;color:var(--text-muted);
            text-transform:uppercase;letter-spacing:0.14em;margin-bottom:16px;
            font-weight:600;
        }
        .header-brand a{color:var(--text-muted);text-decoration:none;transition:color 0.2s;}
        .header-brand a:hover{color:var(--accent);}
        .header-title{
            font-size:clamp(1.6rem,5vw,2.2rem);font-weight:800;
            letter-spacing:-0.02em;margin-bottom:6px;
            background:linear-gradient(135deg,#f1f5f9 30%,#94a3b8);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
            background-clip:text;
        }
        .header-sub{font-size:0.95rem;color:var(--text-secondary);line-height:1.5;}
        .main-card{
            background:var(--bg-secondary);
            border:1px solid var(--border-light);
            border-radius:16px;overflow:hidden;
            min-height:400px;position:relative;
        }
        .section{display:none;animation:fadeSlide 0.4s ease;}
        .section.active{display:block;}
        @keyframes fadeSlide{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

        /* ========== UPSTREAM THEATER (800-Club Bridge) ========== */
        .upstream-theater{padding:60px 32px;text-align:center;}
        .upstream-theater-badge{
            display:inline-block;padding:6px 14px;border-radius:20px;
            font-family:'JetBrains Mono',monospace;font-size:0.65rem;font-weight:700;
            text-transform:uppercase;letter-spacing:0.1em;margin-bottom:20px;
            background:rgba(0,240,255,0.08);border:1px solid rgba(0,240,255,0.25);
            color:var(--cyan);
        }
        .upstream-theater h2{
            font-size:1.3rem;font-weight:700;margin-bottom:6px;
            color:var(--text-primary);
        }
        .upstream-theater-sub{font-size:0.85rem;color:var(--text-secondary);margin-bottom:28px;}
        .upstream-spinner{width:48px;height:48px;margin:0 auto 20px;position:relative;}
        .upstream-spinner-ring{
            width:100%;height:100%;
            border:3px solid var(--border);border-top-color:var(--cyan);
            border-radius:50%;animation:spin 1s linear infinite;
        }
        @keyframes spin{to{transform:rotate(360deg);}}
        .upstream-steps{max-width:340px;margin:0 auto;text-align:left;}
        .upstream-step{
            display:flex;align-items:center;gap:10px;padding:7px 0;
            font-size:0.75rem;color:var(--text-muted);transition:color 0.3s;
        }
        .upstream-step.active{color:var(--cyan);}
        .upstream-step.done{color:var(--green);}
        .upstream-check{
            width:16px;height:16px;border-radius:50%;border:2px solid var(--border);
            flex-shrink:0;display:flex;align-items:center;justify-content:center;
            font-size:0.6rem;transition:all 0.3s;
        }
        .upstream-step.active .upstream-check{border-color:var(--cyan);background:rgba(0,240,255,0.1);}
        .upstream-step.done .upstream-check{border-color:var(--green);background:rgba(16,185,129,0.15);color:var(--green);}
        .upstream-progress{
            width:100%;max-width:300px;height:3px;background:var(--border);
            border-radius:2px;margin:20px auto 0;overflow:hidden;
        }
        .upstream-progress-bar{height:100%;background:var(--cyan);border-radius:2px;transition:width 0.4s ease;width:0%;}

        /* ========== INTRO ========== */
        .intro{padding:48px 32px;text-align:center;}
        .intro-icon{
            width:80px;height:80px;border-radius:50%;
            background:var(--accent-dim);
            display:flex;align-items:center;justify-content:center;
            margin:0 auto 24px;
        }
        .intro-icon svg{width:40px;height:40px;stroke:var(--accent);fill:none;stroke-width:1.5;}
        .intro-upstream-badge{
            display:inline-block;padding:6px 14px;border-radius:20px;
            font-family:'JetBrains Mono',monospace;font-size:0.65rem;font-weight:700;
            text-transform:uppercase;letter-spacing:0.1em;margin-bottom:16px;
            background:rgba(0,240,255,0.08);border:1px solid rgba(0,240,255,0.25);
            color:var(--cyan);
        }
        .intro h2{font-size:1.4rem;font-weight:700;margin-bottom:12px;}
        .intro p{color:var(--text-secondary);max-width:420px;margin:0 auto 28px;line-height:1.6;font-size:0.9rem;}
        .intro-stats{display:flex;justify-content:center;gap:32px;margin-bottom:28px;}
        .intro-stat{text-align:center;}
        .intro-stat-val{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:800;color:var(--accent);}
        .intro-stat-label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-top:2px;}

        .btn-primary{
            background:var(--accent);color:#000;border:none;
            border-radius:10px;padding:14px 32px;
            font-family:'JetBrains Mono',monospace;font-size:0.85rem;
            font-weight:700;text-transform:uppercase;letter-spacing:0.04em;
            cursor:pointer;transition:all 0.3s;
        }
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px var(--accent-glow);}
        .btn-secondary{
            background:transparent;color:var(--text-secondary);border:1px solid var(--border);
            border-radius:8px;padding:10px 20px;font-size:0.8rem;font-weight:600;
            cursor:pointer;transition:all 0.2s;
        }
        .btn-secondary:hover{border-color:var(--accent);color:var(--accent);}

        /* ========== QUIZ ========== */
        .quiz{padding:24px 24px 32px;}
        .quiz-progress{height:3px;background:var(--bg-card);border-radius:2px;margin-bottom:24px;overflow:hidden;}
        .quiz-progress-bar{height:100%;background:var(--accent);border-radius:2px;transition:width 0.4s ease;}
        .quiz-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
        .quiz-step{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--accent);text-transform:uppercase;letter-spacing:0.1em;font-weight:700;}
        .quiz-back{font-size:0.75rem;color:var(--text-muted);cursor:pointer;background:none;border:none;padding:4px 8px;transition:color 0.2s;display:none;}
        .quiz-back:hover{color:var(--text-primary);}
        .quiz-back.visible{display:inline-block;}
        .quiz-question{font-size:clamp(1.1rem,3.5vw,1.4rem);font-weight:700;line-height:1.35;margin-bottom:20px;color:var(--text-primary);}
        .quiz-options{display:flex;flex-direction:column;gap:10px;}
        .quiz-opt{
            background:var(--bg-card);border:1px solid var(--border-light);
            border-radius:10px;padding:14px 18px;cursor:pointer;
            transition:all 0.2s;display:flex;align-items:center;
            justify-content:space-between;gap:12px;
        }
        .quiz-opt:hover{border-color:rgba(245,158,11,0.4);background:rgba(245,158,11,0.05);}
        .quiz-opt-text{font-size:0.9rem;color:var(--text-secondary);line-height:1.4;}
        .quiz-opt:hover .quiz-opt-text{color:var(--text-primary);}
        .quiz-opt-arrow{color:var(--text-muted);font-size:0.8rem;opacity:0;transition:opacity 0.2s;flex-shrink:0;}
        .quiz-opt:hover .quiz-opt-arrow{opacity:1;color:var(--accent);}

        /* ========== PROCESSING ========== */
        .processing{padding:60px 32px;text-align:center;}
        .proc-spinner{width:56px;height:56px;margin:0 auto 24px;position:relative;}
        .proc-spinner-ring{width:100%;height:100%;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;}
        .proc-label{font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:var(--accent);margin-bottom:6px;font-weight:600;}
        .proc-step{font-size:0.7rem;color:var(--text-muted);}
        .proc-steps-list{max-width:340px;margin:20px auto 0;text-align:left;}
        .proc-step-item{display:flex;align-items:center;gap:10px;padding:6px 0;font-size:0.75rem;color:var(--text-muted);transition:color 0.3s;}
        .proc-step-item.active{color:var(--accent);}
        .proc-step-item.done{color:var(--green);}
        .proc-check{width:16px;height:16px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:0.6rem;transition:all 0.3s;}
        .proc-step-item.active .proc-check{border-color:var(--accent);background:var(--accent-dim);}
        .proc-step-item.done .proc-check{border-color:var(--green);background:rgba(16,185,129,0.15);color:var(--green);}

        /* ========== REVEAL + GATE ========== */
        .reveal{padding:0;}
        .reveal-header{
            padding:32px 24px;text-align:center;
            background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(245,158,11,0.02));
            border-bottom:1px solid rgba(245,158,11,0.15);
        }
        .reveal-eyebrow{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--accent);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:8px;font-weight:700;}
        .reveal-archetype{font-size:clamp(1.5rem,5vw,2rem);font-weight:800;letter-spacing:-0.02em;margin-bottom:4px;}
        .reveal-system{font-size:0.9rem;color:var(--text-secondary);margin-bottom:16px;}
        .reveal-why-summary{font-size:0.8rem;color:var(--text-muted);max-width:400px;margin:0 auto;line-height:1.6;}
        .reveal-why-summary strong{color:var(--text-secondary);}

        .gate-wrapper{position:relative;min-height:480px;}
        .gate-overlay{
            position:absolute;inset:0;z-index:20;
            display:flex;flex-direction:column;align-items:center;
            justify-content:flex-start;
            padding:28px 24px 24px;
            background:linear-gradient(180deg,rgba(15,17,23,0.4) 0%,rgba(15,17,23,0.97) 30%);
            transition:opacity 0.5s ease,transform 0.5s ease;
            overflow-y:auto;-webkit-overflow-scrolling:touch;
        }
        .gate-overlay.hidden-gate{opacity:0;transform:translateY(-10px);pointer-events:none;}
        .gate-lock-icon{
            width:48px;height:48px;border-radius:50%;
            background:var(--accent-dim);border:2px solid rgba(245,158,11,0.3);
            display:flex;align-items:center;justify-content:center;
            margin-bottom:14px;flex-shrink:0;
        }
        .gate-lock-icon svg{width:22px;height:22px;stroke:var(--accent);fill:none;stroke-width:2;}
        .gate-title{font-size:1.1rem;font-weight:700;margin-bottom:6px;text-align:center;flex-shrink:0;}
        .gate-text{
            font-size:0.8rem;color:var(--text-secondary);text-align:center;
            max-width:360px;margin:0 auto 16px;line-height:1.5;flex-shrink:0;
        }
        .gate-value-stack{
            display:flex;flex-direction:column;gap:6px;max-width:320px;
            margin:0 auto 16px;flex-shrink:0;
        }
        .gate-value-item{
            display:flex;align-items:center;gap:8px;
            font-size:0.75rem;color:var(--text-secondary);
        }
        .gate-value-check{color:var(--green);font-size:0.8rem;flex-shrink:0;}
        .gate-beehiiv{width:100%;max-width:460px;margin:0 auto;flex-shrink:0;}
        .gate-beehiiv iframe{
            width:100%;height:52vh;min-height:380px;max-height:500px;
            border:none;border-radius:12px;background:transparent;display:block;
        }

        .dash-preview{filter:blur(10px);user-select:none;pointer-events:none;padding:24px;opacity:0.4;}
        .dash-preview.unlocked{filter:none;user-select:auto;pointer-events:auto;opacity:1;transition:all 0.6s ease;}

        /* ========== DASHBOARD ========== */
        .dashboard{padding:0;}
        .dash-banner{
            padding:12px 20px;text-align:center;
            background:rgba(16,185,129,0.08);border-bottom:1px solid rgba(16,185,129,0.15);
            font-size:0.8rem;color:var(--green);font-weight:600;
            display:none;
        }
        .dash-banner.visible{display:block;animation:fadeSlide 0.4s ease;}

        /* OPT-6: Trust strip */
        .trust-strip{
            display:flex;justify-content:center;gap:16px;padding:10px 16px;
            font-size:0.65rem;color:var(--text-muted);
            border-bottom:1px solid var(--border-light);
            background:rgba(16,185,129,0.03);
        }
        .trust-strip-item{display:flex;align-items:center;gap:4px;}
        .trust-strip-icon{font-size:0.75rem;}

        .dash-header{
            padding:24px;text-align:center;
            background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(245,158,11,0.02));
            border-bottom:1px solid rgba(245,158,11,0.15);
        }
        .dash-archetype{font-size:clamp(1.3rem,4vw,1.7rem);font-weight:800;letter-spacing:-0.02em;margin-bottom:2px;}
        .dash-system-name{font-size:0.85rem;color:var(--text-secondary);}
        .dash-body{padding:24px;}

        /* Income section with OPT-3 glow state */
        .income-section{
            background:var(--bg-card);border:1px solid var(--border-light);
            border-radius:12px;padding:16px 20px;margin-bottom:24px;
            transition:border-color 0.4s ease, box-shadow 0.4s ease;
        }
        .income-section.has-income{
            border-color:rgba(245,158,11,0.25);
            box-shadow:0 0 20px rgba(245,158,11,0.06);
        }
        .income-label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.12em;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
        .income-imported{font-size:0.6rem;color:var(--green);font-weight:600;background:rgba(16,185,129,0.1);padding:2px 8px;border-radius:10px;}
        /* OPT-3: Personalized badge */
        .income-personalized{
            display:none;font-size:0.6rem;color:var(--green);font-weight:600;
            background:rgba(16,185,129,0.1);padding:2px 8px;border-radius:10px;
            animation:fadeSlide 0.3s ease;
        }
        .income-personalized.show{display:inline-block;}
        /* OPT-1: Income nudge micro-copy */
        .income-nudge{
            font-size:0.72rem;color:var(--text-secondary);margin-bottom:12px;
            line-height:1.5;transition:all 0.3s;
        }
        .income-nudge .nudge-highlight{color:var(--accent);font-weight:600;}
        .income-row{display:flex;gap:10px;align-items:stretch;}
        .income-field{flex:1;position:relative;}
        .income-field span{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:0.9rem;}
        .income-field input{
            width:100%;background:var(--bg-input);border:2px solid var(--border);
            border-radius:8px;padding:12px 12px 12px 28px;color:var(--text-primary);
            font-size:1rem;font-weight:600;outline:none;transition:border-color 0.2s;
            font-family:'Inter',sans-serif;
        }
        .income-field input:focus{border-color:var(--accent);}
        .income-field input::placeholder{color:var(--text-muted);font-weight:400;}
        /* FIX-1 (SILHOUETTE): Clean toggle. No position:relative. No extra spans. No pseudo-elements. */
        .income-toggle{
            display:flex;background:var(--bg-input);border:1px solid var(--border);
            border-radius:8px;overflow:hidden;flex-shrink:0;
        }
        .income-toggle button{padding:10px 16px;font-size:0.75rem;font-weight:600;background:transparent;border:none;color:var(--text-muted);cursor:pointer;transition:all 0.2s;white-space:nowrap;}
        .income-toggle button.active{background:var(--accent);color:#000;}
        /* FIX-1: .income-toggle-rec CSS DELETED ENTIRELY. No ghost text. */

        .dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px;}
        /* OPT-2: Mobile reorder: doughnut FIRST */
        @media(max-width:640px){
            .dash-grid{grid-template-columns:1fr;}
            .dash-col-chart{order:-1;}
        }
        .dash-col h3{font-size:0.95rem;font-weight:700;margin-bottom:8px;}
        .dash-desc{font-size:0.85rem;color:var(--text-secondary);line-height:1.6;}
        .dash-why{font-size:0.85rem;color:rgba(245,158,11,0.85);line-height:1.6;}
        .dash-why-dynamic{margin-top:12px;padding:12px 16px;background:var(--accent-dim);border:1px solid rgba(245,158,11,0.15);border-radius:10px;font-size:0.8rem;color:var(--text-secondary);line-height:1.6;}
        .dash-why-dynamic strong{color:var(--accent);}
        .doughnut-wrap{display:flex;align-items:center;justify-content:center;padding:16px;}
        .doughnut-container{position:relative;width:240px;height:240px;}
        .doughnut-ring{width:100%;height:100%;border-radius:50%;transition:background 0.5s ease;-webkit-mask:radial-gradient(circle,transparent 56%,black 57%);mask:radial-gradient(circle,transparent 56%,black 57%);}
        .doughnut-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;}
        .doughnut-center-value{
            font-family:'JetBrains Mono',monospace;font-size:1.2rem;
            font-weight:800;color:var(--text-primary);transition:color 0.3s;
        }
        .doughnut-center-value.active{color:var(--accent);}
        .doughnut-center-label{font-size:0.65rem;color:var(--text-muted);margin-top:2px;}
        .doughnut-center-brand{
            font-family:'JetBrains Mono',monospace;font-size:0.5rem;
            color:rgba(245,158,11,0.5);margin-top:6px;letter-spacing:0.04em;font-weight:600;
        }
        .doughnut-legend{display:flex;flex-direction:column;gap:6px;margin-top:12px;}
        .doughnut-legend-item{display:flex;align-items:center;justify-content:space-between;font-size:0.8rem;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border-light);border-radius:8px;}
        .doughnut-legend-left{display:flex;align-items:center;gap:8px;}
        .doughnut-legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
        .doughnut-legend-label{color:var(--text-secondary);font-weight:500;}
        .doughnut-legend-value{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--text-primary);display:flex;align-items:baseline;gap:5px;}
        .doughnut-legend-pct{font-size:0.65rem;font-weight:500;color:var(--text-muted);}
        .doughnut-legend-item.editable{padding:6px 10px;}
        .envelope-input-wrap{display:flex;align-items:center;gap:4px;flex-shrink:0;}
        .envelope-input-wrap .env-dollar{font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:var(--text-muted);font-weight:600;}
        .envelope-input{width:72px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;padding:5px 8px;color:var(--text-primary);font-family:'JetBrains Mono',monospace;font-size:0.8rem;font-weight:700;outline:none;transition:border-color 0.2s;text-align:right;}
        .envelope-input:focus{border-color:var(--accent);}
        .envelope-input.over-budget{border-color:var(--red);color:var(--red);}
        .envelope-pct-badge{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--text-muted);font-weight:500;min-width:32px;text-align:right;}
        .envelope-unallocated{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:8px;margin-top:4px;font-size:0.8rem;font-weight:600;transition:all 0.3s;}
        .envelope-unallocated.balanced{background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);color:var(--green);}
        .envelope-unallocated.over{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);color:var(--red);}
        .envelope-unallocated.under{background:rgba(96,165,250,0.08);border:1px solid rgba(96,165,250,0.2);color:var(--blue);}
        .envelope-unallocated-val{font-family:'JetBrains Mono',monospace;font-weight:700;}
        .envelope-hint{font-size:0.65rem;color:var(--text-muted);text-align:center;margin-top:6px;font-style:italic;}
        .tabs-section{border-top:1px solid var(--border-light);padding-top:20px;margin-bottom:24px;}
        .tabs-title{text-align:center;font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:12px;font-weight:700;}
        .tabs-row{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;}
        .sys-tab{padding:8px 14px;border-radius:20px;font-size:0.72rem;font-weight:600;border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;transition:all 0.2s;white-space:nowrap;}
        .sys-tab:hover{border-color:var(--accent);color:var(--accent);}
        .sys-tab.active{background:var(--accent);color:#000;border-color:var(--accent);}
        .sys-tab-score{font-family:'JetBrains Mono',monospace;font-size:0.6rem;margin-left:4px;opacity:0.7;}

        .cross-sell{background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(245,158,11,0.02));border:1px solid rgba(245,158,11,0.2);border-radius:12px;padding:20px;text-align:center;margin-bottom:24px;}
        .cross-sell-eyebrow{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--accent);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:6px;font-weight:700;}
        .cross-sell-title{font-size:1rem;font-weight:700;margin-bottom:4px;}
        .cross-sell-text{font-size:0.8rem;color:var(--text-secondary);margin-bottom:14px;line-height:1.5;}
        .cross-sell-amount{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:800;color:var(--accent);margin-bottom:14px;}
        .cross-sell-btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#000;padding:12px 24px;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:0.8rem;font-weight:700;text-decoration:none;transition:all 0.3s;text-transform:uppercase;letter-spacing:0.04em;}
        .cross-sell-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px var(--accent-glow);}

        .card-section{border-top:1px solid var(--border-light);padding-top:20px;}
        .card-section-title{text-align:center;font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:6px;font-weight:700;}
        .card-section-explainer{text-align:center;font-size:0.75rem;color:var(--text-secondary);margin-bottom:16px;line-height:1.5;}
        .card-section-explainer strong{color:var(--accent);font-weight:700;}
        .id-card{width:100%;max-width:400px;margin:0 auto;aspect-ratio:1.586/1;border-radius:16px;overflow:hidden;position:relative;background:linear-gradient(135deg,#0c0e1a 0%,#1a1d32 50%,#0e1020 100%);border:1px solid rgba(245,158,11,0.2);padding:24px;display:flex;flex-direction:column;justify-content:space-between;}
        .id-card-holo{position:absolute;top:-50%;right:-30%;width:300px;height:300px;background:conic-gradient(from 0deg,transparent,rgba(245,158,11,0.06),transparent,rgba(96,165,250,0.05),transparent);border-radius:50%;animation:holoSpin 8s linear infinite;pointer-events:none;}
        @keyframes holoSpin{to{transform:rotate(360deg);}}
        .id-card-top{display:flex;justify-content:space-between;align-items:flex-start;position:relative;z-index:1;}
        .id-card-badge{font-family:'JetBrains Mono',monospace;font-size:0.5rem;color:var(--accent);text-transform:uppercase;letter-spacing:0.15em;font-weight:700;border:1px solid rgba(245,158,11,0.3);padding:4px 10px;border-radius:4px;}
        .id-card-brand{font-family:'JetBrains Mono',monospace;font-size:0.55rem;color:var(--text-muted);text-align:right;}
        .id-card-mid{position:relative;z-index:1;}
        .id-card-archetype{font-family:'JetBrains Mono',monospace;font-size:clamp(1rem,3.5vw,1.3rem);font-weight:800;color:var(--accent);letter-spacing:0.06em;text-transform:uppercase;margin-bottom:2px;}
        .id-card-system{font-size:0.75rem;color:var(--text-secondary);margin-bottom:8px;}
        .id-card-alloc{display:flex;gap:12px;}
        .id-card-alloc-item{text-align:center;}
        .id-card-alloc-val{font-family:'JetBrains Mono',monospace;font-size:0.85rem;font-weight:700;color:var(--text-primary);}
        .id-card-alloc-lbl{font-size:0.5rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;}
        .id-card-bottom{display:flex;justify-content:space-between;align-items:flex-end;position:relative;z-index:1;}
        .id-card-income-val{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:800;color:var(--text-primary);}
        .id-card-income-lbl{font-size:0.5rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;}
        .id-card-footer-brand{font-family:'JetBrains Mono',monospace;font-size:0.55rem;color:var(--accent);font-weight:700;}
        .card-actions{display:flex;justify-content:center;gap:10px;margin-top:16px;flex-wrap:wrap;}
        .card-download-btn, .card-share-btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#000;padding:10px 20px;border:none;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:0.75rem;font-weight:700;cursor:pointer;transition:all 0.3s;text-transform:uppercase;}
        .card-download-btn:hover, .card-share-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px var(--accent-glow);}
        .card-download-btn:disabled, .card-share-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
        .card-share-btn{background:transparent;color:var(--accent);border:1px solid rgba(245,158,11,0.3);}
        .card-share-btn:hover{background:var(--accent-dim);}
        .card-share-hint{text-align:center;font-size:0.7rem;color:var(--text-muted);margin-top:10px;}
        .card-share-hint strong{color:var(--accent);font-weight:600;}

        /* OPT-3: Doughnut pulse */
        @keyframes doughnutPulse{
            0%{box-shadow:0 0 0 0 rgba(245,158,11,0.2);}
            70%{box-shadow:0 0 0 12px rgba(245,158,11,0);}
            100%{box-shadow:0 0 0 0 rgba(245,158,11,0);}
        }
        .doughnut-container.pulse{animation:doughnutPulse 0.6s ease-out;}

        /* ========== FOOTER ========== */
        .footer{text-align:center;padding:24px 0 16px;margin-top:28px;border-top:1px solid var(--border-light);}
        .footer-privacy{font-size:0.7rem;color:var(--text-muted);margin-bottom:12px;line-height:1.5;}
        .footer-social{display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:14px;flex-wrap:wrap;}
        .footer-social-link{display:inline-flex;align-items:center;gap:6px;font-size:0.75rem;font-weight:600;color:var(--text-secondary);text-decoration:none;transition:color 0.2s;padding:6px 14px;border-radius:20px;border:1px solid var(--border-light);background:rgba(255,255,255,0.02);}
        .footer-social-link:hover{color:var(--accent);border-color:rgba(245,158,11,0.3);}
        .footer-social-link svg{width:14px;height:14px;flex-shrink:0;}
        @media(max-width:480px){
            .container{padding:16px 12px;}
            .intro{padding:32px 20px;}
            .quiz{padding:20px 16px 28px;}
            .dash-body{padding:16px;}
            .income-row{flex-direction:column;}
            .income-toggle{align-self:stretch;}
            .income-toggle button{flex:1;}
            .doughnut-container{width:200px;height:200px;}
            .id-card{padding:18px;}
            .id-card-archetype{font-size:0.95rem;}
            .card-actions{flex-direction:column;align-items:stretch;}
            .gate-beehiiv iframe{min-height:360px;height:56vh;max-height:520px;}
            .gate-wrapper{min-height:520px;}
            .upstream-theater{padding:40px 20px;}
            .trust-strip{flex-wrap:wrap;gap:8px;}
        }
    </style>
</head>
<body>
    <div class="bg-ambient"></div>

    <div class="container">
        <header class="header">
            <div class="header-brand"><a href="https://instagram.com/koutalksmoney" target="_blank">Built by Kou. Tested with real money.</a></div>
            <h1 class="header-title" id="headerTitle">Discover Your Financial DNA</h1>
            <p class="header-sub" id="headerSub">Answer 6 questions. We analyze your psychology, goals, and income to build a blueprint that tells you exactly where every dollar should go.</p>
        </header>

        <main class="main-card">

            <!-- OPT-1: 800-CLUB UPSTREAM LOADING THEATER -->
            <section id="s-upstream-theater" class="section upstream-theater">
                <div class="upstream-theater-badge">Phase 2 Initializing</div>
                <div class="upstream-spinner"><div class="upstream-spinner-ring"></div></div>
                <h2>Credit Protocol Complete. Loading Cash Flow Engine.</h2>
                <div class="upstream-theater-sub">Preparing your Phase 2 assessment...</div>
                <div class="upstream-steps" id="upstreamSteps">
                    <div class="upstream-step" id="us0"><div class="upstream-check"></div><span>Credit protocol verified from 800-Club</span></div>
                    <div class="upstream-step" id="us1"><div class="upstream-check"></div><span>Loading cash flow analysis engine</span></div>
                    <div class="upstream-step" id="us2"><div class="upstream-check"></div><span>Syncing your financial profile</span></div>
                    <div class="upstream-step" id="us3"><div class="upstream-check"></div><span>Preparing Phase 2 assessment</span></div>
                </div>
                <div class="upstream-progress"><div class="upstream-progress-bar" id="upstreamBar"></div></div>
            </section>

            <!-- INTRO -->
            <section id="s-intro" class="section intro active">
                <div class="intro-upstream-badge" id="introUpstreamBadge" style="display:none;"></div>
                <div class="intro-icon">
                    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg>
                </div>
                <h2 id="introTitle">Stop guessing where your money should go.</h2>
                <p id="introText">Answer 6 questions about your psychology, goals, and income pattern. We match you to 1 of 5 financial archetypes and build a blueprint that tells you exactly how much of every paycheck goes where for optimal growth.</p>
                <div class="intro-stats">
                    <div class="intro-stat"><div class="intro-stat-val">6</div><div class="intro-stat-label">Questions</div></div>
                    <div class="intro-stat"><div class="intro-stat-val">5</div><div class="intro-stat-label">Archetypes</div></div>
                    <div class="intro-stat"><div class="intro-stat-val">90s</div><div class="intro-stat-label">To Complete</div></div>
                </div>
                <button class="btn-primary" id="startBtn">Start Assessment</button>
            </section>

            <!-- QUIZ -->
            <section id="s-quiz" class="section quiz">
                <div class="quiz-progress"><div class="quiz-progress-bar" id="quizBar"></div></div>
                <div class="quiz-meta">
                    <div class="quiz-step" id="quizStep">Question 1 of 6</div>
                    <button class="quiz-back" id="quizBack" onclick="goBack()">&#8592; Back</button>
                </div>
                <div class="quiz-question" id="quizQ"></div>
                <div class="quiz-options" id="quizOpts"></div>
            </section>

            <!-- PROCESSING -->
            <section id="s-processing" class="section processing">
                <div class="proc-spinner"><div class="proc-spinner-ring"></div></div>
                <div class="proc-label" id="procLabel">Analyzing responses...</div>
                <div class="proc-steps-list" id="procSteps"></div>
            </section>

            <!-- REVEAL + GATE -->
            <section id="s-reveal" class="section reveal">
                <div class="reveal-header">
                    <div class="reveal-eyebrow" id="revealEyebrow">Based on 6 answers, you are</div>
                    <div class="reveal-archetype" id="revealArchetype"></div>
                    <div class="reveal-system" id="revealSystem"></div>
                    <div class="reveal-why-summary" id="revealWhy"></div>
                </div>
                <div class="gate-wrapper">
                    <div class="gate-overlay" id="gateOverlay">
                        <div class="gate-lock-icon">
                            <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                        </div>
                        <div class="gate-title" id="gateTitle">Your blueprint is ready.</div>
                        <div class="gate-text" id="gateText">Your archetype is matched. Your allocation is calculated. Enter your email to unlock everything:</div>
                        <div class="gate-value-stack" id="gateValueStack">
                            <div class="gate-value-item"><span class="gate-value-check">&#10003;</span> Personalized dollar-by-dollar allocation breakdown</div>
                            <div class="gate-value-item"><span class="gate-value-check">&#10003;</span> Interactive chart with your exact income splits</div>
                            <div class="gate-value-item"><span class="gate-value-check">&#10003;</span> Side-by-side comparison across all 5 archetypes</div>
                            <div class="gate-value-item"><span class="gate-value-check">&#10003;</span> Downloadable Financial DNA card</div>
                        </div>
                        <div class="gate-beehiiv">
                            <iframe id="beehiivFrame" src="https://subscribe-forms.beehiiv.com/e01f8d58-517b-4b46-afbf-78c51d559c90" scrolling="no"></iframe>
                        </div>
                    </div>
                    <div class="dash-preview" id="dashPreview">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                            <div style="background:var(--bg-card);border-radius:10px;height:120px;border:1px solid var(--border-light);"></div>
                            <div style="background:var(--bg-card);border-radius:10px;height:120px;border:1px solid var(--border-light);"></div>
                        </div>
                        <div style="background:var(--bg-card);border-radius:10px;height:80px;margin-top:16px;border:1px solid var(--border-light);"></div>
                        <div style="background:var(--bg-card);border-radius:10px;height:60px;margin-top:16px;border:1px solid var(--border-light);"></div>
                    </div>
                </div>
            </section>

            <!-- DASHBOARD -->
            <section id="s-dashboard" class="section dashboard">
                <div class="dash-banner" id="dashBanner">&#10003; Blueprint Unlocked. Your personalized system is ready.</div>
                <!-- OPT-6: Trust strip -->
                <div class="trust-strip">
                    <div class="trust-strip-item"><span class="trust-strip-icon">&#128274;</span> Data stays on your device</div>
                    <div class="trust-strip-item"><span class="trust-strip-icon">&#9889;</span> Calculated in real-time</div>
                </div>
                <div class="dash-header">
                    <div class="reveal-eyebrow">Your Financial Archetype</div>
                    <div class="dash-archetype" id="dashArchetype"></div>
                    <div class="dash-system-name" id="dashSystemName"></div>
                </div>
                <div class="dash-body">
                    <div class="income-section" id="incomeSection">
                        <div class="income-label">
                            <span>Enter Your Income</span>
                            <span class="income-imported" id="incomeImported" style="display:none;">Imported from Autopilot</span>
                            <!-- OPT-3: Personalized badge -->
                            <span class="income-personalized" id="incomePersonalized">&#10003; Personalized</span>
                        </div>
                        <!-- OPT-1: Income nudge micro-copy -->
                        <div class="income-nudge" id="incomeNudge">
                            Enter your paycheck to see <span class="nudge-highlight">exact dollar amounts</span> for every bucket in your system.
                        </div>
                        <div class="income-row">
                            <div class="income-field">
                                <span>$</span>
                                <input type="number" id="incomeInput" placeholder="e.g. 2400" inputmode="numeric">
                            </div>
                            <!-- FIX-1 (SILHOUETTE): Clean toggle. NO extra spans. NO .income-toggle-rec. -->
                            <div class="income-toggle">
                                <button id="btnMonthly" class="active" onclick="setPeriod('monthly')">Monthly</button>
                                <button id="btnAnnual" onclick="setPeriod('annual')">Annual</button>
                            </div>
                        </div>
                    </div>
                    <div class="dash-grid">
                        <div class="dash-col dash-col-text">
                            <h3>How it works</h3>
                            <div class="dash-desc" id="dashDesc"></div>
                            <div style="height:16px;"></div>
                            <h3>Why this matches you</h3>
                            <div class="dash-why" id="dashWhy"></div>
                            <div class="dash-why-dynamic" id="dashWhyDynamic"></div>
                        </div>
                        <!-- OPT-2: dash-col-chart class for mobile reorder -->
                        <div class="dash-col dash-col-chart">
                            <div class="doughnut-wrap">
                                <div>
                                    <div class="doughnut-container" id="doughnutContainer">
                                        <div class="doughnut-ring" id="doughnutRing"></div>
                                        <div class="doughnut-center">
                                            <div class="doughnut-center-value" id="doughnutValue">--</div>
                                            <div class="doughnut-center-label" id="doughnutLabel">Enter income</div>
                                            <div class="doughnut-center-brand">@koutalksmoney</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="doughnut-legend" id="doughnutLegend"></div>
                        </div>
                    </div>
                    <!-- OPT-4: Cross-sell ABOVE tabs -->
                    <div class="cross-sell" id="crossSell">
                        <div class="cross-sell-eyebrow">Next Step: Your Complete Toolkit</div>
                        <div class="cross-sell-title" id="crossSellTitle">You built the blueprint. Now access every tool in the system.</div>
                        <div class="cross-sell-text" id="crossSellText">Autopilot automation, credit protocol, investment calculator, and more. All in one control room.</div>
                        <div class="cross-sell-amount" id="crossSellAmount"></div>
                        <a href="https://spacekou5-oss.github.io/cashvault-funnel/command-center.html" class="cross-sell-btn" id="crossSellBtn">Open Command Center &#8594;</a>
                    </div>
                    <!-- Tabs below cross-sell -->
                    <div class="tabs-section">
                        <div class="tabs-title">Explore All Archetypes</div>
                        <div class="tabs-row" id="tabsRow"></div>
                    </div>
                    <div class="card-section">
                        <div class="card-section-title">Your Financial DNA Card</div>
                        <!-- OPT-7: Share CTA with DM keyword -->
                        <div class="card-section-explainer">Download your card. Post it. Tag <strong>@koutalksmoney</strong> and DM <strong>"CHEAT"</strong> to unlock the Prompt Vault.</div>
                        <div class="id-card" id="idCard">
                            <div class="id-card-holo"></div>
                            <div class="id-card-top">
                                <div class="id-card-badge">Financial DNA</div>
                                <div class="id-card-brand">@koutalksmoney</div>
                            </div>
                            <div class="id-card-mid">
                                <div class="id-card-archetype" id="cardArchetype"></div>
                                <div class="id-card-system" id="cardSystem"></div>
                                <div class="id-card-alloc" id="cardAlloc"></div>
                            </div>
                            <div class="id-card-bottom">
                                <div>
                                    <div class="id-card-income-val" id="cardIncome">--</div>
                                    <div class="id-card-income-lbl">Monthly Income</div>
                                </div>
                                <div class="id-card-footer-brand">KOU TALKS MONEY</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-download-btn" id="cardDownloadBtn" onclick="downloadCard()">
                                <span id="cardBtnText">&#11015; Download Card</span>
                            </button>
                            <!-- OPT-7: Native share button -->
                            <button class="card-share-btn" id="cardShareBtn" onclick="shareCard()" style="display:none;">
                                <span>&#8599; Share</span>
                            </button>
                        </div>
                        <div class="card-share-hint">Post your DNA card on Instagram or TikTok. Tag <strong>@koutalksmoney</strong>.</div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <div class="footer-privacy">Your data stays on your device. Nothing is sent to our servers.</div>
            <div class="footer-social">
                <a href="https://instagram.com/koutalksmoney" target="_blank" class="footer-social-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
                    @koutalksmoney
                </a>
                <a href="https://youtube.com/@FinanceWithKou" target="_blank" class="footer-social-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.54 6.42a2.78 2.78 0 00-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 00-1.94 2A29 29 0 001 11.75a29 29 0 00.46 5.33A2.78 2.78 0 003.4 19.1c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 001.94-2 29 29 0 00.46-5.25 29 29 0 00-.46-5.43z"/><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/></svg>
                    @FinanceWithKou
                </a>
            </div>
        </footer>
    </div>

    <script>
    // =========================================
    // 1. CONSTANTS & SYSTEM DATA
    // =========================================
    var COMMAND_CENTER_URL = 'https://spacekou5-oss.github.io/cashvault-funnel/command-center.html';
    var BRIDGE_URL = 'https://spacekou5-oss.github.io/cashvault-funnel/bridge-budget.html';

    var SYSTEMS = {
        '50-30-20': {
            archetype: 'THE BALANCED STRATEGIST', title: '50/30/20 Rule',
            desc: '50% Needs. 30% Wants. 20% Savings and Debt. Three buckets. No overthinking. The system that works because it removes every decision except one: which bucket does this go in?',
            advantage: 'You get guardrails without a straitjacket. Wants are not eliminated, they are contained. Savings are not optional, they are automatic. This is the system for people who want structure without suffocation.',
            segments: [{ label: 'Needs', pct: 50, color: '#f59e0b' },{ label: 'Wants', pct: 30, color: '#818cf8' },{ label: 'Savings & Debt', pct: 20, color: '#60a5fa' }],
            investPct: 20, investLabel: 'savings/debt allocation',
            ctaVerb: 'Automate Your 20%'
        },
        'wealth-builder': {
            archetype: 'THE COMPOUND COMMANDER', title: 'Wealth Builder',
            desc: '50% Needs. 30% Investing. 10% Wants. 10% Emergency. Four buckets engineered for one outcome: your money compounds faster than your lifestyle inflates.',
            advantage: 'Your future net worth is the priority. Wants get a hard ceiling. Investing gets more than most people spend on entertainment. This is the system for people who treat wealth like a construction project, not a side effect.',
            segments: [{ label: 'Needs', pct: 50, color: '#f59e0b' },{ label: 'Investing', pct: 30, color: '#10b981' },{ label: 'Wants', pct: 10, color: '#818cf8' },{ label: 'Emergency', pct: 10, color: '#60a5fa' }],
            investPct: 30, investLabel: 'investing allocation',
            ctaVerb: 'Automate Your 30%'
        },
        'pay-yourself-first': {
            archetype: 'THE AUTOMATION GHOST', title: 'Pay Yourself First (30/70)',
            desc: '30% auto-transferred to savings or investing the instant income lands. Before rent. Before food. Before anything. The remaining 70% is yours to manage however you want.',
            advantage: 'One auto-transfer at 30%. Aggressive, but invisible. Your future self takes nearly a third of every paycheck before your present self can touch it. This is for people who want wealth on autopilot, not people who want the easiest possible system.',
            segments: [{ label: 'Auto-Save/Invest', pct: 30, color: '#60a5fa' },{ label: 'Everything Else', pct: 70, color: '#818cf8' }],
            investPct: 30, investLabel: 'auto-save allocation',
            ctaVerb: 'Build the Autopilot'
        },
        '80-20': {
            archetype: 'THE MINIMALIST OPERATOR', title: '80/20 Anti-Budget',
            desc: 'Save 20%. Spend the other 80% on whatever you want. No categories. No tracking. No spreadsheets. No guilt. One rule. Maximum freedom.',
            advantage: 'Zero mental overhead. You hate budgeting, so this system hates it for you. The 20% savings is non-negotiable, but the other 80% has no rules. This is for people who want financial progress without becoming an accountant.',
            segments: [{ label: 'Savings & Debt', pct: 20, color: '#60a5fa' },{ label: 'Everything Else', pct: 80, color: '#818cf8' }],
            investPct: 20, investLabel: 'savings/debt allocation',
            ctaVerb: 'Automate Your 20%'
        },
        'envelope': {
            archetype: 'THE CASH WARLORD', title: 'Envelope System',
            desc: 'Hard spending limits per category. When the envelope is empty, spending stops. No exceptions. No negotiations. No "I will make up for it next month." Every dollar gets a job before you spend it.',
            advantage: 'The nuclear option for people who know they overspend. Forces real-time awareness: you watch the balance drop with every swipe. This is for people who need the financial equivalent of a physical fence, not a suggestion.',
            segments: [{ label: 'Fixed Expenses', pct: 50, color: '#64748b', editable: true },{ label: 'Groceries', pct: 15, color: '#f472b6', editable: true },{ label: 'Savings & Debt', pct: 15, color: '#60a5fa', editable: false },{ label: 'Fun & Shopping', pct: 10, color: '#a78bfa', editable: false },{ label: 'Buffer', pct: 10, color: '#34d399', editable: false }],
            investPct: 15, investLabel: 'savings component',
            ctaVerb: 'Lock In Your Envelopes'
        }
    };

    var QUESTIONS = [
        { text: 'What is your #1 money goal for the next 12 months?', options: [
            { label: 'Get control of overspending', score: { 'envelope': 5, '50-30-20': 2 }, reason: 'controlling overspending is your top priority' },
            { label: 'Build an emergency savings buffer', score: { 'pay-yourself-first': 5, '50-30-20': 1 }, reason: 'building emergency savings is your focus' },
            { label: 'Aggressively invest and grow wealth', score: { 'wealth-builder': 5, 'pay-yourself-first': 2 }, reason: 'aggressive wealth growth is your #1 goal' },
            { label: 'Pay off debt faster', score: { 'envelope': 4, '50-30-20': 3 }, reason: 'eliminating debt is your primary objective' },
            { label: 'Keep things simple and stress-free', score: { '80-20': 5 }, reason: 'simplicity and low stress matter most to you' }
        ]},
        { text: 'How predictable is your income each month?', options: [
            { label: 'Very stable (same amount every month)', score: { 'wealth-builder': 3, '50-30-20': 2, 'pay-yourself-first': 2 }, reason: 'your stable income supports structured allocation' },
            { label: 'Somewhat stable (small swings)', score: { '50-30-20': 3, 'pay-yourself-first': 1 }, reason: 'your semi-stable income needs moderate flexibility' },
            { label: 'Very irregular (hours, tips, commissions)', score: { '80-20': 4, 'pay-yourself-first': 2 }, reason: 'your irregular income demands a flexible system' }
        ]},
        { text: 'Do you currently spend close to 100% of what you earn?', options: [
            { label: 'Yes, almost always', score: { 'envelope': 4 }, reason: 'you are spending nearly everything you earn' },
            { label: 'Sometimes, depends on the month', score: { '50-30-20': 3, '80-20': 1 }, reason: 'your spending occasionally hits your ceiling' },
            { label: 'No, I usually have money left over', score: { 'wealth-builder': 3, 'pay-yourself-first': 3, '80-20': 1 }, reason: 'you already have margin in your budget' }
        ]},
        { text: 'How aggressively do you want to save and invest right now?', options: [
            { label: 'Light: just want to start the habit', score: { '80-20': 5 }, reason: 'you want to start the savings habit without pressure' },
            { label: 'Moderate: consistent but comfortable', score: { '50-30-20': 4, 'pay-yourself-first': 3 }, reason: 'you want consistent, comfortable savings' },
            { label: 'Aggressive: I will cut wants to build wealth faster', score: { 'wealth-builder': 5, 'pay-yourself-first': 3 }, reason: 'you are willing to sacrifice wants for faster wealth' }
        ]},
        { text: 'Do you have high-interest debt (credit cards, personal loans)?', options: [
            { label: 'Yes, a significant amount', score: { 'envelope': 5, '50-30-20': 1 }, reason: 'high-interest debt needs aggressive containment' },
            { label: 'Some, but manageable', score: { '50-30-20': 3 }, reason: 'your manageable debt allows balanced allocation' },
            { label: 'Very little or none', score: { 'wealth-builder': 3, 'pay-yourself-first': 3 }, reason: 'minimal debt frees your cash for investing' }
        ]},
        { text: 'Be honest: how likely are you to overspend if there are no hard limits?', options: [
            { label: 'Very likely. I swipe first, think later.', score: { 'envelope': 5 }, reason: 'you need hard spending limits to stay on track' },
            { label: 'Sometimes, depends on the category', score: { '50-30-20': 3 }, reason: 'occasional overspending benefits from guardrails' },
            { label: 'Not very likely. I am naturally cautious.', score: { 'pay-yourself-first': 3, '80-20': 2, 'wealth-builder': 2 }, reason: 'your natural spending discipline allows more freedom' }
        ]}
    ];

    var PROC_STEPS = [
        'Scoring 6 responses across 5 financial archetypes...',
        'Evaluating spending psychology profile...',
        'Matching income pattern to system requirements...',
        'Calculating optimal allocation ratios...',
        'Generating Financial DNA report...'
    ];

    // =========================================
    // 3. STATE
    // =========================================
    var state = {
        currentSection: 'intro',
        questionIndex: 0,
        scores: { '50-30-20': 0, 'wealth-builder': 0, 'pay-yourself-first': 0, '80-20': 0, 'envelope': 0 },
        answerHistory: [],
        selectedSystem: '50-30-20',
        income: 0,
        incomePeriod: 'monthly',
        isUnlocked: false,
        envelopeOverrides: null
    };

    var incomeHasBeenEntered = false;
    var $ = function(id) { return document.getElementById(id); };
    function fmt(n) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n || 0); }
    function getMonthly() { return state.incomePeriod === 'annual' ? state.income / 12 : state.income; }

    function isFrom800Club() { try { return localStorage.getItem('eightclub_email') === 'true'; } catch(e) { return false; } }
    function isReturningUser() { try { return localStorage.getItem('budget_unlocked') === 'true'; } catch(e) { return false; } }

    // =========================================
    // UPSTREAM LOADING THEATER
    // =========================================
    function runUpstreamTheater(callback) {
        showSection('s-upstream-theater');
        var steps = document.querySelectorAll('.upstream-step');
        var bar = $('upstreamBar');
        var i = 0; var total = steps.length;
        var interval = setInterval(function() {
            if (i > 0) { steps[i-1].classList.remove('active'); steps[i-1].classList.add('done'); steps[i-1].querySelector('.upstream-check').innerHTML = '&#10003;'; }
            if (i < total) { steps[i].classList.add('active'); bar.style.width = ((i + 1) / total * 100) + '%'; i++; }
            else { clearInterval(interval); setTimeout(function() { if (callback) callback(); }, 500); }
        }, 600);
    }

    function personalizeForUpstream() {
        if (!isFrom800Club()) return;
        var badge = $('introUpstreamBadge'); var title = $('introTitle'); var text = $('introText'); var btn = $('startBtn');
        if (badge) { badge.style.display = 'inline-block'; badge.textContent = 'Phase 2 of 2 \u2022 Credit Done. Cash Flow Next.'; }
        if (title) title.textContent = 'Your Credit is Handled. Now Engineer Your Cash Flow.';
        if (text) text.textContent = 'You completed the 800-Club Protocol. Phase 1 is locked in. Now answer 6 questions to discover which budget archetype matches your psychology, then build the allocation blueprint.';
        if (btn) btn.textContent = 'Start Phase 2 \u2192';
        var gateTitle = $('gateTitle'); var gateText = $('gateText'); var revealEyebrow = $('revealEyebrow');
        if (gateTitle) gateTitle.textContent = 'Phase 2 complete. Your blueprint is ready.';
        if (gateText) gateText.textContent = 'Credit protocol complete. Archetype matched. Enter your email to unlock your full cash flow breakdown:';
        if (revealEyebrow) revealEyebrow.textContent = 'Phase 2 Complete \u2022 Based on 6 answers, you are';
    }

    // =========================================
    // BEEHIIV GATE REDIRECT
    // =========================================
    var _gateRedirected = false;
    function doGateRedirect() {
        if (_gateRedirected) return; _gateRedirected = true;
        try { localStorage.setItem('budget_unlocked', 'true'); localStorage.setItem('budget_completed', 'true'); localStorage.setItem('budgetCalc_gate_email', 'true'); } catch(e) {}
        window.location.href = BRIDGE_URL;
    }
    function activateGateRedirect() {
        window.addEventListener('message', function(event) {
            if (event.origin && event.origin.includes('beehiiv.com')) {
                var data = event.data;
                if (typeof data === 'string') { if (data.includes('subscribed') || data.includes('success') || data.includes('confirmed')) { doGateRedirect(); } }
                if (typeof data === 'object' && data !== null) { if (data.type === 'beehiiv:subscribe:success' || data.event === 'subscribed' || data.subscribed === true || data.type === 'subscribe_success') { doGateRedirect(); } }
            }
        });
        var iframe = $('beehiivFrame');
        if (iframe) {
            var initialHeight = iframe.style.height || ''; var observerActivatedAt = Date.now();
            var observer = new MutationObserver(function(mutations) {
                if (Date.now() - observerActivatedAt < 3000) return;
                mutations.forEach(function(mutation) { if (mutation.type === 'attributes') { var newHeight = iframe.style.height || ''; if (newHeight !== initialHeight && initialHeight) { setTimeout(doGateRedirect, 1500); } } });
            });
            observer.observe(iframe, { attributes: true, attributeFilter: ['style', 'height'] });
        }
    }

    // =========================================
    // SECTION MANAGEMENT
    // =========================================
    function showSection(id) {
        state.currentSection = id;
        document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
        $(id).classList.add('active');
        var sub = $('headerSub');
        if (id === 's-dashboard') { sub.textContent = 'Your personalized financial blueprint.'; }
        else if (id === 's-upstream-theater') { sub.textContent = 'Syncing your financial profile...'; }
        else { sub.textContent = 'Answer 6 questions. We analyze your psychology, goals, and income to build a blueprint that tells you exactly where every dollar should go.'; }
    }

    // =========================================
    // QUIZ ENGINE
    // =========================================
    function renderQuestion() {
        var q = QUESTIONS[state.questionIndex]; var total = QUESTIONS.length;
        $('quizBar').style.width = (state.questionIndex / total * 100) + '%';
        $('quizStep').textContent = 'Question ' + (state.questionIndex + 1) + ' of ' + total;
        $('quizQ').textContent = q.text;
        var backBtn = $('quizBack');
        if (state.questionIndex > 0) backBtn.classList.add('visible'); else backBtn.classList.remove('visible');
        var container = $('quizOpts'); container.innerHTML = '';
        q.options.forEach(function(opt, oi) {
            var btn = document.createElement('div'); btn.className = 'quiz-opt';
            btn.innerHTML = '<span class="quiz-opt-text">' + opt.label + '</span><span class="quiz-opt-arrow">&#8594;</span>';
            btn.onclick = function() { selectAnswer(state.questionIndex, oi); };
            container.appendChild(btn);
        });
    }
    function selectAnswer(qi, oi) {
        var opt = QUESTIONS[qi].options[oi];
        state.answerHistory.push({ qi: qi, oi: oi, scoreMap: Object.assign({}, opt.score) });
        Object.keys(opt.score).forEach(function(sys) { state.scores[sys] += opt.score[sys]; });
        if (state.questionIndex < QUESTIONS.length - 1) { state.questionIndex++; renderQuestion(); }
        else { finishQuiz(); }
    }
    function goBack() {
        if (state.answerHistory.length === 0) return;
        var last = state.answerHistory.pop();
        Object.keys(last.scoreMap).forEach(function(sys) { state.scores[sys] -= last.scoreMap[sys]; });
        state.questionIndex--; renderQuestion();
    }

    // =========================================
    // QUIZ COMPLETION
    // =========================================
    function finishQuiz() {
        var winner = '50-30-20'; var maxScore = -1;
        Object.keys(state.scores).forEach(function(sys) { if (state.scores[sys] > maxScore) { maxScore = state.scores[sys]; winner = sys; } });
        state.selectedSystem = winner;
        localStorage.setItem('budget_quiz_completed', 'true');
        localStorage.setItem('budget_selected_system', winner);
        localStorage.setItem('budget_scores', JSON.stringify(state.scores));
        localStorage.setItem('budget_answers', JSON.stringify(state.answerHistory));
        showSection('s-processing'); runProcessingTheater();
    }

    // =========================================
    // PROCESSING THEATER (OPT-8: Faster intervals)
    // =========================================
    function runProcessingTheater() {
        var container = $('procSteps'); container.innerHTML = '';
        PROC_STEPS.forEach(function(text) {
            var el = document.createElement('div'); el.className = 'proc-step-item';
            el.innerHTML = '<div class="proc-check"></div><span>' + text + '</span>'; container.appendChild(el);
        });
        var items = container.querySelectorAll('.proc-step-item'); var i = 0;
        var interval = setInterval(function() {
            if (i > 0) { items[i-1].classList.remove('active'); items[i-1].classList.add('done'); items[i-1].querySelector('.proc-check').innerHTML = '&#10003;'; }
            if (i < items.length) { items[i].classList.add('active'); $('procLabel').textContent = PROC_STEPS[i]; i++; }
            else { clearInterval(interval); setTimeout(showReveal, 400); }
        }, 550);
    }

    // =========================================
    // REVEAL + GATE
    // =========================================
    function showReveal() {
        if (isReturningUser() || isFrom800Club()) {
            if (isFrom800Club() && !isReturningUser()) { try { localStorage.setItem('budget_unlocked', 'true'); } catch(e) {} }
            state.isUnlocked = true; renderDashboard(); showSection('s-dashboard');
            var banner = $('dashBanner'); if (banner) { banner.classList.add('visible'); } return;
        }
        var sys = SYSTEMS[state.selectedSystem];
        $('revealArchetype').textContent = sys.archetype; $('revealSystem').textContent = sys.title;
        var contributions = state.answerHistory.map(function(a) { var opt = QUESTIONS[a.qi].options[a.oi]; return { reason: opt.reason, pts: opt.score[state.selectedSystem] || 0 }; })
            .filter(function(c) { return c.pts > 0; }).sort(function(a, b) { return b.pts - a.pts; }).slice(0, 3);
        if (contributions.length > 0) {
            var reasons = contributions.map(function(c, i) { return '<strong>(' + (i + 1) + ')</strong> ' + c.reason; });
            $('revealWhy').innerHTML = 'You told us: ' + reasons.join('. ') + '. This archetype is built for that exact profile.';
        }
        showSection('s-reveal'); activateGateRedirect();
    }

    // =========================================
    // OPT-3: INCOME UI FEEDBACK SYSTEM
    // =========================================
    function updateIncomeUI() {
        var monthly = getMonthly();
        var section = $('incomeSection'); var nudge = $('incomeNudge'); var badge = $('incomePersonalized');
        if (monthly > 0) { section.classList.add('has-income'); nudge.style.display = 'none'; badge.classList.add('show'); }
        else { section.classList.remove('has-income'); nudge.style.display = 'block'; badge.classList.remove('show'); }
    }
    function triggerDoughnutPulse() {
        var container = $('doughnutContainer'); container.classList.remove('pulse');
        void container.offsetWidth; container.classList.add('pulse');
        var centerVal = $('doughnutValue'); centerVal.classList.add('active');
        setTimeout(function() { centerVal.classList.remove('active'); }, 600);
    }

    // =========================================
    // DASHBOARD RENDERER
    // =========================================
    function renderDashboard() {
        var sys = SYSTEMS[state.selectedSystem];
        $('dashArchetype').textContent = sys.archetype;
        $('dashSystemName').textContent = sys.title;
        $('dashDesc').textContent = sys.desc;
        $('dashWhy').textContent = sys.advantage;
        renderDynamicWhy(); renderTabs(); updateChartAndLegend(); updateCrossSell(); updateIdCard(); updateIncomeUI();
    }

    function renderDynamicWhy() {
        var el = $('dashWhyDynamic'); var answers = state.answerHistory;
        if (!answers || answers.length === 0) { try { var saved = JSON.parse(localStorage.getItem('budget_answers') || '[]'); if (saved.length > 0) answers = saved; } catch(e) {} }
        if (!answers || answers.length === 0) { el.style.display = 'none'; return; }
        el.style.display = 'block';
        var contributions = answers.map(function(a) { var opt = QUESTIONS[a.qi] ? QUESTIONS[a.qi].options[a.oi] : null; if (!opt) return null; return { reason: opt.reason, pts: opt.score[state.selectedSystem] || 0 }; })
            .filter(function(c) { return c && c.pts > 0; }).sort(function(a, b) { return b.pts - a.pts; }).slice(0, 3);
        if (contributions.length === 0) { el.style.display = 'none'; return; }
        var lines = contributions.map(function(c, i) { return '<strong>(' + (i + 1) + ')</strong> ' + c.reason; });
        el.innerHTML = 'Based on your answers: ' + lines.join('. ') + '.';
    }

    function renderTabs() {
        var row = $('tabsRow'); row.innerHTML = '';
        var savedScores = state.scores;
        if (!savedScores || Object.values(savedScores).every(function(v){return v === 0;})) { try { savedScores = JSON.parse(localStorage.getItem('budget_scores') || '{}'); } catch(e) {} }
        Object.keys(SYSTEMS).forEach(function(key) {
            var sys = SYSTEMS[key]; var btn = document.createElement('button');
            btn.className = 'sys-tab' + (key === state.selectedSystem ? ' active' : '');
            var scoreText = savedScores[key] ? '<span class="sys-tab-score">(' + savedScores[key] + ')</span>' : '';
            btn.innerHTML = sys.archetype.replace('THE ', '') + scoreText;
            btn.onclick = function() { state.selectedSystem = key; state.envelopeOverrides = null; localStorage.removeItem('budget_envelope_overrides'); localStorage.setItem('budget_selected_system', key); renderDashboard(); };
            row.appendChild(btn);
        });
    }

    // =========================================
    // DOUGHNUT CHART + LEGEND
    // =========================================
    function initEnvelopeDefaults() {
        var sys = SYSTEMS['envelope']; var monthly = getMonthly();
        if (monthly <= 0) { state.envelopeOverrides = null; return; }
        if (!state.envelopeOverrides) { state.envelopeOverrides = {}; sys.segments.forEach(function(seg, i) { if (seg.editable) { state.envelopeOverrides[i] = Math.round(monthly * seg.pct / 100); } }); }
    }
    function getEnvelopeTotal() {
        var sys = SYSTEMS['envelope']; var monthly = getMonthly(); if (monthly <= 0) return 0; var total = 0;
        sys.segments.forEach(function(seg, i) { if (seg.editable && state.envelopeOverrides) { total += (state.envelopeOverrides[i] || 0); } else { total += Math.round(monthly * seg.pct / 100); } }); return total;
    }
    function onEnvelopeInput(index, value) {
        var parsed = parseFloat(value); state.envelopeOverrides[index] = isNaN(parsed) ? 0 : Math.round(parsed);
        localStorage.setItem('budget_envelope_overrides', JSON.stringify(state.envelopeOverrides));
        updateEnvelopeDoughnut(); updateEnvelopeUnallocated(); updateEnvelopePctBadges(); updateCrossSell(); updateIdCard();
    }
    function updateEnvelopeDoughnut() {
        var sys = SYSTEMS['envelope']; var ring = $('doughnutRing'); var centerVal = $('doughnutValue'); var centerLbl = $('doughnutLabel');
        var monthly = getMonthly(); var total = getEnvelopeTotal(); var stops = []; var cum = 0;
        sys.segments.forEach(function(seg, i) { var amt; if (seg.editable && state.envelopeOverrides) { amt = state.envelopeOverrides[i] || 0; } else { amt = Math.round(monthly * seg.pct / 100); } var pct = monthly > 0 ? (amt / monthly) * 100 : seg.pct; stops.push(seg.color + ' ' + cum + '% ' + (cum + pct) + '%'); cum += pct; });
        if (cum < 100) { stops.push('rgba(100,116,139,0.2) ' + cum + '% 100%'); }
        ring.style.background = 'conic-gradient(' + stops.join(', ') + ')';
        centerVal.textContent = fmt(total); centerLbl.textContent = Math.abs(total - monthly) < 1 ? 'Fully Allocated' : 'Allocated';
    }
    function updateEnvelopeUnallocated() {
        var el = document.getElementById('envelopeUnallocated'); if (!el) return;
        var monthly = getMonthly(); var total = getEnvelopeTotal(); var diff = monthly - total;
        el.className = 'envelope-unallocated';
        if (Math.abs(diff) < 1) { el.classList.add('balanced'); el.innerHTML = '<span>Fully Allocated</span><span class="envelope-unallocated-val">$0 remaining</span>'; }
        else if (diff > 0) { el.classList.add('under'); el.innerHTML = '<span>Unallocated</span><span class="envelope-unallocated-val">' + fmt(diff) + ' remaining</span>'; }
        else { el.classList.add('over'); el.innerHTML = '<span>Over Budget</span><span class="envelope-unallocated-val">' + fmt(Math.abs(diff)) + ' over</span>'; }
    }
    function updateEnvelopePctBadges() {
        var monthly = getMonthly(); if (monthly <= 0) return; var sys = SYSTEMS['envelope'];
        sys.segments.forEach(function(seg, i) { if (!seg.editable) return; var badge = document.getElementById('envPct_' + i); var input = document.getElementById('envInput_' + i);
            if (!badge || !input) return; var amt = state.envelopeOverrides[i] || 0; var pct = Math.round((amt / monthly) * 100); badge.textContent = pct + '%';
            var defaultAmt = Math.round(monthly * seg.pct / 100); if (amt > defaultAmt * 1.5) { input.classList.add('over-budget'); } else { input.classList.remove('over-budget'); } });
    }

    function updateChartAndLegend() {
        var sys = SYSTEMS[state.selectedSystem]; var monthly = getMonthly();
        var ring = $('doughnutRing'); var centerVal = $('doughnutValue'); var centerLbl = $('doughnutLabel'); var legend = $('doughnutLegend');
        var isEnvelope = state.selectedSystem === 'envelope';
        if (isEnvelope && monthly > 0) {
            initEnvelopeDefaults(); updateEnvelopeDoughnut(); legend.innerHTML = '';
            sys.segments.forEach(function(seg, i) {
                var el = document.createElement('div');
                if (seg.editable) {
                    var amt = state.envelopeOverrides[i] || 0; var pct = Math.round((amt / monthly) * 100);
                    el.className = 'doughnut-legend-item editable';
                    el.innerHTML = '<div class="doughnut-legend-left"><div class="doughnut-legend-dot" style="background:' + seg.color + ';"></div><span class="doughnut-legend-label">' + seg.label + '</span></div><div class="envelope-input-wrap"><span class="env-dollar">$</span><input type="number" class="envelope-input" id="envInput_' + i + '" value="' + amt + '" inputmode="numeric"><span class="envelope-pct-badge" id="envPct_' + i + '">' + pct + '%</span></div>';
                    legend.appendChild(el);
                    (function(idx) { setTimeout(function() { var inp = document.getElementById('envInput_' + idx); if (inp) { inp.addEventListener('input', function(e) { onEnvelopeInput(idx, e.target.value); }); } }, 0); })(i);
                } else {
                    var lockedAmt = Math.round(monthly * seg.pct / 100); el.className = 'doughnut-legend-item';
                    el.innerHTML = '<div class="doughnut-legend-left"><div class="doughnut-legend-dot" style="background:' + seg.color + ';"></div><span class="doughnut-legend-label">' + seg.label + '</span></div><span class="doughnut-legend-value">' + fmt(lockedAmt) + ' <span class="doughnut-legend-pct">(' + seg.pct + '% locked)</span></span>';
                    legend.appendChild(el);
                }
            });
            var unalloc = document.createElement('div'); unalloc.id = 'envelopeUnallocated'; legend.appendChild(unalloc); updateEnvelopeUnallocated();
            var hint = document.createElement('div'); hint.className = 'envelope-hint'; hint.textContent = 'Edit Fixed Expenses and Groceries. Other categories are locked percentages.'; legend.appendChild(hint);
            return;
        }
        if (!isEnvelope) { state.envelopeOverrides = null; }
        var stops = []; var cum = 0;
        sys.segments.forEach(function(seg) { stops.push(seg.color + ' ' + cum + '% ' + (cum + seg.pct) + '%'); cum += seg.pct; });
        ring.style.background = 'conic-gradient(' + stops.join(', ') + ')';
        if (monthly > 0) { centerVal.textContent = fmt(monthly); centerLbl.textContent = 'Monthly'; }
        else { centerVal.textContent = sys.segments.map(function(s){return s.pct + '%';}).join('/'); centerLbl.textContent = sys.title; }
        legend.innerHTML = '';
        sys.segments.forEach(function(seg) {
            var el = document.createElement('div'); el.className = 'doughnut-legend-item'; var valueHtml;
            if (monthly > 0) { valueHtml = '<span class="doughnut-legend-value">' + fmt(monthly * seg.pct / 100) + ' <span class="doughnut-legend-pct">(' + seg.pct + '%)</span></span>'; }
            else { valueHtml = '<span class="doughnut-legend-value">' + seg.pct + '%</span>'; }
            el.innerHTML = '<div class="doughnut-legend-left"><div class="doughnut-legend-dot" style="background:' + seg.color + ';"></div><span class="doughnut-legend-label">' + seg.label + '</span></div>' + valueHtml;
            legend.appendChild(el);
        });
    }

    // =========================================
    // OPT-5: CROSS-SELL WITH ARCHETYPE-SPECIFIC CTA
    // =========================================
    function updateCrossSell() {
        var sys = SYSTEMS[state.selectedSystem]; var monthly = getMonthly(); var investAmt = Math.round(monthly * sys.investPct / 100);
        if (monthly > 0) {
            $('crossSellTitle').textContent = 'Your ' + sys.archetype + ' system allocates ' + sys.investPct + '% to ' + sys.investLabel + '. That is ' + fmt(investAmt) + '/mo.';
            $('crossSellAmount').textContent = fmt(investAmt) + '/mo ready to compound.'; $('crossSellAmount').style.display = 'block';
            $('crossSellBtn').innerHTML = sys.ctaVerb + ' (' + fmt(investAmt) + '/mo) &#8594;';
            $('crossSellBtn').href = COMMAND_CENTER_URL + '?source=budget&monthly=' + investAmt;
        } else {
            $('crossSellTitle').textContent = 'You built the blueprint. Now access every tool in the system.';
            $('crossSellAmount').style.display = 'none';
            $('crossSellBtn').innerHTML = 'Open Command Center &#8594;';
            $('crossSellBtn').href = COMMAND_CENTER_URL + '?source=budget';
        }
        $('crossSellText').textContent = 'Autopilot automation, credit protocol, investment calculator, and more. All in one control room.';
    }

    // =========================================
    // IDENTITY CARD
    // =========================================
    function updateIdCard() {
        var sys = SYSTEMS[state.selectedSystem]; var monthly = getMonthly();
        var isEnvelope = state.selectedSystem === 'envelope' && monthly > 0;
        $('cardArchetype').textContent = sys.archetype;
        if (isEnvelope && state.envelopeOverrides) {
            var pcts = sys.segments.map(function(seg, i) { if (seg.editable && state.envelopeOverrides[i] !== undefined) { return Math.round((state.envelopeOverrides[i] / monthly) * 100) + '%'; } return seg.pct + '%'; });
            $('cardSystem').textContent = sys.title + ' | ' + pcts.join('/');
        } else { $('cardSystem').textContent = sys.title + ' | ' + sys.segments.map(function(s){return s.pct + '%';}).join('/'); }
        var alloc = $('cardAlloc'); alloc.innerHTML = '';
        sys.segments.forEach(function(seg, i) {
            var val; if (isEnvelope && seg.editable && state.envelopeOverrides && state.envelopeOverrides[i] !== undefined) { val = fmt(state.envelopeOverrides[i]); } else { val = monthly > 0 ? fmt(monthly * seg.pct / 100) : seg.pct + '%'; }
            var el = document.createElement('div'); el.className = 'id-card-alloc-item';
            el.innerHTML = '<div class="id-card-alloc-val">' + val + '</div><div class="id-card-alloc-lbl">' + seg.label + '</div>'; alloc.appendChild(el);
        });
        $('cardIncome').textContent = monthly > 0 ? fmt(monthly) : '--';
    }

    function downloadCard() {
        var btn = $('cardDownloadBtn'); var btnText = $('cardBtnText'); btn.disabled = true; btnText.innerHTML = 'Generating...';
        if (window.html2canvas) { captureCard(); } else {
            var script = document.createElement('script'); script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.onload = captureCard; script.onerror = function() { btnText.innerHTML = 'Download Failed'; setTimeout(function(){ btn.disabled = false; btnText.innerHTML = '&#11015; Download Card'; }, 2000); };
            document.head.appendChild(script);
        }
    }
    function captureCard() {
        html2canvas($('idCard'), { scale: 3, backgroundColor: '#0c0e1a', useCORS: true, logging: false }).then(function(canvas) {
            var link = document.createElement('a'); link.download = 'financial-dna-' + SYSTEMS[state.selectedSystem].archetype.replace(/\s+/g, '-').toLowerCase() + '.png';
            link.href = canvas.toDataURL('image/png'); link.click(); $('cardBtnText').innerHTML = '&#10003; Downloaded!';
            setTimeout(function(){ $('cardDownloadBtn').disabled = false; $('cardBtnText').innerHTML = '&#11015; Download Card'; }, 2000);
        }).catch(function() { $('cardBtnText').innerHTML = 'Download Failed'; setTimeout(function(){ $('cardDownloadBtn').disabled = false; $('cardBtnText').innerHTML = '&#11015; Download Card'; }, 2000); });
    }

    // =========================================
    // OPT-7: NATIVE SHARE
    // =========================================
    function shareCard() {
        var sys = SYSTEMS[state.selectedSystem]; var monthly = getMonthly();
        var shareText = 'My Financial DNA: ' + sys.archetype + ' (' + sys.title + ')';
        if (monthly > 0) shareText += '. ' + fmt(monthly) + '/mo allocated.';
        shareText += ' Find yours at koutalksmoney. DM "CHEAT" for the Prompt Vault.';
        if (navigator.share) {
            if (window.html2canvas) {
                html2canvas($('idCard'), { scale: 2, backgroundColor: '#0c0e1a', useCORS: true, logging: false }).then(function(canvas) {
                    canvas.toBlob(function(blob) {
                        var file = new File([blob], 'financial-dna.png', { type: 'image/png' });
                        navigator.share({ text: shareText, files: [file] }).catch(function() { navigator.share({ text: shareText }).catch(function(){}); });
                    });
                }).catch(function() { navigator.share({ text: shareText }).catch(function(){}); });
            } else { navigator.share({ text: shareText }).catch(function(){}); }
        }
    }
    if (navigator.share) { var shareBtn = $('cardShareBtn'); if (shareBtn) shareBtn.style.display = 'inline-flex'; }

    // =========================================
    // INCOME INPUT HANDLERS
    // =========================================
    $('incomeInput').addEventListener('input', function(e) {
        var val = parseFloat(e.target.value); state.income = isNaN(val) ? 0 : val;
        localStorage.setItem('budget_income', state.income.toString()); state.envelopeOverrides = null;
        localStorage.removeItem('budget_envelope_overrides'); updateChartAndLegend(); updateCrossSell(); updateIdCard(); updateIncomeUI();
        if (state.income > 0) { triggerDoughnutPulse(); incomeHasBeenEntered = true; }
    });
    function setPeriod(p) {
        state.incomePeriod = p; localStorage.setItem('budget_income_period', p);
        $('btnMonthly').classList.toggle('active', p === 'monthly'); $('btnAnnual').classList.toggle('active', p === 'annual');
        state.envelopeOverrides = null; localStorage.removeItem('budget_envelope_overrides'); updateChartAndLegend(); updateCrossSell(); updateIdCard(); updateIncomeUI();
    }

    // =========================================
    // START BUTTON
    // =========================================
    $('startBtn').addEventListener('click', function() {
        state.questionIndex = 0;
        state.scores = { '50-30-20': 0, 'wealth-builder': 0, 'pay-yourself-first': 0, '80-20': 0, 'envelope': 0 };
        state.answerHistory = []; showSection('s-quiz'); renderQuestion();
    });

    // =========================================
    // INITIALIZATION
    // =========================================
    (function init() {
        var quizDone = localStorage.getItem('budget_quiz_completed') === 'true';
        var isUnlocked = localStorage.getItem('budget_unlocked') === 'true';
        var savedSystem = localStorage.getItem('budget_selected_system');
        var savedIncome = localStorage.getItem('budget_income');
        var savedPeriod = localStorage.getItem('budget_income_period');
        var savedScores = null; var savedAnswers = null;
        try { savedScores = JSON.parse(localStorage.getItem('budget_scores')); } catch(e) {}
        try { savedAnswers = JSON.parse(localStorage.getItem('budget_answers')); } catch(e) {}
        var savedEnvelopeOverrides = null;
        try { savedEnvelopeOverrides = JSON.parse(localStorage.getItem('budget_envelope_overrides')); } catch(e) {}

        var autopilotImported = false;
        if (!savedIncome || savedIncome === '0') {
            try { var apData = JSON.parse(localStorage.getItem('autopilot_system_data') || 'null');
                if (apData && apData.income && apData.income > 0) { savedIncome = apData.income.toString(); localStorage.setItem('budget_income', savedIncome); autopilotImported = true; }
            } catch(e) {}
        }

        var params = new URLSearchParams(window.location.search);
        if (params.get('sys') && SYSTEMS[params.get('sys')]) { savedSystem = params.get('sys'); localStorage.setItem('budget_selected_system', savedSystem); }
        if (params.get('inc')) { savedIncome = params.get('inc'); localStorage.setItem('budget_income', savedIncome); }
        if (params.get('per')) { savedPeriod = params.get('per'); localStorage.setItem('budget_income_period', savedPeriod); }

        if (savedSystem && SYSTEMS[savedSystem]) state.selectedSystem = savedSystem;
        if (savedIncome) state.income = parseFloat(savedIncome) || 0;
        if (savedPeriod) state.incomePeriod = savedPeriod;
        if (savedScores) state.scores = savedScores;
        if (savedAnswers) state.answerHistory = savedAnswers;
        if (savedEnvelopeOverrides) state.envelopeOverrides = savedEnvelopeOverrides;

        if (state.income > 0) { $('incomeInput').value = state.income; incomeHasBeenEntered = true; if (autopilotImported) $('incomeImported').style.display = 'inline-block'; }
        if (state.incomePeriod === 'annual') { $('btnAnnual').classList.add('active'); $('btnMonthly').classList.remove('active'); }

        personalizeForUpstream();

        if (quizDone && isUnlocked) {
            state.isUnlocked = true; renderDashboard(); showSection('s-dashboard');
        } else if (quizDone && !isUnlocked && isFrom800Club()) {
            try { localStorage.setItem('budget_unlocked', 'true'); } catch(e) {}
            state.isUnlocked = true; renderDashboard(); showSection('s-dashboard');
        } else if (quizDone && !isUnlocked) {
            var sys = SYSTEMS[state.selectedSystem];
            $('revealArchetype').textContent = sys.archetype; $('revealSystem').textContent = sys.title;
            renderDynamicWhyForReveal(); showSection('s-reveal'); activateGateRedirect();
        } else {
            if (isFrom800Club() && !quizDone) { runUpstreamTheater(function() { showSection('s-intro'); }); }
            else { showSection('s-intro'); }
        }
    })();

    function renderDynamicWhyForReveal() {
        var answers = state.answerHistory; if (!answers || answers.length === 0) return;
        var contributions = answers.map(function(a) { var opt = QUESTIONS[a.qi] ? QUESTIONS[a.qi].options[a.oi] : null; if (!opt) return null; return { reason: opt.reason, pts: opt.score[state.selectedSystem] || 0 }; })
            .filter(function(c) { return c && c.pts > 0; }).sort(function(a, b) { return b.pts - a.pts; }).slice(0, 3);
        if (contributions.length > 0) {
            var reasons = contributions.map(function(c, i) { return '<strong>(' + (i + 1) + ')</strong> ' + c.reason; });
            $('revealWhy').innerHTML = 'You told us: ' + reasons.join('. ') + '. This archetype is built for that exact profile.';
        }
    }
    </script>
</body>
</html>
