<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Cost of Waiting Engine</title>
    
    <style>body { background-color: #050505; }</style>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        cyber: {
                            black: '#050505',
                            dark: '#111111',
                            green: '#00FF41',
                            red: '#FF0000',
                            blue: '#00F0FF',
                            gold: '#FFD700',
                            gray: '#333333'
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'glitch': 'glitch 1s linear infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent;
            touch-action: pan-x;
            will-change: transform;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 32px;
            width: 32px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 2px solid #FF0000;
            cursor: pointer;
            margin-top: -14px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #333;
            border-radius: 2px;
        }
        
        .glitch { position: relative; }
        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .glitch::before {
            left: 2px;
            text-shadow: -1px 0 #FF0000;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        .glitch::after {
            left: -2px;
            text-shadow: -1px 0 #00FF41;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim {
            0% { clip: rect(31px, 9999px, 94px, 0); }
            5% { clip: rect(70px, 9999px, 11px, 0); }
            100% { clip: rect(13px, 9999px, 56px, 0); }
        }
        @keyframes glitch-anim2 {
            0% { clip: rect(21px, 9999px, 4px, 0); }
            5% { clip: rect(6px, 9999px, 64px, 0); }
            100% { clip: rect(43px, 9999px, 36px, 0); }
        }
        
        .damage-flash {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 100;
            background: radial-gradient(circle, transparent 40%, rgba(255,0,0,0.3) 100%);
            animation: flashOut 0.6s ease-out forwards;
        }
        @keyframes flashOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        [x-cloak] { display: none !important; }

        /* Returning user banner */
        .returning-banner {
            background: linear-gradient(135deg, rgba(0,255,65,0.08), rgba(0,255,65,0.02));
            border: 1px solid rgba(0,255,65,0.3);
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            animation: fadeIn 0.5s ease;
        }
        .returning-banner .banner-text { font-size: 11px; color: #00FF41; font-weight: 600; }
        .returning-banner .banner-sub { font-size: 10px; color: #666; }
        .returning-banner button { 
            font-size: 10px; padding: 4px 10px; border-radius: 4px; cursor: pointer;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
            transition: all 0.2s;
        }
        .returning-banner .btn-reset { background: transparent; border: 1px solid #333; color: #666; }
        .returning-banner .btn-reset:hover { border-color: #FF0000; color: #FF0000; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body class="bg-cyber-black text-white font-sans antialiased min-h-screen flex items-center justify-center p-4">

    <main x-data="costEngine()" class="w-full max-w-lg relative min-h-[600px] flex flex-col justify-center">

        <!-- PEAK-END: Damage Flash Effect -->
        <div x-show="showDamageFlash" 
             x-transition:leave="transition ease-out duration-600"
             class="damage-flash">
        </div>

        <!-- ========================================= -->
        <!-- IDLE STATE: Gatekeeper (First Visit Only) -->
        <!-- ========================================= -->
        <div x-show="state === 'idle'" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:leave="transition ease-in duration-200 opacity-0"
             class="text-center space-y-8">
            
            <div class="space-y-2">
                <h1 class="text-5xl font-black tracking-tighter text-white glitch" data-text="SYSTEM HALTED">
                    SYSTEM HALTED
                </h1>
                <p class="text-cyber-gray font-mono text-xs uppercase tracking-[0.2em]">
                    Compound Interest Engine Offline
                </p>
            </div>

            <button @click="ignite()" 
                    class="group relative inline-flex items-center justify-center px-8 py-6 overflow-hidden font-mono font-bold text-white transition-all duration-300 bg-transparent border-2 border-cyber-red rounded-none hover:bg-cyber-red/10 focus:outline-none cursor-pointer">
                <span class="absolute w-0 h-0 transition-all duration-500 ease-out bg-cyber-red rounded-full group-hover:w-80 group-hover:h-80 opacity-10"></span>
                <span class="relative flex items-center gap-4 text-xl tracking-widest uppercase">
                    <span class="animate-pulse">&#x26A0;&#xFE0F;</span> Initialize Engine
                </span>
            </button>

            <p class="text-[10px] text-cyber-gray/50 max-w-xs mx-auto mt-8 font-mono">
                WARNING: This tool projects irreversible financial decay. Proceed with caution.
            </p>
        </div>

        <!-- ========================================= -->
        <!-- PROCESSING STATE: Honest Theater          -->
        <!-- ========================================= -->
        <div x-show="state === 'processing'" x-cloak
             class="absolute inset-0 flex flex-col items-center justify-center z-50">
            <div class="w-full max-w-xs space-y-4">
                <div class="font-mono text-xs text-cyber-green space-y-1 h-32 overflow-hidden border-l-2 border-cyber-gray pl-4 flex flex-col justify-end">
                    <template x-for="log in logs" :key="log">
                        <div x-text="'> ' + log" class="opacity-80"></div>
                    </template>
                    <div class="animate-pulse">_</div>
                </div>
                
                <div class="w-full h-1 bg-cyber-gray rounded-full overflow-hidden">
                    <div class="h-full bg-cyber-red transition-all duration-300 ease-out" :style="'width: ' + progress + '%'"></div>
                </div>
                
                <p class="text-center font-mono text-white text-sm tracking-widest animate-pulse" x-text="statusText"></p>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- ACTIVE STATE: Calculator                  -->
        <!-- ========================================= -->
        <div x-show="state === 'active'" 
             x-transition:enter="transition ease-out duration-700 transform"
             x-transition:enter-start="opacity-0 translate-y-4 scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 scale-100"
             x-cloak
             class="w-full">

            <!-- Returning user banner (FIX #2: skip gatekeeper) -->
            <div x-show="isReturningUser" class="returning-banner">
                <div>
                    <div class="banner-text">&#x1F504; Your previous numbers are loaded.</div>
                    <div class="banner-sub">Last calculated <span x-text="lastVisitLabel"></span></div>
                </div>
                <button class="btn-reset" @click="resetToDefaults()">Start Fresh</button>
            </div>

            <div class="mb-8 text-center">
                <h1 class="text-4xl font-black tracking-tighter uppercase glitch" data-text="PROJECT TICKER">
                    PROJECT TICKER
                </h1>
                <div class="flex items-center justify-center gap-2 mt-2">
                    <span class="w-2 h-2 bg-cyber-green rounded-full animate-pulse"></span>
                    <p class="text-xs text-cyber-gray font-mono tracking-widest uppercase">Calculator Active</p>
                </div>
            </div>

            <!-- Input Card (FIX #6: Added currentWealth field) -->
            <div class="bg-cyber-dark border border-cyber-gray rounded-xl p-6 mb-6 shadow-2xl">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-cyber-gray uppercase mb-2">Current Age</label>
                        <input type="number" x-model.number="age" @input="debounceSave()"
                            class="w-full bg-black border border-cyber-gray text-white font-mono text-xl p-3 rounded focus:outline-none focus:border-white transition-colors text-center"
                            placeholder="20">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-cyber-gray uppercase mb-2">Monthly Invest</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-cyber-gray">$</span>
                            <input type="number" x-model.number="contribution" @input="debounceSave()"
                                class="w-full bg-black border border-cyber-gray text-white font-mono text-xl p-3 pl-8 rounded focus:outline-none focus:border-white transition-colors text-center"
                                placeholder="500">
                        </div>
                    </div>
                </div>

                <!-- FIX #6: Saved So Far input -->
                <div class="mb-6">
                    <label class="block text-xs font-bold text-cyber-gray uppercase mb-2">Saved So Far</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-cyber-gray">$</span>
                        <input type="number" x-model.number="currentWealth" @input="debounceSave()"
                            class="w-full bg-black border border-cyber-gray text-white font-mono text-lg p-3 pl-8 rounded focus:outline-none focus:border-white transition-colors text-center"
                            placeholder="0">
                    </div>
                    <p class="text-[10px] text-cyber-gray/50 text-center mt-1">Already have savings? Include them for an accurate projection.</p>
                </div>

                <div class="mt-4">
                    <div class="flex justify-between items-end mb-4">
                        <label class="text-sm font-bold uppercase tracking-wider text-cyber-red">Years You Wait</label>
                        <span class="text-3xl font-black font-mono text-cyber-red" x-text="waitYears + ' YRS'"></span>
                    </div>
                    <!-- FIX #4: No recalc overlay. Direct reactive updates. -->
                    <input type="range" min="0" max="10" step="1" x-model.number="waitYears" @input="onSliderChange()" class="w-full mb-2">
                    <p class="text-center text-[10px] text-cyber-gray uppercase mt-2">Slide right to see the damage</p>
                </div>
            </div>

            <!-- Results Card -->
            <div class="bg-cyber-dark border border-cyber-gray rounded-xl p-6 mb-6 relative overflow-hidden"
                 style="will-change: transform;"
                 :class="{ 'animate-shake': displayLoss > 500000 }">
                
                <div class="absolute top-0 right-0 w-32 h-32 bg-cyber-green opacity-5 blur-[80px]" x-show="waitYears === 0"></div>
                <div class="absolute bottom-0 left-0 w-32 h-32 bg-cyber-red opacity-5 blur-[80px]" x-show="waitYears > 0"></div>

                <div class="mb-6 border-b border-dashed border-cyber-gray pb-6">
                    <p class="text-xs font-bold text-cyber-green uppercase tracking-widest mb-1">Your Potential Net Worth</p>
                    <div class="text-3xl sm:text-4xl font-black font-mono text-white tracking-tight" x-text="formatMoney(wealthNow)"></div>
                    <p class="text-[10px] text-cyber-gray mt-1">At age 65 (8% avg. annual return, inflation-adjusted)</p>
                </div>

                <div>
                    <p class="text-xs font-bold text-cyber-red uppercase tracking-widest mb-1">Wealth You Burned</p>
                    <!-- PEAK-END: Animated loss counter -->
                    <div class="text-4xl sm:text-5xl font-black font-mono text-cyber-red tracking-tight" 
                         x-text="'-' + formatMoney(displayLoss)"></div>
                </div>

                <div class="mt-6 p-3 bg-black border border-cyber-red/30 rounded text-center">
                    <p class="text-sm font-bold text-white uppercase" 
                       :class="{ 'text-cyber-red': displayLoss > 500000 }"
                       x-text="getFeedback()"></p>
                </div>

                <!-- FIX #8: Daily cost on MAIN screen (not hidden in modal) -->
                <div x-show="dailyCost > 0" class="mt-4 pt-4 border-t border-dashed border-cyber-gray/50 text-center">
                    <p class="text-[10px] text-cyber-gray uppercase tracking-widest mb-1">To Erase This Damage:</p>
                    <div class="text-2xl font-black text-cyber-green font-mono">
                        <span x-text="formatMoney(dailyCost)"></span><span class="text-sm text-white">/day</span>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1" x-text="getDailyCostMessage()"></p>
                </div>
                
                <!-- OPERATIONAL TRANSPARENCY: Show The Math -->
                <div class="mt-4 pt-4 border-t border-dashed border-cyber-gray/50" x-show="waitYears > 0">
                    <p class="text-[10px] text-cyber-gray uppercase tracking-widest mb-2 text-center">The Math:</p>
                    <div class="text-[10px] text-gray-500 font-mono space-y-1 text-center">
                        <p x-show="currentWealth > 0"><span class="text-white" x-text="formatMoney(currentWealth)"></span> saved + <span class="text-white" x-text="formatMoney(contribution)"></span>/mo x <span class="text-white" x-text="(retirementAge - age)"></span> yrs = <span class="text-cyber-green" x-text="formatMoney(wealthNow)"></span></p>
                        <p x-show="currentWealth === 0"><span class="text-white" x-text="formatMoney(contribution)"></span>/mo x <span class="text-white" x-text="(retirementAge - age)"></span> yrs = <span class="text-cyber-green" x-text="formatMoney(wealthNow)"></span></p>
                        <p>Waiting <span class="text-cyber-red" x-text="waitYears"></span> yrs = <span class="text-cyber-red" x-text="waitYears * 12"></span> fewer months compounding</p>
                        <p>Lost growth: <span class="text-cyber-red font-bold" x-text="formatMoney(loss)"></span></p>
                    </div>
                </div>
            </div>

            <!-- FIX #7: Responsive CTA (color + text changes with loss amount) -->
            <button @click="showModal = true" 
                class="group block w-full text-center py-4 rounded-xl font-black uppercase tracking-widest transition-all hover:scale-[1.02] cursor-pointer"
                :class="ctaStyle">
                <span class="flex items-center justify-center gap-2">
                    <span x-text="ctaText"></span>
                    <span class="inline-block transition-transform group-hover:translate-x-1">&#x279C;</span>
                </span>
            </button>

            <p class="text-center text-[10px] text-cyber-gray mt-4 opacity-50">
                Assumes 8% annual return (S&P 500 historical average, inflation-adjusted) compounded monthly. Not financial advice.
            </p>

            <!-- ============================================== -->
            <!-- EMAIL GATE: COST OF WAITING -> INVESTMENT SIMPLIFIER -->
            <!-- ============================================== -->
            <div x-cloak x-show="showModal" 
                 class="fixed inset-0 z-[70] flex items-center justify-center p-3"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0">
                
                <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" @click="showModal = false"></div>
                
                <!-- GREEN BORDER: Pattern interrupt from red anxiety -->
                <div class="relative bg-cyber-dark border-2 border-cyber-green rounded-2xl p-4 w-full max-w-md shadow-[0_0_30px_rgba(0,255,65,0.2)] max-h-[95vh] overflow-y-auto"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 scale-90"
                     x-transition:enter-end="opacity-100 scale-100">
                    
                    <button @click="showModal = false" 
                            class="absolute top-3 right-3 text-cyber-gray/50 hover:text-cyber-gray transition-colors z-10 cursor-pointer">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>

                    <!-- HEADLINE -->
                    <div class="text-center mb-3">
                        <div class="inline-flex items-center gap-2 bg-cyber-green/10 border border-cyber-green/50 px-3 py-1 rounded-full mb-2">
                            <span class="w-2 h-2 bg-cyber-green rounded-full animate-pulse"></span>
                            <span class="text-[10px] font-bold text-cyber-green uppercase tracking-widest">Damage Reversible</span>
                        </div>
                        <h2 class="text-xl sm:text-2xl font-black uppercase text-white tracking-tight">
                            THE VEHICLE EXISTS.
                        </h2>
                        <p class="text-cyber-blue font-mono text-[10px] mt-1 uppercase tracking-widest">
                            Phase 1 Complete &rarr; Phase 2: Portfolio
                        </p>
                    </div>

                    <!-- DAILY COST CALCULATOR: REINFORCED IN MODAL -->
                    <div class="bg-black border-2 border-cyber-green/50 rounded-lg p-4 mb-3 text-center" x-show="dailyCost > 0">
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">To Erase This Damage:</p>
                        <div class="text-4xl font-black text-cyber-green font-mono drop-shadow-[0_0_15px_rgba(0,255,65,0.5)]">
                            <span x-text="formatMoney(dailyCost)"></span><span class="text-lg text-white">/day</span>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-2 leading-tight" x-text="getDailyCostMessage()"></p>
                    </div>

                    <!-- BRIDGE COPY -->
                    <div class="text-center mb-3">
                        <p class="text-xs text-gray-300 leading-relaxed">
                            You know the cost. Now you need the destination. The <span class="text-cyber-green font-bold">Investment Simplifier</span> shows you exactly which ETFs to buy based on your risk tolerance. 3 questions. 60 seconds. Your exact tickers.
                        </p>
                    </div>
                    
                    <!-- ROADMAP -->
                    <div class="bg-black/50 border border-cyber-gray rounded-lg p-3 mb-4">
                        <p class="text-[10px] text-cyber-gray uppercase tracking-widest mb-2 text-center">What Happens Next:</p>
                        <div class="flex items-center gap-2 text-[10px]">
                            <div class="flex flex-col items-center">
                                <div class="w-6 h-6 rounded-full bg-cyber-green/20 border border-cyber-green flex items-center justify-center text-cyber-green font-bold">1</div>
                                <span class="text-gray-500 mt-1">Email</span>
                            </div>
                            <div class="flex-1 h-px bg-cyber-gray"></div>
                            <div class="flex flex-col items-center">
                                <div class="w-6 h-6 rounded-full bg-cyber-blue/20 border border-cyber-blue flex items-center justify-center text-cyber-blue font-bold">2</div>
                                <span class="text-gray-500 mt-1">Tickers</span>
                            </div>
                            <div class="flex-1 h-px bg-cyber-gray"></div>
                            <div class="flex flex-col items-center">
                                <div class="w-6 h-6 rounded-full bg-cyber-gold/20 border border-cyber-gold flex items-center justify-center text-cyber-gold font-bold">3</div>
                                <span class="text-gray-500 mt-1">Invest</span>
                            </div>
                        </div>
                    </div>

                    <!-- BEEHIIV EMBED -->
                    <div class="flex justify-center pb-2">
                        <script async src="https://subscribe-forms.beehiiv.com/embed.js"></script>
                        <iframe id="beehiivFrame"
                                src="https://subscribe-forms.beehiiv.com/63ac9ac6-ada8-47a5-b5b6-654bdf88a7b6" 
                                class="beehiiv-embed" 
                                data-test-id="beehiiv-embed" 
                                frameborder="0" 
                                scrolling="no" 
                                style="width: 400px; height: 285px; margin: 0; border-radius: 16px 16px 16px 16px !important; background-color: transparent; box-shadow: 0 0 #0000; max-width: 100%;"></iframe>
                    </div>

                    <!-- BEEHIIV REDIRECT HANDLER: Catches subscribe event and redirects parent window -->
                    <script>
                    (function() {
                        const REDIRECT_URL = 'https://spacekou5-oss.github.io/cashvault-funnel/Investment-Simplifier.html';
                        let hasRedirected = false;

                        function doRedirect() {
                            if (hasRedirected) return;
                            hasRedirected = true;
                            // Save state before leaving
                            try {
                                localStorage.setItem('waiting_completed', 'true');
                                localStorage.setItem('cost_of_waiting_email', 'true');
                            } catch(e) {}
                            // Redirect the PARENT window, not the iframe
                            window.top.location.href = REDIRECT_URL;
                        }

                        // METHOD 1: Listen for postMessage from Beehiiv iframe
                        window.addEventListener('message', function(event) {
                            // Beehiiv sends various message formats on subscribe
                            if (event.origin && event.origin.includes('beehiiv.com')) {
                                const data = event.data;
                                if (typeof data === 'string') {
                                    if (data.includes('subscribed') || data.includes('success') || data.includes('confirmed')) {
                                        doRedirect();
                                    }
                                }
                                if (typeof data === 'object' && data !== null) {
                                    if (data.type === 'beehiiv:subscribe:success' || 
                                        data.event === 'subscribed' || 
                                        data.subscribed === true ||
                                        data.type === 'subscribe_success') {
                                        doRedirect();
                                    }
                                }
                            }
                        });

                        // METHOD 2: Detect iframe height change (Beehiiv embed.js resizes on success)
                        const iframe = document.getElementById('beehiivFrame');
                        if (iframe) {
                            let initialHeight = iframe.style.height;
                            const heightObserver = new MutationObserver(function(mutations) {
                                mutations.forEach(function(mutation) {
                                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                                        const newHeight = iframe.style.height;
                                        if (newHeight !== initialHeight && initialHeight) {
                                            // Height changed = form state changed (likely submitted)
                                            // Wait a beat to let Beehiiv process
                                            setTimeout(doRedirect, 1500);
                                        }
                                    }
                                });
                            });
                            heightObserver.observe(iframe, { attributes: true, attributeFilter: ['style', 'height'] });
                        }
                    })();
                    </script>

                    <!-- TRUST LINE -->
                    <div class="text-center mt-2 pb-2">
                        <p class="text-[10px] text-gray-500 font-mono tracking-wide">
                            Instant access. Your exact ETFs. Zero spam.
                        </p>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <script>
        function costEngine() {
            return {
                showModal: false,
                age: 20,
                contribution: 500,
                currentWealth: 0, // FIX #6: Saved So Far field
                waitYears: 1, // FIX #3: Start at 1 year for instant emotional payload
                
                state: 'idle', 
                statusText: '',
                logs: [],
                progress: 0,
                
                displayLoss: 0,
                lossAnimationFrame: null,
                _lastAnimStart: 0,
                showDamageFlash: false,
                
                previousWaitYears: 1,
                
                isReturningUser: false,
                lastVisitLabel: '',
                
                saveDebounceTimer: null,

                // ===========================
                // FIX #1: localStorage PERSISTENCE
                // ===========================
                saveState() {
                    const data = {
                        age: this.age,
                        contribution: this.contribution,
                        currentWealth: this.currentWealth,
                        waitYears: this.waitYears,
                        wealthNow: this.wealthNow,
                        loss: this.loss,
                        dailyCost: this.dailyCost,
                        calculatedAt: new Date().toISOString()
                    };
                    try {
                        localStorage.setItem('cost_of_waiting_data', JSON.stringify(data));
                        localStorage.setItem('waiting_completed', 'true');
                    } catch(e) {}
                },

                loadState() {
                    try {
                        const saved = localStorage.getItem('cost_of_waiting_data');
                        if (!saved) return false;
                        const data = JSON.parse(saved);
                        if (data.age) this.age = data.age;
                        if (data.contribution) this.contribution = data.contribution;
                        if (data.currentWealth) this.currentWealth = data.currentWealth;
                        if (data.waitYears !== undefined) this.waitYears = data.waitYears;
                        this.previousWaitYears = this.waitYears;
                        
                        // Calculate "last visit" label
                        if (data.calculatedAt) {
                            const diff = Date.now() - new Date(data.calculatedAt).getTime();
                            const mins = Math.floor(diff / 60000);
                            const hours = Math.floor(diff / 3600000);
                            const days = Math.floor(diff / 86400000);
                            if (mins < 60) this.lastVisitLabel = mins + ' minutes ago';
                            else if (hours < 24) this.lastVisitLabel = hours + ' hours ago';
                            else this.lastVisitLabel = days + ' days ago';
                        }
                        return true;
                    } catch(e) { return false; }
                },

                // Debounced save for input fields (300ms)
                debounceSave() {
                    if (this.saveDebounceTimer) clearTimeout(this.saveDebounceTimer);
                    this.saveDebounceTimer = setTimeout(() => this.saveState(), 300);
                },

                resetToDefaults() {
                    this.age = 20;
                    this.contribution = 500;
                    this.currentWealth = 0;
                    this.waitYears = 1;
                    this.previousWaitYears = 1;
                    this.isReturningUser = false;
                    this.displayLoss = this.loss;
                    try { localStorage.removeItem('cost_of_waiting_data'); } catch(e) {}
                },

                // ===========================
                // FIX #11: Cross-app Freedom Calculator prefill
                // ===========================
                prefillFromFreedomCalc() {
                    try {
                        const freedomData = localStorage.getItem('freedom_calculator_result');
                        if (!freedomData) return false;
                        const fd = JSON.parse(freedomData);
                        if (fd.age) this.age = fd.age;
                        if (fd.monthlyInvest) this.contribution = fd.monthlyInvest;
                        if (fd.currentWealth) this.currentWealth = fd.currentWealth;
                        return true;
                    } catch(e) { return false; }
                },

                // ===========================
                // INIT: Smart routing (FIX #2)
                // ===========================
                init() {
                    // FIX #2: Returning user detection
                    const hasSavedState = this.loadState();
                    
                    if (hasSavedState) {
                        // Returning user: skip gatekeeper + processing entirely
                        this.isReturningUser = true;
                        this.state = 'active';
                        // FIX #3 (MAX LEVERAGE): Animate loss from $0 on reveal
                        // Even for returning users, the count-up creates re-engagement
                        this.displayLoss = 0;
                        this.$nextTick(() => {
                            setTimeout(() => {
                                this.animateLossCounter(0, this.loss);
                                if (this.loss > 500000) {
                                    setTimeout(() => this.triggerDamageFlash(), 800);
                                }
                            }, 400);
                        });
                    } else {
                        // First visit: check for Freedom Calculator data
                        this.prefillFromFreedomCalc();
                    }

                    // Watch loss for reactive animations
                    this.$watch('loss', (newLoss, oldLoss) => {
                        if (this.state !== 'active') return;
                        this.animateLossCounter(oldLoss, newLoss);
                        
                        if (newLoss > 500000 && oldLoss <= 500000) {
                            this.triggerDamageFlash();
                        }
                    });
                },

                animateLossCounter(from, to) {
                    if (this.lossAnimationFrame) {
                        cancelAnimationFrame(this.lossAnimationFrame);
                    }
                    
                    // Shorter animation during rapid slider interaction
                    const now = performance.now();
                    const timeSinceLastAnim = now - (this._lastAnimStart || 0);
                    const duration = timeSinceLastAnim < 300 ? 200 : 600;
                    this._lastAnimStart = now;
                    
                    const startTime = now;
                    
                    const animate = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        const easeOut = 1 - Math.pow(1 - progress, 3);
                        
                        this.displayLoss = from + (to - from) * easeOut;
                        
                        if (progress < 1) {
                            this.lossAnimationFrame = requestAnimationFrame(animate);
                        } else {
                            this.displayLoss = to;
                        }
                    };
                    
                    this.lossAnimationFrame = requestAnimationFrame(animate);
                },
                
                triggerDamageFlash() {
                    this.showDamageFlash = true;
                    setTimeout(() => {
                        this.showDamageFlash = false;
                    }, 600);
                },
                
                // FIX #4: No overlay. Debounced save. Smooth slider.
                onSliderChange() {
                    this.previousWaitYears = this.waitYears;
                    this.debounceSave();
                },

                // ===========================
                // FIX #5: Honest processing theater
                // ===========================
                ignite() {
                    this.state = 'processing';
                    this.progress = 0;
                    this.logs = [];
                    
                    const sequence = [
                        { text: "LOADING COMPOUND INTEREST MODEL...", delay: 500, prog: 15 },
                        { text: "SETTING BASE RETURN: 8% ANNUAL (S&P 500 AVG)...", delay: 1200, prog: 35 },
                        { text: "CALIBRATING MONTHLY COMPOUNDING (8% / 12)...", delay: 2000, prog: 55 },
                        { text: "PROJECTING OPPORTUNITY COST AT " + this.waitYears + "-YEAR DELAY...", delay: 2800, prog: 80 },
                        { text: "RENDERING RESULTS...", delay: 3500, prog: 100 }
                    ];

                    sequence.forEach(step => {
                        setTimeout(() => {
                            this.statusText = step.text;
                            this.logs.push(step.text);
                            this.progress = step.prog;
                            if (this.logs.length > 5) this.logs.shift();
                        }, step.delay);
                    });

                    setTimeout(() => {
                        this.state = 'active';
                        this.saveState(); // FIX #1: Save on first calculation
                        // FIX #3 (MAX LEVERAGE): Animate loss from $0 on first reveal
                        // Processing theater promised damage. Now DELIVER it with a count-up.
                        this.displayLoss = 0;
                        this.$nextTick(() => {
                            setTimeout(() => {
                                this.animateLossCounter(0, this.loss);
                                // If the default 1-year loss is already > 500K, flash
                                if (this.loss > 500000) {
                                    setTimeout(() => this.triggerDamageFlash(), 800);
                                }
                            }, 200);
                        });
                    }, 4100);
                },

                // ===========================
                // FIX #10: Standardized 8% return
                // ===========================
                retirementAge: 65,
                annualRate: 0.08,

                get wealthNow() { return this.calculateFV(this.age); },
                get wealthLater() { return this.calculateFV(this.age + this.waitYears); },
                get loss() { return Math.max(0, this.wealthNow - this.wealthLater); },

                get dailyCost() {
                    const yearsRemaining = this.retirementAge - (this.age + this.waitYears);
                    if (yearsRemaining <= 0) return 0;
                    if (this.loss <= 0) return 0;
                    const daysRemaining = yearsRemaining * 365;
                    const daily = this.loss / daysRemaining;
                    if (isNaN(daily) || !isFinite(daily)) return 0;
                    return daily;
                },

                // FIX #6: calculateFV now includes currentWealth compounding
                calculateFV(startAge) {
                    if (startAge >= this.retirementAge) return 0;
                    const years = this.retirementAge - startAge;
                    const months = years * 12;
                    const monthlyRate = this.annualRate / 12;
                    
                    // Future value of existing savings
                    const fvSavings = (this.currentWealth || 0) * Math.pow(1 + monthlyRate, months);
                    // Future value of monthly contributions
                    const fvContributions = (this.contribution || 0) * ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate);
                    
                    return fvSavings + fvContributions;
                },

                // FIX #9: Gen Z feedback copy (rent, loans, house, retirement)
                getFeedback() {
                    const loss = this.displayLoss;
                    if (loss === 0) return "YOU ARE ON TRACK. STAY LOCKED IN.";
                    if (loss < 50000) return "THAT IS 2 YEARS OF RENT. GONE.";
                    if (loss < 100000) return "THAT IS YOUR ENTIRE STUDENT LOAN. BURNED.";
                    if (loss < 500000) return "THAT IS A HOUSE. VAPORIZED BY WAITING.";
                    return "YOU JUST DELETED A RETIREMENT. WHILE SCROLLING.";
                },

                getDailyCostMessage() {
                    const cost = this.dailyCost;
                    if (cost <= 0) return "";
                    if (cost < 10) return "That is the price of a coffee. Not a lottery win.";
                    if (cost < 50) return "That is less than a DoorDash order. Not a second job.";
                    if (cost < 150) return "Real money. But the payoff makes it obvious.";
                    return "Steep. But doing nothing costs more.";
                },

                // FIX #7: Responsive CTA (color + text matches emotional state)
                get ctaText() {
                    if (this.loss === 0) return "\u{1F4CA} SEE YOUR ETF PORTFOLIO";
                    if (this.loss < 100000) return "\u{1F527} START BEFORE IT GETS WORSE";
                    if (this.loss < 500000) return "\u26A0\uFE0F RECOVER THE DAMAGE";
                    return "\u{1F6A8} STOP THE BLEEDING NOW";
                },

                get ctaStyle() {
                    if (this.loss === 0) return 'bg-cyber-green hover:bg-green-500 text-black shadow-[0_0_20px_rgba(0,255,65,0.4)]';
                    if (this.loss < 500000) return 'bg-cyber-gold hover:bg-yellow-500 text-black shadow-[0_0_20px_rgba(255,215,0,0.4)]';
                    return 'bg-cyber-red hover:bg-red-600 text-white shadow-[0_0_20px_rgba(255,0,0,0.4)] animate-pulse-fast';
                },

                // Cached formatter (created ONCE, reused on every call)
                _moneyFmt: null,
                formatMoney(value) {
                    if (isNaN(value) || !isFinite(value) || value === null) return "$0";
                    if (!this._moneyFmt) {
                        this._moneyFmt = new Intl.NumberFormat('en-US', {
                            style: 'currency',
                            currency: 'USD',
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                    }
                    return this._moneyFmt.format(value);
                }
            }
        }
    </script>
</body>
</html>
