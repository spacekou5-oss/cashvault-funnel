<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Cost of Waiting Engine</title>
    
    <style>body { background-color: #050505; }</style>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        cyber: {
                            black: '#050505',
                            dark: '#111111',
                            green: '#00FF41',
                            red: '#FF0000',
                            blue: '#00F0FF',
                            gold: '#FFD700',
                            gray: '#333333'
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'glitch': 'glitch 1s linear infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent;
            touch-action: pan-x;
            will-change: transform;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 32px;
            width: 32px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 2px solid #FF0000;
            cursor: pointer;
            margin-top: -14px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #333;
            border-radius: 2px;
        }
        
        .glitch { position: relative; }
        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .glitch::before {
            left: 2px;
            text-shadow: -1px 0 #FF0000;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        .glitch::after {
            left: -2px;
            text-shadow: -1px 0 #00FF41;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim {
            0% { clip: rect(31px, 9999px, 94px, 0); }
            5% { clip: rect(70px, 9999px, 11px, 0); }
            100% { clip: rect(13px, 9999px, 56px, 0); }
        }
        @keyframes glitch-anim2 {
            0% { clip: rect(21px, 9999px, 4px, 0); }
            5% { clip: rect(6px, 9999px, 64px, 0); }
            100% { clip: rect(43px, 9999px, 36px, 0); }
        }
        
        .damage-flash {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 100;
            background: radial-gradient(circle, transparent 40%, rgba(255,0,0,0.3) 100%);
            animation: flashOut 0.6s ease-out forwards;
        }
        @keyframes flashOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        [x-cloak] { display: none !important; }

        /* ========================================== */
        /* OPTIMIZATION 1: SCAN SEQUENCE              */
        /* ========================================== */
        .scan-screen {
            position: fixed;
            inset: 0;
            z-index: 65;
            background: #050505;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .scan-bar-track {
            width: 100%;
            max-width: 280px;
            height: 4px;
            background: #111111;
            border-radius: 2px;
            overflow: hidden;
            border: 1px solid #333;
        }
        .scan-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF0000 0%, #FF0000 70%, rgba(255,0,0,0.4) 100%);
            border-radius: 2px;
            transition: width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 0 12px rgba(255, 0, 0, 0.4);
        }
        .scan-phase-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: #FF0000;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            transition: opacity 0.3s ease;
            min-height: 18px;
        }
        .scan-cursor::after {
            content: '|';
            animation: cursorBlink 0.6s step-end infinite;
            color: #FF0000;
            margin-left: 2px;
        }
        @keyframes cursorBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .scan-killshot {
            animation: killshotReveal 0.8s ease-out forwards;
        }
        @keyframes killshotReveal {
            0% { opacity: 0; transform: scale(0.95) translateY(8px); }
            60% { opacity: 1; transform: scale(1.02) translateY(-2px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .scan-btn-reveal {
            animation: btnReveal 0.5s ease-out 0.3s forwards;
            opacity: 0;
        }
        @keyframes btnReveal {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Pulsing red warning ring during scan */
        .scan-warning-ring {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 2px solid rgba(255, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: warningPulse 1.5s ease-in-out infinite;
        }
        @keyframes warningPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255,0,0,0.2); }
            50% { box-shadow: 0 0 0 12px rgba(255,0,0,0); }
        }

        /* ========================================== */
        /* OPTIMIZATION 2: RETURNING USER POPUP       */
        /* ========================================== */
        .return-popup-overlay {
            position: fixed;
            inset: 0;
            z-index: 60;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .return-popup-card {
            position: relative;
            width: 100%;
            max-width: 380px;
            border-radius: 16px;
            overflow: hidden;
        }

        /* Already-subscribed popup (legacy, keeping for CTA click) */
        .sub-popup {
            background: linear-gradient(135deg, rgba(0,240,255,0.06), rgba(0,255,65,0.04));
            border: 1px solid rgba(0,240,255,0.4);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 380px;
            text-align: center;
        }
        .sub-popup .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,255,65,0.1);
            border: 1px solid rgba(0,255,65,0.4);
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 700;
            color: #00FF41;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
        }
        .sub-popup .badge .dot {
            width: 6px; height: 6px;
            background: #00FF41;
            border-radius: 50%;
        }

        /* Footer */
        .site-footer {
            text-align: center;
            padding: 24px 16px 16px;
            margin-top: 32px;
            border-top: 1px solid rgba(51,51,51,0.5);
        }
        .site-footer a {
            color: #00F0FF;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }
        .site-footer a:hover { color: #FFFFFF; }
    </style>
</head>
<body class="bg-cyber-black text-white font-sans antialiased min-h-screen flex flex-col items-center justify-center p-4">

    <main x-data="costEngine()" class="w-full max-w-lg relative min-h-[600px] flex flex-col justify-center">

        <!-- PEAK-END: Damage Flash Effect -->
        <div x-show="showDamageFlash" 
             x-transition:leave="transition ease-out duration-600"
             class="damage-flash">
        </div>

        <!-- ========================================== -->
        <!-- OPTIMIZATION 1: UNIFIED SCAN SEQUENCE      -->
        <!-- (Replaces BOTH static splash + processing) -->
        <!-- ========================================== -->
        <div x-show="showScanScreen" x-cloak
             x-transition:leave="transition ease-in duration-500"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="scan-screen">
            
            <div class="max-w-sm w-full space-y-8 text-center">
                <!-- Warning icon -->
                <div class="flex justify-center">
                    <div class="scan-warning-ring">
                        <span class="text-2xl">&#x26A0;&#xFE0F;</span>
                    </div>
                </div>

                <!-- Title -->
                <div>
                    <p class="text-[10px] font-mono text-cyber-red/60 uppercase tracking-[0.3em] mb-2">Financial Decay Engine</p>
                    <h1 class="text-2xl font-black font-mono tracking-tight text-white uppercase">
                        COST OF WAITING
                    </h1>
                </div>

                <!-- Scan progress -->
                <div class="space-y-3">
                    <div class="scan-bar-track mx-auto">
                        <div class="scan-bar-fill" :style="'width: ' + scanProgress + '%'"></div>
                    </div>
                    <p class="scan-phase-text" :class="scanPhase < 5 ? 'scan-cursor' : ''" x-text="scanText"></p>
                    <p class="text-[9px] font-mono text-cyber-gray/40" x-text="scanProgress + '% complete'"></p>
                </div>

                <!-- Kill shot (after scan completes) -->
                <div x-show="scanComplete" x-cloak class="space-y-6 pt-2">
                    <div class="scan-killshot space-y-3 border-l-2 border-cyber-red pl-5 text-left">
                        <p class="text-lg text-white font-bold leading-relaxed">
                            Every day you wait has a <span class="text-cyber-red">price tag</span>.
                        </p>
                        <p class="text-lg text-white font-bold leading-relaxed">
                            This engine calculates the <span class="text-cyber-red">exact dollar amount</span>.
                        </p>
                        <p class="text-xs text-cyber-gray mt-2 leading-relaxed">
                            Your compound interest model is loaded. The numbers will not be comfortable.
                        </p>
                    </div>

                    <div class="scan-btn-reveal">
                        <button @click="exitScanScreen()" 
                                class="group relative inline-flex items-center justify-center w-full px-8 py-4 font-black text-white transition-all duration-200 bg-cyber-red rounded-xl hover:shadow-[0_0_25px_rgba(255,0,0,0.5)] cursor-pointer">
                            SHOW ME THE DAMAGE
                        </button>
                        <p class="text-[9px] text-cyber-gray/40 font-mono mt-3">8% annual return. S&P 500 historical average. Real math.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- OPTIMIZATION 2: RETURNING USER POPUP       -->
        <!-- ========================================== -->
        <div x-show="showReturnPopup" x-cloak
             x-transition:enter="transition ease-out duration-400"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="return-popup-overlay">
            
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>

            <!-- STATE A: Already submitted email. Direct to Investment Simplifier -->
            <div x-show="returnState === 'subscribed'" x-cloak
                 class="return-popup-card bg-cyber-dark border-2 border-cyber-green p-6 shadow-[0_0_30px_rgba(0,255,65,0.15)] z-10">
                
                <div class="text-center space-y-4">
                    <div class="inline-flex items-center gap-2 bg-cyber-green/10 border border-cyber-green/40 px-3 py-1 rounded-full">
                        <span class="w-2 h-2 bg-cyber-green rounded-full animate-pulse"></span>
                        <span class="text-[10px] font-bold text-cyber-green uppercase tracking-widest">Access Active</span>
                    </div>

                    <div>
                        <p class="text-[10px] font-mono text-cyber-green uppercase tracking-[0.2em]">Welcome back</p>
                        <h2 class="text-xl font-black uppercase text-white mt-1">Your Portfolio Tool is Ready</h2>
                    </div>

                    <p class="text-xs text-gray-400 leading-relaxed">
                        You already unlocked the Investment Simplifier. Pick up where you left off, or run new numbers.
                    </p>

                    <!-- Show their last numbers -->
                    <div class="bg-black/60 border border-cyber-gray rounded-lg p-3" x-show="lastSavedLoss > 0">
                        <p class="text-[10px] text-cyber-gray uppercase tracking-widest mb-1">Last calculation:</p>
                        <p class="text-lg font-black font-mono text-cyber-red" x-text="'-' + formatMoney(lastSavedLoss)"></p>
                        <p class="text-[9px] text-cyber-gray mt-1">burned by waiting <span x-text="waitYears"></span> year(s)</p>
                    </div>

                    <div class="space-y-2 pt-2">
                        <a href="https://spacekou5-oss.github.io/cashvault-funnel/Investment-Simplifier.html"
                           class="flex items-center justify-center gap-2 w-full py-3.5 rounded-xl font-black uppercase text-sm text-black bg-cyber-green hover:shadow-[0_0_20px_rgba(0,255,65,0.4)] transition-all cursor-pointer no-underline shadow-[0_0_15px_rgba(0,255,65,0.3)]">
                            OPEN INVESTMENT SIMPLIFIER &#x279C;
                        </a>
                        <button @click="showReturnPopup = false" 
                                class="w-full py-2.5 rounded-xl font-bold text-[11px] uppercase tracking-widest text-cyber-gray bg-transparent border border-cyber-gray hover:border-white hover:text-white transition-all cursor-pointer">
                            Run new numbers
                        </button>
                    </div>
                </div>
            </div>

            <!-- STATE B: Has saved data, hasn't subscribed -->
            <div x-show="returnState === 'calculator'" x-cloak
                 class="return-popup-card bg-cyber-dark border-2 border-cyber-red/40 p-6 shadow-[0_0_20px_rgba(255,0,0,0.1)] z-10">
                
                <div class="text-center space-y-4">
                    <div class="text-3xl">&#x26A0;&#xFE0F;</div>

                    <div>
                        <p class="text-[10px] font-mono text-cyber-red uppercase tracking-[0.2em]">Engine still running</p>
                        <h2 class="text-xl font-black uppercase text-white mt-1">Your Numbers Are Loaded</h2>
                    </div>

                    <!-- Show their last numbers as urgency reinforcement -->
                    <div class="bg-black/60 border border-cyber-red/30 rounded-lg p-3" x-show="lastSavedLoss > 0">
                        <p class="text-[10px] text-cyber-gray uppercase tracking-widest mb-1">Last time you checked:</p>
                        <p class="text-2xl font-black font-mono text-cyber-red" x-text="'-' + formatMoney(lastSavedLoss)"></p>
                        <p class="text-[9px] text-cyber-red/60 mt-1 font-bold">That number grew while you were gone.</p>
                    </div>

                    <p class="text-xs text-gray-400 leading-relaxed">
                        You saw the damage. The next step is building the vehicle to reverse it.
                    </p>

                    <div class="space-y-2 pt-1">
                        <button @click="showReturnPopup = false; showModal = true;" 
                                class="flex items-center justify-center gap-2 w-full py-3.5 rounded-xl font-black uppercase text-sm text-black bg-cyber-green hover:shadow-[0_0_20px_rgba(0,255,65,0.4)] transition-all cursor-pointer shadow-[0_0_15px_rgba(0,255,65,0.2)]">
                            &#x1F527; SEE YOUR ETF PORTFOLIO
                        </button>
                        <button @click="showReturnPopup = false" 
                                class="w-full py-2.5 rounded-xl font-bold text-[11px] uppercase tracking-widest text-cyber-gray bg-transparent border border-cyber-gray hover:border-white hover:text-white transition-all cursor-pointer">
                            Recalculate first
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- ACTIVE STATE: Calculator                  -->
        <!-- ========================================= -->
        <div x-show="state === 'active'" 
             x-transition:enter="transition ease-out duration-700 transform"
             x-transition:enter-start="opacity-0 translate-y-4 scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 scale-100"
             x-cloak
             class="w-full">

            <div class="mb-8 text-center">
                <h1 class="text-4xl font-black tracking-tighter uppercase glitch" data-text="PROJECT TICKER">
                    PROJECT TICKER
                </h1>
                <div class="flex items-center justify-center gap-2 mt-2">
                    <span class="w-2 h-2 bg-cyber-green rounded-full animate-pulse"></span>
                    <p class="text-xs text-cyber-gray font-mono tracking-widest uppercase">Calculator Active</p>
                </div>
            </div>

            <!-- Input Card -->
            <div class="bg-cyber-dark border border-cyber-gray rounded-xl p-6 mb-6 shadow-2xl">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-cyber-gray uppercase mb-2">Current Age</label>
                        <input type="number" x-model.number="age" @input="debounceSave()"
                            class="w-full bg-black border border-cyber-gray text-white font-mono text-xl p-3 rounded focus:outline-none focus:border-white transition-colors text-center"
                            placeholder="20">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-cyber-gray uppercase mb-2">Monthly Invest</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-cyber-gray">$</span>
                            <input type="number" x-model.number="contribution" @input="debounceSave()"
                                class="w-full bg-black border border-cyber-gray text-white font-mono text-xl p-3 pl-8 rounded focus:outline-none focus:border-white transition-colors text-center"
                                placeholder="100">
                        </div>
                    </div>
                </div>

                <!-- Saved So Far input -->
                <div class="mb-6">
                    <label class="block text-xs font-bold text-cyber-gray uppercase mb-2">Saved So Far</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-cyber-gray">$</span>
                        <input type="number" x-model.number="currentWealth" @input="debounceSave()"
                            class="w-full bg-black border border-cyber-gray text-white font-mono text-lg p-3 pl-8 rounded focus:outline-none focus:border-white transition-colors text-center"
                            placeholder="0">
                    </div>
                    <p class="text-[10px] text-cyber-gray/50 text-center mt-1">Already have savings? Include them for an accurate projection.</p>
                </div>

                <div class="mt-4">
                    <div class="flex justify-between items-end mb-4">
                        <label class="text-sm font-bold uppercase tracking-wider text-cyber-red">Years You Wait</label>
                        <span class="text-3xl font-black font-mono text-cyber-red" x-text="waitYears + ' YRS'"></span>
                    </div>
                    <input type="range" min="0" max="10" step="1" x-model.number="waitYears" @input="onSliderChange()" class="w-full mb-2">
                    <p class="text-center text-[10px] text-cyber-gray uppercase mt-2">Slide right to see the damage</p>
                </div>
            </div>

            <!-- Results Card -->
            <div class="bg-cyber-dark border border-cyber-gray rounded-xl p-6 mb-6 relative overflow-hidden"
                 style="will-change: transform; contain: layout style;"
                 :class="{ 'animate-shake': isShaking }">
                
                <div class="absolute top-0 right-0 w-32 h-32 bg-cyber-green rounded-full opacity-[0.03]" 
                     style="filter: blur(40px); will-change: opacity;"
                     x-show="waitYears === 0"></div>
                <div class="absolute bottom-0 left-0 w-32 h-32 bg-cyber-red rounded-full opacity-[0.03]" 
                     style="filter: blur(40px); will-change: opacity;"
                     x-show="waitYears > 0"></div>

                <div class="mb-6 border-b border-dashed border-cyber-gray pb-6">
                    <p class="text-xs font-bold text-cyber-green uppercase tracking-widest mb-1">Your Potential Net Worth</p>
                    <div class="text-3xl sm:text-4xl font-black font-mono text-white tracking-tight" x-text="formatMoney(wealthNow)"></div>
                    <p class="text-[10px] text-cyber-gray mt-1">At age 65 (8% avg. annual return, inflation-adjusted)</p>
                </div>

                <div>
                    <p class="text-xs font-bold text-cyber-red uppercase tracking-widest mb-1">Wealth You Burned</p>
                    <div class="text-4xl sm:text-5xl font-black font-mono text-cyber-red tracking-tight" 
                         x-text="'-' + formatMoney(displayLoss)"></div>
                </div>

                <div class="mt-6 p-3 bg-black border border-cyber-red/30 rounded text-center">
                    <p class="text-sm font-bold text-white uppercase" 
                       :class="{ 'text-cyber-red': isShaking }"
                       x-text="getFeedback()"></p>
                </div>

                <!-- Daily cost -->
                <div x-show="dailyCost > 0" class="mt-4 pt-4 border-t border-dashed border-cyber-gray/50 text-center">
                    <p class="text-[10px] text-cyber-gray uppercase tracking-widest mb-1">To Erase This Damage:</p>
                    <div class="text-2xl font-black text-cyber-green font-mono">
                        <span x-text="formatMoney(dailyCost)"></span><span class="text-sm text-white">/day</span>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1" x-text="getDailyCostMessage()"></p>
                </div>
                
                <!-- Show The Math -->
                <div class="mt-4 pt-4 border-t border-dashed border-cyber-gray/50" x-show="waitYears > 0">
                    <p class="text-[10px] text-cyber-gray uppercase tracking-widest mb-2 text-center">The Math:</p>
                    <div class="text-[10px] text-gray-500 font-mono space-y-1 text-center">
                        <p x-show="currentWealth > 0"><span class="text-white" x-text="formatMoney(currentWealth)"></span> saved + <span class="text-white" x-text="formatMoney(contribution)"></span>/mo x <span class="text-white" x-text="(retirementAge - age)"></span> yrs = <span class="text-cyber-green" x-text="formatMoney(wealthNow)"></span></p>
                        <p x-show="currentWealth === 0"><span class="text-white" x-text="formatMoney(contribution)"></span>/mo x <span class="text-white" x-text="(retirementAge - age)"></span> yrs = <span class="text-cyber-green" x-text="formatMoney(wealthNow)"></span></p>
                        <p>Waiting <span class="text-cyber-red" x-text="waitYears"></span> yrs = <span class="text-cyber-red" x-text="waitYears * 12"></span> fewer months compounding</p>
                        <p>Lost growth: <span class="text-cyber-red font-bold" x-text="formatMoney(loss)"></span></p>
                    </div>
                </div>
            </div>

            <!-- Responsive CTA -->
            <button @click="handleCtaClick()" 
                class="group block w-full text-center py-4 rounded-xl font-black uppercase tracking-widest transition-all hover:scale-[1.02] cursor-pointer"
                :class="ctaStyle">
                <span class="flex items-center justify-center gap-2">
                    <span x-text="ctaText"></span>
                    <span class="inline-block transition-transform group-hover:translate-x-1">&#x279C;</span>
                </span>
            </button>

            <p class="text-center text-[10px] text-cyber-gray mt-4 opacity-50">
                Assumes 8% annual return (S&P 500 historical average, inflation-adjusted) compounded monthly. Not financial advice.
            </p>

            <!-- ============================================== -->
            <!-- ALREADY SUBSCRIBED POPUP (via CTA click)       -->
            <!-- ============================================== -->
            <div x-cloak x-show="showSubPopup"
                 class="fixed inset-0 z-[70] flex items-center justify-center p-3"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0">

                <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" @click="showSubPopup = false"></div>

                <div class="relative sub-popup"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 scale-90"
                     x-transition:enter-end="opacity-100 scale-100">

                    <button @click="showSubPopup = false"
                            class="absolute top-3 right-3 text-cyber-gray/50 hover:text-cyber-gray transition-colors z-10 cursor-pointer">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>

                    <div class="badge"><span class="dot"></span> Progress Saved</div>

                    <h3 class="text-lg font-black text-white uppercase tracking-tight mb-2">
                        You already unlocked this.
                    </h3>
                    <p class="text-xs text-gray-400 mb-5 leading-relaxed">
                        Your Investment Simplifier access is ready. Pick up where you left off, or keep running numbers here.
                    </p>

                    <div class="space-y-3">
                        <a href="https://spacekou5-oss.github.io/cashvault-funnel/Investment-Simplifier.html"
                           class="block w-full py-3 rounded-lg font-bold uppercase tracking-widest text-sm text-black bg-cyber-green hover:bg-green-400 transition-all cursor-pointer text-center shadow-[0_0_20px_rgba(0,255,65,0.3)]">
                            Open Investment Simplifier &#x279C;
                        </a>
                        <button @click="showSubPopup = false"
                                class="block w-full py-3 rounded-lg font-bold uppercase tracking-widest text-sm text-gray-400 bg-transparent border border-cyber-gray hover:border-white hover:text-white transition-all cursor-pointer">
                            Keep Using Calculator
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================== -->
            <!-- EMAIL GATE: COST OF WAITING -> INV SIMPLIFIER  -->
            <!-- ============================================== -->
            <div x-cloak x-show="showModal" 
                 class="fixed inset-0 z-[70] flex items-center justify-center p-3"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0">
                
                <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" @click="showModal = false"></div>
                
                <div class="relative bg-cyber-dark border-2 border-cyber-green rounded-2xl p-4 w-full max-w-md shadow-[0_0_30px_rgba(0,255,65,0.2)] max-h-[95vh] overflow-y-auto"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 scale-90"
                     x-transition:enter-end="opacity-100 scale-100">
                    
                    <button @click="showModal = false" 
                            class="absolute top-3 right-3 text-cyber-gray/50 hover:text-cyber-gray transition-colors z-10 cursor-pointer">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>

                    <div class="text-center mb-3">
                        <div class="inline-flex items-center gap-2 bg-cyber-green/10 border border-cyber-green/50 px-3 py-1 rounded-full mb-2">
                            <span class="w-2 h-2 bg-cyber-green rounded-full animate-pulse"></span>
                            <span class="text-[10px] font-bold text-cyber-green uppercase tracking-widest">Damage Reversible</span>
                        </div>
                        <h2 class="text-xl sm:text-2xl font-black uppercase text-white tracking-tight">
                            THE VEHICLE EXISTS.
                        </h2>
                        <p class="text-cyber-blue font-mono text-[10px] mt-1 uppercase tracking-widest">
                            Phase 1 Complete &rarr; Phase 2: Portfolio
                        </p>
                    </div>

                    <div class="bg-black border-2 border-cyber-green/50 rounded-lg p-4 mb-3 text-center" x-show="dailyCost > 0">
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">To Erase This Damage:</p>
                        <div class="text-4xl font-black text-cyber-green font-mono drop-shadow-[0_0_15px_rgba(0,255,65,0.5)]">
                            <span x-text="formatMoney(dailyCost)"></span><span class="text-lg text-white">/day</span>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-2 leading-tight" x-text="getDailyCostMessage()"></p>
                    </div>

                    <div class="text-center mb-3">
                        <p class="text-xs text-gray-300 leading-relaxed">
                            You know the cost. Now you need the destination. The <span class="text-cyber-green font-bold">Investment Simplifier</span> shows you exactly which ETFs to buy based on your risk tolerance. 3 questions. 60 seconds. Your exact tickers.
                        </p>
                    </div>
                    
                    <div class="bg-black/50 border border-cyber-gray rounded-lg p-3 mb-4">
                        <p class="text-[10px] text-cyber-gray uppercase tracking-widest mb-2 text-center">What Happens Next:</p>
                        <div class="flex items-center gap-2 text-[10px]">
                            <div class="flex flex-col items-center">
                                <div class="w-6 h-6 rounded-full bg-cyber-green/20 border border-cyber-green flex items-center justify-center text-cyber-green font-bold">1</div>
                                <span class="text-gray-500 mt-1">Email</span>
                            </div>
                            <div class="flex-1 h-px bg-cyber-gray"></div>
                            <div class="flex flex-col items-center">
                                <div class="w-6 h-6 rounded-full bg-cyber-blue/20 border border-cyber-blue flex items-center justify-center text-cyber-blue font-bold">2</div>
                                <span class="text-gray-500 mt-1">Tickers</span>
                            </div>
                            <div class="flex-1 h-px bg-cyber-gray"></div>
                            <div class="flex flex-col items-center">
                                <div class="w-6 h-6 rounded-full bg-cyber-gold/20 border border-cyber-gold flex items-center justify-center text-cyber-gold font-bold">3</div>
                                <span class="text-gray-500 mt-1">Invest</span>
                            </div>
                        </div>
                    </div>

                    <!-- BEEHIIV EMBED -->
                    <div class="flex justify-center pb-2">
                        <iframe id="beehiivFrame"
                                src="https://subscribe-forms.beehiiv.com/63ac9ac6-ada8-47a5-b5b6-654bdf88a7b6" 
                                class="beehiiv-embed" 
                                data-test-id="beehiiv-embed" 
                                frameborder="0" 
                                scrolling="no" 
                                style="width: 400px; height: 285px; margin: 0; border-radius: 16px 16px 16px 16px !important; background-color: transparent; box-shadow: 0 0 #0000; max-width: 100%;"></iframe>
                    </div>
                    <script async src="https://subscribe-forms.beehiiv.com/embed.js"></script>

                    <div class="text-center mt-2 pb-2">
                        <p class="text-[10px] text-gray-500 font-mono tracking-wide">
                            Instant access. Your exact ETFs. Zero spam.
                        </p>
                    </div>
                </div>
            </div>

        </div>

        <!-- FOOTER -->
        <footer class="site-footer w-full" x-show="state === 'active'">
            <a href="https://instagram.com/koutalksmoney" target="_blank" rel="noopener noreferrer" class="font-mono text-xs">
                @koutalksmoney
            </a>
            <p class="text-[10px] text-gray-600 mt-2 font-mono">
                Built by Kou Talks Money. 2026. All rights reserved.
            </p>
        </footer>

    </main>

    <script>
        function costEngine() {
            return {
                // Screen states
                showScanScreen: false,
                showReturnPopup: false,
                returnState: '',          // 'subscribed' | 'calculator'
                lastSavedLoss: 0,

                showModal: false,
                showSubPopup: false,
                state: 'idle',            // 'idle' (hidden), 'active'
                
                age: 20,
                contribution: 100,
                currentWealth: 0,
                waitYears: 0,
                
                // Scan sequence
                scanProgress: 15,
                scanPhase: 0,
                scanText: '',
                scanComplete: false,

                displayLoss: 0,
                lossAnimationFrame: null,
                _lastAnimStart: 0,
                showDamageFlash: false,
                isShaking: false,
                
                previousWaitYears: 0,
                
                isReturningUser: false,
                lastVisitLabel: '',
                
                saveDebounceTimer: null,

                // ===========================
                // SCAN SEQUENCE (Optimization 1)
                // ===========================
                scanPhases: [
                    { text: 'Loading compound interest model...', target: 30 },
                    { text: 'Setting base return: 8% annual (S&P 500)...', target: 50 },
                    { text: 'Calibrating monthly compounding...', target: 70 },
                    { text: 'Projecting opportunity cost decay...', target: 88 },
                    { text: 'Rendering damage report...', target: 100 },
                ],

                startScanSequence() {
                    this.showScanScreen = true;
                    this.scanProgress = 15;
                    this.scanPhase = 0;
                    this.scanComplete = false;
                    this.scanText = '';

                    setTimeout(() => { this.runScanPhase(0); }, 700);
                },

                runScanPhase(index) {
                    if (index >= this.scanPhases.length) {
                        this.scanText = 'Engine ready.';
                        this.scanPhase = 5;
                        setTimeout(() => {
                            this.scanComplete = true;
                        }, 400);
                        return;
                    }

                    const phase = this.scanPhases[index];
                    this.scanPhase = index;
                    this.scanText = phase.text;
                    
                    setTimeout(() => {
                        this.scanProgress = phase.target;
                    }, 100);

                    // Varied durations for realism
                    const durations = [1000, 1200, 900, 1100, 700];
                    setTimeout(() => {
                        this.runScanPhase(index + 1);
                    }, durations[index]);
                },

                exitScanScreen() {
                    this.showScanScreen = false;
                    setTimeout(() => {
                        this.state = 'active';
                        this.saveState();
                        this.displayLoss = this.loss;
                    }, 300);
                },

                // ===========================
                // RETURNING USER ROUTING (Optimization 2)
                // ===========================
                determineReturnState() {
                    try {
                        const hasEmail = localStorage.getItem('cost_of_waiting_email');
                        if (hasEmail === 'true') {
                            this.returnState = 'subscribed';
                            return;
                        }
                    } catch(e) {}
                    this.returnState = 'calculator';
                },

                // ===========================
                // localStorage PERSISTENCE
                // ===========================
                saveState() {
                    const data = {
                        age: this.age,
                        contribution: this.contribution,
                        currentWealth: this.currentWealth,
                        waitYears: this.waitYears,
                        wealthNow: this.wealthNow,
                        loss: this.loss,
                        dailyCost: this.dailyCost,
                        calculatedAt: new Date().toISOString()
                    };
                    try {
                        localStorage.setItem('cost_of_waiting_data', JSON.stringify(data));
                        localStorage.setItem('waiting_completed', 'true');
                    } catch(e) {}
                },

                loadState() {
                    try {
                        const saved = localStorage.getItem('cost_of_waiting_data');
                        if (!saved) return false;
                        const data = JSON.parse(saved);
                        if (data.age) this.age = data.age;
                        if (data.contribution) this.contribution = data.contribution;
                        if (data.currentWealth) this.currentWealth = data.currentWealth;
                        if (data.waitYears !== undefined) this.waitYears = data.waitYears;
                        if (data.loss) this.lastSavedLoss = data.loss;
                        this.previousWaitYears = this.waitYears;
                        
                        if (data.calculatedAt) {
                            const diff = Date.now() - new Date(data.calculatedAt).getTime();
                            const mins = Math.floor(diff / 60000);
                            const hours = Math.floor(diff / 3600000);
                            const days = Math.floor(diff / 86400000);
                            if (mins < 60) this.lastVisitLabel = mins + ' minutes ago';
                            else if (hours < 24) this.lastVisitLabel = hours + ' hours ago';
                            else this.lastVisitLabel = days + ' days ago';
                        }
                        return true;
                    } catch(e) { return false; }
                },

                debounceSave() {
                    if (this.saveDebounceTimer) clearTimeout(this.saveDebounceTimer);
                    this.saveDebounceTimer = setTimeout(() => this.saveState(), 300);
                },

                resetToDefaults() {
                    this.age = 20;
                    this.contribution = 100;
                    this.currentWealth = 0;
                    this.waitYears = 1;
                    this.previousWaitYears = 1;
                    this.isReturningUser = false;
                    this.lastSavedLoss = 0;
                    this.displayLoss = this.loss;
                    try { 
                        localStorage.removeItem('cost_of_waiting_data'); 
                        localStorage.removeItem('waiting_completed');
                        localStorage.removeItem('cost_of_waiting_email');
                    } catch(e) {}
                },

                // Cross-app Freedom Calculator prefill
                prefillFromFreedomCalc() {
                    try {
                        const freedomData = localStorage.getItem('freedom_calculator_result');
                        if (!freedomData) return false;
                        const fd = JSON.parse(freedomData);
                        if (fd.age) this.age = fd.age;
                        if (fd.monthlyInvest) this.contribution = fd.monthlyInvest;
                        if (fd.currentWealth) this.currentWealth = fd.currentWealth;
                        return true;
                    } catch(e) { return false; }
                },

                // CTA click handler
                handleCtaClick() {
                    try {
                        const alreadySubscribed = localStorage.getItem('cost_of_waiting_email') === 'true';
                        if (alreadySubscribed) {
                            this.showSubPopup = true;
                        } else {
                            this.showModal = true;
                        }
                    } catch(e) {
                        this.showModal = true;
                    }
                },

                // ===========================
                // INIT: Smart routing
                // ===========================
                _redirectHandler: null,
                _heightObserver: null,
                _hasRedirected: false,

                init() {
                    const hasSavedState = this.loadState();
                    
                    if (hasSavedState) {
                        // RETURNING USER: Show conditional popup
                        this.isReturningUser = true;
                        this.state = 'active';
                        this.displayLoss = 0;
                        
                        this.determineReturnState();
                        this.showReturnPopup = true;

                        requestAnimationFrame(() => {
                            this.animateLossCounter(0, this.loss);
                            if (this.loss > 500000) {
                                this.isShaking = true;
                            }
                        });
                    } else {
                        // NEW USER: Launch scan sequence
                        this.prefillFromFreedomCalc();
                        this.startScanSequence();
                    }

                    this.$watch('loss', (newLoss, oldLoss) => {
                        if (this.state !== 'active') return;
                        this.animateLossCounter(oldLoss, newLoss);
                        
                        if (newLoss > 500000 && !this.isShaking) {
                            this.isShaking = true;
                        } else if (newLoss <= 500000) {
                            this.isShaking = false;
                        }
                        
                        if (newLoss > 500000 && oldLoss <= 500000) {
                            requestAnimationFrame(() => this.triggerDamageFlash());
                        }
                    });

                    // Watch modal for beehiiv redirect
                    this.$watch('showModal', (isOpen) => {
                        if (isOpen) {
                            this.activateRedirectHandler();
                        } else {
                            this.deactivateRedirectHandler();
                        }
                    });
                },

                // ===========================
                // BEEHIIV REDIRECT (moved into Alpine)
                // ===========================
                doBeehiivRedirect() {
                    if (this._hasRedirected) return;
                    this._hasRedirected = true;
                    try {
                        localStorage.setItem('waiting_completed', 'true');
                        localStorage.setItem('cost_of_waiting_email', 'true');
                    } catch(e) {}
                    window.top.location.href = 'https://spacekou5-oss.github.io/cashvault-funnel/Investment-Simplifier.html';
                },

                activateRedirectHandler() {
                    const self = this;

                    this._redirectHandler = function(event) {
                        if (!self.showModal) return;
                        if (event.origin && event.origin.includes('beehiiv.com')) {
                            const data = event.data;
                            if (typeof data === 'string') {
                                if (data.includes('subscribed') || data.includes('success') || data.includes('confirmed')) {
                                    self.doBeehiivRedirect();
                                }
                            }
                            if (typeof data === 'object' && data !== null) {
                                if (data.type === 'beehiiv:subscribe:success' || 
                                    data.event === 'subscribed' || 
                                    data.subscribed === true ||
                                    data.type === 'subscribe_success') {
                                    self.doBeehiivRedirect();
                                }
                            }
                        }
                    };
                    window.addEventListener('message', this._redirectHandler);

                    const iframe = document.getElementById('beehiivFrame');
                    if (iframe) {
                        const initialHeight = iframe.style.height;
                        const observerActivatedAt = Date.now();
                        this._heightObserver = new MutationObserver(function(mutations) {
                            if (!self.showModal) return;
                            if (Date.now() - observerActivatedAt < 3000) return;
                            mutations.forEach(function(mutation) {
                                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                                    const newHeight = iframe.style.height;
                                    if (newHeight !== initialHeight && initialHeight) {
                                        setTimeout(function() { self.doBeehiivRedirect(); }, 1500);
                                    }
                                }
                            });
                        });
                        this._heightObserver.observe(iframe, { attributes: true, attributeFilter: ['style', 'height'] });
                    }
                },

                deactivateRedirectHandler() {
                    if (this._redirectHandler) {
                        window.removeEventListener('message', this._redirectHandler);
                        this._redirectHandler = null;
                    }
                    if (this._heightObserver) {
                        this._heightObserver.disconnect();
                        this._heightObserver = null;
                    }
                },

                // ===========================
                // ANIMATION HELPERS
                // ===========================
                animateLossCounter(from, to) {
                    if (this.lossAnimationFrame) {
                        cancelAnimationFrame(this.lossAnimationFrame);
                    }
                    
                    const now = performance.now();
                    const timeSinceLastAnim = now - (this._lastAnimStart || 0);
                    const duration = timeSinceLastAnim < 300 ? 200 : 600;
                    this._lastAnimStart = now;
                    
                    const startTime = now;
                    
                    const animate = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        const easeOut = 1 - Math.pow(1 - progress, 3);
                        
                        this.displayLoss = from + (to - from) * easeOut;
                        
                        if (progress < 1) {
                            this.lossAnimationFrame = requestAnimationFrame(animate);
                        } else {
                            this.displayLoss = to;
                        }
                    };
                    
                    this.lossAnimationFrame = requestAnimationFrame(animate);
                },
                
                triggerDamageFlash() {
                    this.showDamageFlash = true;
                    setTimeout(() => {
                        this.showDamageFlash = false;
                    }, 600);
                },
                
                onSliderChange() {
                    this.previousWaitYears = this.waitYears;
                    this.debounceSave();
                },

                // ===========================
                // Core math
                // ===========================
                retirementAge: 65,
                annualRate: 0.08,

                get wealthNow() { return this.calculateFV(this.age); },
                get wealthLater() { return this.calculateFV(this.age + this.waitYears); },
                get loss() { return Math.max(0, this.wealthNow - this.wealthLater); },

                get dailyCost() {
                    const yearsRemaining = this.retirementAge - (this.age + this.waitYears);
                    if (yearsRemaining <= 0) return 0;
                    if (this.loss <= 0) return 0;
                    const daysRemaining = yearsRemaining * 365;
                    const daily = this.loss / daysRemaining;
                    if (isNaN(daily) || !isFinite(daily)) return 0;
                    return daily;
                },

                calculateFV(startAge) {
                    if (startAge >= this.retirementAge) return 0;
                    const years = this.retirementAge - startAge;
                    const months = years * 12;
                    const monthlyRate = this.annualRate / 12;
                    
                    const fvSavings = (this.currentWealth || 0) * Math.pow(1 + monthlyRate, months);
                    const fvContributions = (this.contribution || 0) * ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate);
                    
                    return fvSavings + fvContributions;
                },

                getFeedback() {
                    const loss = this.displayLoss;
                    if (loss === 0) return "YOU ARE ON TRACK. STAY LOCKED IN.";
                    if (loss < 50000) return "THAT IS 2 YEARS OF RENT. GONE.";
                    if (loss < 100000) return "THAT IS YOUR ENTIRE STUDENT LOAN. BURNED.";
                    if (loss < 500000) return "THAT IS A HOUSE. VAPORIZED BY WAITING.";
                    return "YOU JUST DELETED A RETIREMENT. WHILE SCROLLING.";
                },

                getDailyCostMessage() {
                    const cost = this.dailyCost;
                    if (cost <= 0) return "";
                    if (cost < 10) return "That is the price of a coffee. Not a lottery win.";
                    if (cost < 50) return "That is less than a DoorDash order. Not a second job.";
                    if (cost < 150) return "Real money. But the payoff makes it obvious.";
                    return "Steep. But doing nothing costs more.";
                },

                get ctaText() {
                    if (this.loss === 0) return "\u{1F4CA} SEE YOUR ETF PORTFOLIO";
                    if (this.loss < 100000) return "\u{1F527} START BEFORE IT GETS WORSE";
                    if (this.loss < 500000) return "\u26A0\uFE0F RECOVER THE DAMAGE";
                    return "\u{1F6A8} STOP THE BLEEDING NOW";
                },

                get ctaStyle() {
                    if (this.loss === 0) return 'bg-cyber-green hover:bg-green-500 text-black shadow-[0_0_20px_rgba(0,255,65,0.4)]';
                    if (this.loss < 500000) return 'bg-cyber-gold hover:bg-yellow-500 text-black shadow-[0_0_20px_rgba(255,215,0,0.4)]';
                    return 'bg-cyber-red hover:bg-red-600 text-white shadow-[0_0_20px_rgba(255,0,0,0.4)] animate-pulse-fast';
                },

                _moneyFmt: null,
                formatMoney(value) {
                    if (isNaN(value) || !isFinite(value) || value === null) return "$0";
                    if (!this._moneyFmt) {
                        this._moneyFmt = new Intl.NumberFormat('en-US', {
                            style: 'currency',
                            currency: 'USD',
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                    }
                    return this._moneyFmt.format(value);
                }
            }
        }
    </script>
</body>
</html>
