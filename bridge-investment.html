<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Unlocked | @koutalksmoney</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #111936;
            --bg-card: #1a1f3a;
            --bg-card-hover: #242b4d;
            --accent-indigo: #6366f1;
            --accent-indigo-glow: rgba(99,102,241,0.3);
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-green-glow: rgba(16,185,129,0.2);
            --accent-amber: #f59e0b;
            --accent-red: #ef4444;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-subtle: rgba(255,255,255,0.08);
            --border-accent: rgba(99,102,241,0.3);
        }

        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.6; }

        .bg-grid {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(99,102,241,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(99,102,241,0.03) 1px, transparent 1px);
            background-size: 50px 50px; pointer-events: none; z-index: 0;
        }

        .container { position: relative; z-index: 1; max-width: 800px; margin: 0 auto; padding: 40px 20px; }

        /* ============================================
           PROCESSING THEATER (new users only)
           Reframes the email signup as valuable.
           Skipped entirely for returning users.
           Idleness Aversion + Operational Transparency.
        ============================================ */
        .processing-theater {
            position: fixed; inset: 0; background: var(--bg-primary); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; text-align: center;
        }
        .processing-theater.hidden { display: none; }

        .theater-icon {
            width: 72px; height: 72px; margin-bottom: 28px; position: relative;
        }
        .theater-ring {
            width: 72px; height: 72px; border: 3px solid rgba(99,102,241,0.15);
            border-top-color: var(--accent-indigo); border-right-color: var(--accent-purple);
            border-radius: 50%; animation: spin 1s linear infinite;
            position: absolute; top: 0; left: 0;
        }
        .theater-ring-inner {
            width: 52px; height: 52px; border: 2px solid rgba(16,185,129,0.1);
            border-bottom-color: var(--accent-green);
            border-radius: 50%; animation: spin 1.5s linear infinite reverse;
            position: absolute; top: 10px; left: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .theater-title {
            font-size: 1.25rem; font-weight: 700; color: var(--text-primary);
            margin-bottom: 6px; min-height: 32px;
            transition: opacity 0.3s ease;
        }
        .theater-step {
            font-size: 0.85rem; color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 28px; min-height: 22px;
            transition: opacity 0.3s ease;
        }
        .theater-progress {
            width: 300px; height: 6px; background: rgba(99,102,241,0.12);
            border-radius: 3px; overflow: hidden; margin-bottom: 8px;
        }
        .theater-progress-fill {
            height: 100%; border-radius: 3px;
            background: linear-gradient(90deg, var(--accent-indigo), var(--accent-purple), var(--accent-green));
            background-size: 200% 100%;
            animation: progressShimmer 2s ease infinite;
            transition: width 0.6s ease; width: 15%;
        }
        @keyframes progressShimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .theater-pct {
            font-size: 0.72rem; color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace; margin-bottom: 24px;
        }
        .theater-value-frame {
            max-width: 380px; padding: 16px 24px;
            background: rgba(16,185,129,0.06); border: 1px solid rgba(16,185,129,0.2);
            border-radius: 12px; opacity: 0; transform: translateY(8px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .theater-value-frame.show { opacity: 1; transform: translateY(0); }
        .theater-value-label {
            font-size: 0.68rem; color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 0.12em; margin-bottom: 6px;
        }
        .theater-value-text { font-size: 0.88rem; color: var(--accent-green); font-weight: 600; line-height: 1.5; }

        /* Success Header */
        .success-header { text-align: center; margin-bottom: 40px; animation: fadeInUp 0.6s ease-out; }
        .success-icon {
            width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-green), #059669);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin: 0 auto 24px; box-shadow: 0 0 40px var(--accent-green-glow); animation: pulse 2s ease-in-out infinite;
        }
        .success-icon svg { width: 40px; height: 40px; color: white; }
        .success-header h1 { font-size: 2rem; font-weight: 800; margin-bottom: 8px; background: linear-gradient(135deg, var(--text-primary), var(--accent-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .success-header p { color: var(--text-secondary); font-size: 1.1rem; }

        .reinforcement {
            text-align: center; margin-top: 16px; padding: 12px 20px;
            background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.2);
            border-radius: 10px; animation: fadeInUp 0.8s ease-out 0.3s backwards;
        }
        .reinforcement p { font-size: 0.9rem; color: var(--accent-green); font-weight: 600; }
        .reinforcement .subtext { font-size: 0.8rem; color: var(--text-muted); font-weight: 400; margin-top: 4px; }

        .upstream-badge {
            display: none; margin: 0 auto 16px; padding: 8px 16px;
            background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.08));
            border: 1px solid rgba(99,102,241,0.3); border-radius: 20px;
            font-size: 0.8rem; font-weight: 600; color: var(--accent-indigo);
            width: fit-content; animation: fadeInUp 0.5s ease-out;
        }

        /* Portfolio Card */
        .portfolio-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 32px; margin-bottom: 24px; animation: fadeInUp 0.6s ease-out 0.1s backwards; }
        .portfolio-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-subtle); }
        .portfolio-meta { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
        .meta-badge { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary); }
        .meta-badge.style { background: linear-gradient(135deg, var(--accent-indigo), var(--accent-purple)); color: white; font-weight: 600; }
        .portfolio-id { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-muted); }

        .allocation-display { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .allocation-box { background: var(--bg-secondary); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid var(--border-subtle); }
        .allocation-box.stocks { border-color: var(--accent-green); box-shadow: 0 0 20px rgba(16,185,129,0.1); }
        .allocation-box.bonds { border-color: var(--accent-indigo); box-shadow: 0 0 20px var(--accent-indigo-glow); }
        .allocation-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .allocation-value { font-size: 2.5rem; font-weight: 800; }
        .allocation-box.stocks .allocation-value { color: var(--accent-green); }
        .allocation-box.bonds .allocation-value { color: var(--accent-indigo); }

        .strategy-explainer {
            background: linear-gradient(135deg, rgba(99,102,241,0.08) 0%, rgba(139,92,246,0.04) 100%);
            border: 1px solid rgba(99,102,241,0.2); border-radius: 12px;
            padding: 20px; margin-bottom: 24px; animation: fadeInUp 0.6s ease-out 0.12s backwards;
        }
        .strategy-explainer h3 { font-size: 1rem; font-weight: 700; color: var(--accent-indigo); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .strategy-explainer p { color: var(--text-secondary); font-size: 0.88rem; line-height: 1.7; margin-bottom: 8px; }
        .strategy-explainer .strategy-detail { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
        .strategy-detail-item { flex: 1; min-width: 140px; padding: 10px 14px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-subtle); }
        .strategy-detail-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .strategy-detail-value { font-size: 0.9rem; font-weight: 700; color: var(--text-primary); }

        .etf-section { margin-bottom: 24px; }
        .section-title { font-size: 1rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .section-title::before { content: ''; width: 4px; height: 16px; background: var(--accent-indigo); border-radius: 2px; }
        .etf-grid { display: grid; gap: 12px; }
        .etf-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; }
        .etf-card:hover { border-color: var(--accent-indigo); transform: translateX(4px); }
        .etf-card.core { border-left: 3px solid var(--accent-green); }
        .etf-card.diversifier { border-left: 3px solid var(--accent-purple); }
        .etf-card.bonds { border-left: 3px solid var(--accent-indigo); }
        .etf-card.stability { border-left: 3px solid var(--accent-amber); }
        .etf-info { display: flex; flex-direction: column; }
        .etf-ticker { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
        .etf-name { font-size: 0.85rem; color: var(--text-muted); }
        .etf-desc { font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; font-style: italic; }
        .etf-meta { display: flex; gap: 8px; margin-top: 4px; }
        .etf-meta-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .etf-meta-tag.expense { background: rgba(16,185,129,0.15); color: var(--accent-green); }
        .etf-meta-tag.type { background: rgba(99,102,241,0.15); color: var(--accent-indigo); }
        .etf-percent { font-size: 1.5rem; font-weight: 800; color: var(--accent-green); text-align: right; }

        /* Projections */
        .projections-card { background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary)); border: 1px solid var(--border-accent); border-radius: 16px; padding: 32px; margin-bottom: 24px; animation: fadeInUp 0.6s ease-out 0.2s backwards; }
        .projections-header { text-align: center; margin-bottom: 24px; }
        .projections-header h3 { font-size: 1.2rem; font-weight: 700; margin-bottom: 4px; }
        .projections-header p { color: var(--text-muted); font-size: 0.9rem; }
        .projections-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .projection-box { background: var(--bg-primary); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid var(--border-subtle); position: relative; overflow: hidden; }
        .projection-box::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .projection-box.year10::before { background: var(--accent-amber); }
        .projection-box.year20::before { background: var(--accent-purple); }
        .projection-box.year30::before { background: var(--accent-green); }
        .projection-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .projection-value { font-size: 1.4rem; font-weight: 800; }
        .projection-box.year10 .projection-value { color: var(--accent-amber); }
        .projection-box.year20 .projection-value { color: var(--accent-purple); }
        .projection-box.year30 .projection-value { color: var(--accent-green); }
        .projection-subtext { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

        .comparison-banner {
            margin-top: 20px; padding: 16px; text-align: center;
            background: rgba(251,191,36,0.08); border: 1px solid rgba(251,191,36,0.25); border-radius: 12px;
        }
        .comparison-banner p { font-size: 0.9rem; color: var(--text-secondary); }
        .comparison-banner .highlight { color: var(--accent-green); font-weight: 700; }
        .comparison-banner .avg { color: var(--text-muted); }
        .comparison-banner .multiplier { color: var(--accent-amber); font-size: 1.3rem; font-weight: 800; display: block; margin-top: 6px; }

        .cost-of-waiting {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-top: 16px; padding: 10px 16px;
            background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.25); border-radius: 10px;
            font-size: 0.85rem; color: var(--accent-red);
        }
        .cost-of-waiting .tick-value { font-family: 'JetBrains Mono', monospace; font-weight: 800; font-size: 0.95rem; min-width: 60px; text-align: center; }

        /* Share Card */
        .share-card { background: linear-gradient(135deg, #0f172a, #1e293b); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 24px; margin-bottom: 24px; animation: fadeInUp 0.6s ease-out 0.3s backwards; }
        .share-card-header { text-align: center; margin-bottom: 16px; }
        .share-card-header h3 { font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
        .share-card-header p { font-size: 0.8rem; color: var(--text-muted); }
        .share-card-inner { background: linear-gradient(145deg, #1a1f3a, #0f1629); border-radius: 12px; padding: 24px; position: relative; overflow: hidden; }
        .share-card-inner::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--accent-indigo), var(--accent-purple), var(--accent-green)); }
        .share-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(99,102,241,0.2); border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: var(--accent-indigo); margin-bottom: 16px; }
        .share-title { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 4px; }
        .share-value { font-size: 2rem; font-weight: 800; color: var(--accent-green); margin-bottom: 4px; }
        .share-comparison { font-size: 0.8rem; color: var(--accent-amber); font-weight: 600; margin-bottom: 12px; }
        .share-allocation { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px; }
        .share-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--border-subtle); }
        .share-id { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); }
        .share-handle { font-size: 0.85rem; color: var(--accent-indigo); font-weight: 600; }
        .share-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; }

        /* Buttons */
        .btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 16px 24px; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s ease; text-decoration: none; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-indigo), var(--accent-purple)); color: white; box-shadow: 0 4px 20px var(--accent-indigo-glow); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px var(--accent-indigo-glow); }
        .btn-command {
            background: linear-gradient(135deg, var(--accent-green), #059669); color: white;
            box-shadow: 0 4px 20px var(--accent-green-glow);
            position: relative; overflow: hidden;
        }
        .btn-command:hover { transform: translateY(-2px); box-shadow: 0 8px 30px var(--accent-green-glow); }
        .btn-command::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            animation: btnSheen 3s ease-in-out infinite;
        }
        @keyframes btnSheen { 0% { left: -100%; } 50%, 100% { left: 100%; } }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-subtle); }
        .btn-secondary:hover { border-color: var(--accent-indigo); background: var(--bg-card-hover); }
        .btn-ghost { background: transparent; color: var(--text-secondary); border: 1px dashed var(--border-subtle); }
        .btn-ghost:hover { color: var(--text-primary); border-color: var(--text-muted); }
        .btn-sm { padding: 10px 16px; font-size: 0.85rem; }

        /* ============================================
           ECOSYSTEM PROGRESS + COMMAND CENTER CTA
           Replaces: Autopilot CTA + Bookmark reminder.
           Single exit point into the loop hub.
           Command Center IS the loop. This page
           celebrates the win and funnels INTO it.
        ============================================ */
        .ecosystem-progress {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(26,31,58,0.8) 100%);
            border: 2px solid rgba(16,185,129,0.25); border-radius: 16px;
            padding: 28px; margin-bottom: 24px; animation: fadeInUp 0.6s ease-out 0.35s backwards;
            position: relative; overflow: hidden;
        }
        .ecosystem-progress::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-indigo), var(--accent-purple));
        }
        .ecosystem-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .ecosystem-title { font-size: 1rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .ecosystem-level {
            font-size: 0.72rem; font-weight: 700; padding: 4px 12px;
            background: rgba(99,102,241,0.15); color: var(--accent-indigo);
            border-radius: 20px; text-transform: uppercase; letter-spacing: 0.06em;
        }
        .ecosystem-apps { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .eco-app {
            padding: 12px 10px; background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: 10px; text-align: center; font-size: 0.78rem; transition: all 0.2s;
        }
        .eco-app.completed { border-color: rgba(16,185,129,0.35); background: rgba(16,185,129,0.06); }
        .eco-app.locked { opacity: 0.4; }
        .eco-app-icon { font-size: 1.2rem; margin-bottom: 4px; display: block; }
        .eco-app-name { font-weight: 600; color: var(--text-secondary); display: block; }
        .eco-app.completed .eco-app-name { color: var(--accent-green); }
        .eco-app-status { font-size: 0.62rem; color: var(--text-muted); display: block; margin-top: 2px; text-transform: uppercase; letter-spacing: 0.04em; }
        .eco-app.completed .eco-app-status { color: var(--accent-green); }

        .ecosystem-context { font-size: 0.88rem; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6; }
        .ecosystem-context strong { color: var(--accent-green); }

        /* Brokerage Explainer */
        .brokerage-explainer {
            background: linear-gradient(135deg, rgba(99,102,241,0.06) 0%, rgba(139,92,246,0.03) 100%);
            border: 1px solid rgba(99,102,241,0.2); border-radius: 14px;
            padding: 24px; margin-bottom: 24px; animation: fadeInUp 0.6s ease-out 0.45s backwards;
        }
        .brokerage-explainer h3 { font-size: 1rem; font-weight: 700; color: var(--accent-indigo); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        .brokerage-explainer .explainer-text { color: var(--text-secondary); font-size: 0.88rem; line-height: 1.7; margin-bottom: 16px; }
        .brokerage-explainer .explainer-highlight { color: var(--accent-green); font-weight: 600; }
        .brokerage-explainer .explainer-note { padding: 12px 16px; background: var(--bg-card); border-left: 3px solid var(--accent-green); border-radius: 0 8px 8px 0; font-size: 0.82rem; color: var(--text-secondary); margin-bottom: 16px; }
        .brokerage-options { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 600px) { .brokerage-options { grid-template-columns: repeat(3, 1fr); } }
        .brokerage-option { text-align: center; padding: 18px 14px; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 10px; transition: all 0.2s; text-decoration: none; display: block; cursor: pointer; position: relative; }
        .brokerage-option:hover { border-color: var(--accent-indigo); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(99,102,241,0.15); }
        .brokerage-option.recommended { border-color: var(--accent-green); box-shadow: 0 0 20px rgba(16,185,129,0.1); }
        .brokerage-option-rec { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent-green); background: rgba(16,185,129,0.12); padding: 4px 10px; border-radius: 20px; display: inline-block; margin-bottom: 10px; }
        .brokerage-option-name { font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
        .brokerage-option-cost { font-size: 0.75rem; color: var(--accent-green); font-weight: 600; margin-bottom: 10px; }
        .brokerage-option-desc { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 10px; }
        .brokerage-option-best { font-size: 0.75rem; color: var(--accent-indigo); font-weight: 600; margin-bottom: 12px; padding-top: 8px; border-top: 1px solid var(--border-subtle); }
        .brokerage-option-cta { font-size: 0.75rem; color: var(--accent-indigo); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Next Steps */
        .next-steps { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 24px; margin-bottom: 24px; animation: fadeInUp 0.6s ease-out 0.5s backwards; }
        .next-steps h3 { font-size: 1rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .steps-list { display: grid; gap: 16px; }
        .step-item { display: flex; gap: 14px; align-items: flex-start; padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-subtle); }
        .step-number { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent-indigo), var(--accent-purple)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 700; color: white; flex-shrink: 0; }
        .step-content h4 { font-size: 0.95rem; font-weight: 700; margin-bottom: 6px; color: var(--text-primary); }
        .step-content p { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6; }
        .step-content .step-detail { font-size: 0.8rem; color: var(--text-muted); margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-subtle); line-height: 1.5; }
        .step-etf-detail { font-family: 'JetBrains Mono', monospace; color: var(--accent-green); font-weight: 600; }
        .step-time { display: inline-flex; align-items: center; gap: 4px; font-size: 0.72rem; color: var(--accent-amber); font-weight: 600; padding: 2px 8px; background: rgba(245,158,11,0.1); border-radius: 4px; margin-top: 6px; }

        .footer { text-align: center; padding: 32px 0; color: var(--text-muted); font-size: 0.85rem; }
        .footer a { color: var(--accent-indigo); text-decoration: none; }

        .error-state { text-align: center; padding: 60px 20px; }
        .error-state h2 { font-size: 1.5rem; margin-bottom: 12px; }
        .error-state p { color: var(--text-secondary); margin-bottom: 24px; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 40px var(--accent-green-glow); } 50% { box-shadow: 0 0 60px var(--accent-green-glow); } }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }

        @media (max-width: 600px) {
            .container { padding: 24px 16px; }
            .portfolio-card, .projections-card, .share-card { padding: 20px; }
            .allocation-display { grid-template-columns: 1fr; }
            .projections-grid { grid-template-columns: 1fr; }
            .projection-box { display: flex; justify-content: space-between; align-items: center; text-align: left; }
            .projection-label { margin-bottom: 0; }
            .projection-subtext { display: none; }
            .portfolio-header { flex-direction: column; gap: 12px; align-items: flex-start; }
            .success-header h1 { font-size: 1.6rem; }
            .share-actions { grid-template-columns: 1fr; }
            .ecosystem-apps { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <canvas id="confetti-canvas"></canvas>

    <!-- ============================================
         PROCESSING THEATER
         Only shown to NEW users (first bridge visit).
         Returning users skip straight to results.
         Reframes the email signup value via
         Idleness Aversion + Operational Transparency.
    ============================================ -->
    <div class="processing-theater hidden" id="processingTheater">
        <div class="theater-icon">
            <div class="theater-ring"></div>
            <div class="theater-ring-inner"></div>
        </div>
        <p class="theater-title" id="theaterTitle">Verifying your email...</p>
        <p class="theater-step" id="theaterStep">Connecting to portfolio data...</p>
        <div class="theater-progress"><div class="theater-progress-fill" id="theaterProgressFill"></div></div>
        <p class="theater-pct" id="theaterPct">15%</p>
        <div class="theater-value-frame" id="theaterValueFrame">
            <p class="theater-value-label">What You Just Unlocked</p>
            <p class="theater-value-text" id="theaterValueText"></p>
        </div>
    </div>

    <div class="container" id="main-content">
        <div class="success-header">
            <div class="success-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
            </div>
            <div class="upstream-badge" id="upstreamBadge"></div>
            <h1 id="bridgeHeadline">Portfolio Unlocked</h1>
            <p id="bridgeSubline">Your personalized ETF allocation is ready.</p>
            <div class="reinforcement">
                <p id="reinforcement-text">You just did what 90% of people never do: built an actual plan.</p>
                <p class="subtext" id="reinforcement-sub"></p>
            </div>
        </div>

        <div class="portfolio-card" id="portfolio-card">
            <div class="portfolio-header">
                <div class="portfolio-meta">
                    <div class="meta-badge"><span>&#x1F382;</span><span id="display-age">--</span> years old</div>
                    <div class="meta-badge style" id="display-style">--</div>
                </div>
                <div class="portfolio-id" id="display-id">ID: ---</div>
            </div>
            <div class="allocation-display">
                <div class="allocation-box stocks"><div class="allocation-label">&#x1F4C8; Stocks</div><div class="allocation-value" id="display-stocks">--%</div></div>
                <div class="allocation-box bonds"><div class="allocation-label">&#x1F3E6; Bonds</div><div class="allocation-value" id="display-bonds">--%</div></div>
            </div>

            <div class="strategy-explainer" id="strategyExplainer">
                <h3>&#x1F9E0; What This Means</h3>
                <p id="strategyExplainerText">Loading...</p>
                <div class="strategy-detail" id="strategyDetails"></div>
            </div>

            <div class="etf-section">
                <div class="section-title">Your Buy List</div>
                <div class="etf-grid" id="etf-grid"></div>
            </div>
        </div>

        <div class="projections-card">
            <div class="projections-header">
                <h3>&#x1F680; Growth Projections</h3>
                <p>Based on $<span id="display-monthly">--</span>/month investment</p>
            </div>
            <div class="projections-grid">
                <div class="projection-box year10"><div class="projection-label">10 Years</div><div class="projection-value" id="proj-10">$--</div><div class="projection-subtext">Foundation</div></div>
                <div class="projection-box year20"><div class="projection-label">20 Years</div><div class="projection-value" id="proj-20">$--</div><div class="projection-subtext">Acceleration</div></div>
                <div class="projection-box year30"><div class="projection-label">30 Years</div><div class="projection-value" id="proj-30">$--</div><div class="projection-subtext">Freedom</div></div>
            </div>
            <div class="comparison-banner">
                <p>The average American retires with <span class="avg">$87,000</span>. You're projected at <span class="highlight" id="comp-you">$0</span>.</p>
                <span class="multiplier" id="comp-multiplier">0x ahead of the pack</span>
            </div>
            <div class="cost-of-waiting">
                <span>&#x23F3;</span>
                <span>Not starting costs you </span>
                <span class="tick-value" id="costTickerValue">$0.00</span>
                <span> and counting...</span>
            </div>
        </div>

        <!-- Share Card -->
        <div class="share-card">
            <div class="share-card-header">
                <h3>&#x1F4F8; Screenshot This. Post It. Tag Me.</h3>
                <p>Show your friends you have a plan. Challenge them to build theirs.</p>
            </div>
            <div class="share-card-inner" id="share-card-inner">
                <div class="share-badge"><span>&#x2713;</span> INVESTMENT ARCHITECT</div>
                <div class="share-title">30-Year Projection</div>
                <div class="share-value" id="share-value">$--</div>
                <div class="share-comparison" id="share-comparison">0x ahead of the average American</div>
                <div class="share-allocation"><span id="share-stocks">--%</span> Stocks / <span id="share-bonds">--%</span> Bonds</div>
                <div class="share-footer">
                    <div class="share-id" id="share-id">ID: ---</div>
                    <div class="share-handle">@koutalksmoney</div>
                </div>
            </div>
            <div class="share-actions">
                <button class="btn btn-secondary btn-sm" onclick="copyCaption()"><span>&#x1F4CB;</span> Copy Caption</button>
                <button class="btn btn-ghost btn-sm" onclick="downloadCard()"><span>&#x1F4F8;</span> Download Card</button>
            </div>
        </div>

        <!-- ============================================
             ECOSYSTEM PROGRESS + COMMAND CENTER CTA
             Replaces: Autopilot CTA + Bookmark reminder.
             Single exit point. One CTA. One destination.
             Command Center IS the loop. This page
             celebrates the win and funnels INTO it.
        ============================================ -->
        <div class="ecosystem-progress" id="ecosystemProgress">
            <div class="ecosystem-header">
                <div class="ecosystem-title">&#x1F3AF; Your Ecosystem Progress</div>
                <div class="ecosystem-level" id="ecoLevel">Level 1</div>
            </div>
            <div class="ecosystem-apps" id="ecoApps"></div>
            <p class="ecosystem-context">Your portfolio is built. <strong>Command Center</strong> tracks everything: your progress, your next unlock, and the tools that turn this plan into an automated machine.</p>
            <a href="https://spacekou5-oss.github.io/cashvault-funnel/command-center.html" class="btn btn-command" id="commandCenterBtn">
                <span>&#x1F3AF;</span> Open Command Center <span>&rarr;</span>
            </a>
        </div>

        <!-- Brokerage Explainer -->
        <div class="brokerage-explainer">
            <h3>&#x1F3E6; Wait, What's a Brokerage?</h3>
            <p class="explainer-text">
                A brokerage is just an app where you buy investments. Think of it like a <span class="explainer-highlight">bank account, but for stocks and ETFs</span>. You transfer money in, then use it to buy the ETFs in your portfolio above.
            </p>
            <div class="explainer-note">
                <strong>Important:</strong> This tool gave you the plan (which ETFs to buy and how much of each). A brokerage is where you actually buy them. You don't need a brokerage to use this app. You need one to execute the plan.
            </div>
            <p class="explainer-text" style="margin-bottom: 12px;">All three are free, charge $0 per trade, and take about 10 minutes to set up. The only real difference is which one fits your style:</p>
            <div class="brokerage-options">
                <a href="https://www.fidelity.com/open-account/overview" target="_blank" rel="noopener" class="brokerage-option recommended">
                    <div class="brokerage-option-rec">Most Popular With Beginners</div>
                    <div class="brokerage-option-name">Fidelity</div>
                    <div class="brokerage-option-cost">$0 to open</div>
                    <div class="brokerage-option-desc">Best app for beginners. Buy fractional shares starting at $1. Free learning center walks you through everything step by step.</div>
                    <div class="brokerage-option-best">Best if: You've never invested before</div>
                    <div class="brokerage-option-cta">Open Account &#x2197;</div>
                </a>
                <a href="https://www.schwab.com/open-an-account" target="_blank" rel="noopener" class="brokerage-option">
                    <div class="brokerage-option-name">Schwab</div>
                    <div class="brokerage-option-cost">$0 to open</div>
                    <div class="brokerage-option-desc">400+ physical branches if you want to talk to a real person. Best research tools in the industry. 24/7 phone and chat support.</div>
                    <div class="brokerage-option-best">Best if: You want in-person or phone help</div>
                    <div class="brokerage-option-cta">Open Account &#x2197;</div>
                </a>
                <a href="https://investor.vanguard.com/accounts-plans/individual-brokerage-account" target="_blank" rel="noopener" class="brokerage-option">
                    <div class="brokerage-option-name">Vanguard</div>
                    <div class="brokerage-option-cost">$0 to open</div>
                    <div class="brokerage-option-desc">The company that invented index funds. Lowest fees in the game. No-frills platform built for people who buy and hold forever.</div>
                    <div class="brokerage-option-best">Best if: You want the absolute lowest cost</div>
                    <div class="brokerage-option-cta">Open Account &#x2197;</div>
                </a>
            </div>
        </div>

        <!-- Next Steps -->
        <div class="next-steps">
            <h3>&#x1F3AF; Your Exact Next 3 Steps</h3>
            <div class="steps-list" id="steps-list">
                <div class="step-item">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Open a Free Brokerage Account</h4>
                        <p>Go to Fidelity.com, Schwab.com, or Vanguard.com. Click "Open an Account." Pick "Individual Brokerage Account." Fill in your name, address, and Social Security number. That's it.</p>
                        <div class="step-detail">No fees. No minimum balance. No catches. It's like signing up for any other app, but for investing.</div>
                        <div class="step-time">&#x23F1; ~10 minutes</div>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Buy Your ETFs</h4>
                        <p id="step2-text">Transfer money into your new account. Then search for each ticker symbol (the 3-4 letter code like VTI or SCHD), enter the dollar amount, and hit "Buy."</p>
                        <div class="step-detail" id="step2-detail">Loading your exact buy list...</div>
                        <div class="step-time">&#x23F1; ~5 minutes per ETF</div>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4 id="step3-title">Set Up Automatic Monthly Buys</h4>
                        <p id="step3-text">In your brokerage, look for "Recurring Investments" or "Automatic Investments." Set each ETF to buy automatically every month on the same day (like payday). Now your portfolio grows on autopilot.</p>
                        <div class="step-detail">This is the most important step. Automating removes the #1 reason people fail at investing: forgetting to do it.</div>
                        <div class="step-time">&#x23F1; ~5 minutes</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            Built by <a href="https://instagram.com/koutalksmoney" target="_blank">@koutalksmoney</a> &bull; Systems over willpower.<br>
            Not financial advice. Research before investing.
        </div>
    </div>

    <!-- Error State -->
    <div class="container error-state" id="error-state" style="display: none;">
        <h2>Portfolio Not Found</h2>
        <p>It looks like your portfolio data expired or wasn't saved properly.</p>
        <a href="https://spacekou5-oss.github.io/cashvault-funnel/Investment-Simplifier.html" class="btn btn-primary">Build New Portfolio</a>
    </div>

    <script>
        // =========================================
        // CONFIGURATION
        // =========================================
        var STORAGE_KEY = 'investmentSimplifier_portfolio';
        var COMMAND_CENTER_URL = 'https://spacekou5-oss.github.io/cashvault-funnel/command-center.html';

        var styleLabels = { growth: '\u{1F680} Growth', balanced: '\u2696\uFE0F Balanced', income: '\u{1F6E1}\uFE0F Income' };
        var styleDescriptions = {
            growth: {
                summary: 'Your portfolio is built for maximum long-term growth. It leans heavily into stocks because you have time on your side. The strategy accepts more ups and downs in the short term in exchange for higher projected returns over decades.',
                riskLevel: 'Higher volatility',
                timeHorizon: '10+ years',
                bestFor: 'Young investors with time'
            },
            balanced: {
                summary: 'Your portfolio splits between growth and stability. You get exposure to stock market gains while bonds act as a shock absorber during downturns. This is the "sleep well at night" strategy that still builds serious wealth.',
                riskLevel: 'Moderate volatility',
                timeHorizon: '7+ years',
                bestFor: 'Most investors'
            },
            income: {
                summary: 'Your portfolio prioritizes companies that pay regular dividends and bonds that generate steady income. You are trading some growth potential for more predictable cash flow hitting your account every quarter.',
                riskLevel: 'Lower volatility',
                timeHorizon: '5+ years',
                bestFor: 'Cash flow seekers'
            }
        };

        var etfMeta = {
            'VTI': { expense: '0.03%', type: 'Total Market' },
            'VOO': { expense: '0.03%', type: 'S&P 500' },
            'VXUS': { expense: '0.07%', type: 'International' },
            'BND': { expense: '0.03%', type: 'Bonds' },
            'SCHD': { expense: '0.06%', type: 'Dividends' },
            'SCHG': { expense: '0.04%', type: 'Growth' },
            'QQQM': { expense: '0.15%', type: 'Tech/Growth' },
            'AVUV': { expense: '0.25%', type: 'Small Cap' },
            'VYM': { expense: '0.06%', type: 'High Yield' },
            'DGRO': { expense: '0.08%', type: 'Div Growth' },
            'SGOV': { expense: '0.05%', type: 'Treasury' },
            'VGT': { expense: '0.10%', type: 'Tech Sector' },
            'VT': { expense: '0.07%', type: 'Global' }
        };

        // =========================================
        // Ecosystem apps for progress display.
        // Reads localStorage flags set by each app.
        // Mirrors Command Center's flag system.
        // =========================================
        var ECOSYSTEM_APPS = [
            { name: 'Freedom Number', icon: '\u{1F9E0}', flag: 'freedom_email' },
            { name: 'Cost of Waiting', icon: '\u23F3', flag: 'cost_of_waiting_email' },
            { name: 'Investment Plan', icon: '\u{1F4C8}', flag: 'investment_completed' },
            { name: 'Autopilot', icon: '\u{1F916}', flag: 'autopilot_completed' },
            { name: '800 Club', icon: '\u{1F3C6}', flag: '800club_completed' },
            { name: 'Budget Calc', icon: '\u{1F4B0}', flag: 'budget_completed' }
        ];

        // =========================================
        // UTILITIES
        // =========================================
        function formatCurrency(num) {
            if (num >= 1000000) return '$' + (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return '$' + Math.round(num).toLocaleString();
            return '$' + num.toLocaleString();
        }

        function loadPortfolioData() {
            // Priority: URL params > cookie > localStorage
            var params = new URLSearchParams(window.location.search);
            if (params.has('data')) {
                try {
                    var decoded = JSON.parse(decodeURIComponent(params.get('data')));
                    if (decoded && decoded.etfs) return decoded;
                } catch(e) {}
            }
            try {
                var cookies = document.cookie.split(';');
                for (var c = 0; c < cookies.length; c++) {
                    var parts = cookies[c].trim().split('=');
                    if (parts[0] === 'isPortfolio') {
                        var cookieDecoded = JSON.parse(decodeURIComponent(parts[1]));
                        if (cookieDecoded && cookieDecoded.etfs) return cookieDecoded;
                    }
                }
            } catch(e) {}
            var stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    var parsed = JSON.parse(stored);
                    if (parsed && parsed.etfs) return parsed;
                } catch(e) {}
            }
            return null;
        }

        // =========================================
        // NEW USER DETECTION
        // A user is "new" if they have NOT previously
        // visited the bridge page. Flag set after first
        // theater completes. Returning users skip theater.
        // =========================================
        function isNewUser() {
            return localStorage.getItem('bridge_investment_visited') !== 'true';
        }

        // =========================================
        // PROCESSING THEATER (new users only)
        // 5-step loading sequence that reframes
        // the email signup as valuable. Each step
        // reveals what they unlocked. Uses:
        // - Idleness Aversion (fake loading builds value)
        // - Operational Transparency (show the work)
        // - Goal Gradient (progress starts at 15%)
        // =========================================
        function runProcessingTheater(portfolio, callback) {
            var theater = document.getElementById('processingTheater');
            var titleEl = document.getElementById('theaterTitle');
            var stepEl = document.getElementById('theaterStep');
            var progressFill = document.getElementById('theaterProgressFill');
            var pctEl = document.getElementById('theaterPct');
            var valueFrame = document.getElementById('theaterValueFrame');
            var valueText = document.getElementById('theaterValueText');

            // Hide main content during theater
            document.getElementById('main-content').style.opacity = '0';
            theater.classList.remove('hidden');

            var proj30 = formatCurrency(portfolio.projections.year30);
            var multiplier = (portfolio.projections.year30 / 87000).toFixed(1);
            var monthly = (portfolio.monthlyInvestment || 500).toLocaleString();

            var steps = [
                {
                    title: 'Email verified.',
                    step: 'Connecting to your portfolio data...',
                    pct: 25,
                    value: null
                },
                {
                    title: 'Portfolio found.',
                    step: 'Loading ' + portfolio.etfs.length + ' ETFs with exact allocations...',
                    pct: 45,
                    value: 'Your personalized buy list with exact tickers, percentages, and dollar amounts per ETF.'
                },
                {
                    title: 'Running projections...',
                    step: 'Modeling compound growth at $' + monthly + '/month...',
                    pct: 70,
                    value: '30-year projection: ' + proj30 + ' (' + multiplier + 'x the average American retirement).'
                },
                {
                    title: 'Building your share card...',
                    step: 'Generating screenshot-ready portfolio card...',
                    pct: 90,
                    value: 'Share card, brokerage guide, and step-by-step buy instructions included.'
                },
                {
                    title: 'Everything unlocked.',
                    step: 'Preparing your results...',
                    pct: 100,
                    value: null
                }
            ];

            var i = 0;
            var interval = setInterval(function() {
                if (i < steps.length) {
                    titleEl.textContent = steps[i].title;
                    stepEl.textContent = steps[i].step;
                    progressFill.style.width = steps[i].pct + '%';
                    pctEl.textContent = steps[i].pct + '%';
                    if (steps[i].value) {
                        valueText.textContent = steps[i].value;
                        valueFrame.classList.add('show');
                    } else {
                        valueFrame.classList.remove('show');
                    }
                    i++;
                } else {
                    clearInterval(interval);
                    setTimeout(function() {
                        theater.classList.add('hidden');
                        document.getElementById('main-content').style.opacity = '1';
                        document.getElementById('main-content').style.transition = 'opacity 0.5s ease';
                        callback();
                    }, 400);
                }
            }, 950);
        }

        // =========================================
        // UPSTREAM PERSONALIZATION
        // Detects Freedom Calculator or Cost of Waiting
        // users via localStorage flags. Swaps header
        // copy to acknowledge their journey. Read-only.
        // =========================================
        function personalizeForUpstream() {
            var fromFreedom = false;
            var fromCostOfWaiting = false;
            try { fromFreedom = localStorage.getItem('freedom_email') === 'true'; } catch(e) {}
            try { fromCostOfWaiting = localStorage.getItem('cost_of_waiting_email') === 'true'; } catch(e) {}
            if (!fromFreedom && !fromCostOfWaiting) return;

            var badge = document.getElementById('upstreamBadge');
            var headline = document.getElementById('bridgeHeadline');
            var subline = document.getElementById('bridgeSubline');
            var reinforcement = document.getElementById('reinforcement-text');

            if (fromFreedom) {
                if (badge) { badge.style.display = 'block'; badge.textContent = 'Phase 2 Complete \u2022 Freedom Number + Portfolio Built'; }
                if (headline) { headline.textContent = 'Freedom Number Mapped. Portfolio Built.'; }
                if (subline) { subline.textContent = 'You calculated the destination. Now you have the vehicle. Both phases done.'; }
                if (reinforcement) { reinforcement.textContent = 'Most people guess. You calculated your Freedom Number AND built the portfolio to hit it.'; }
            } else if (fromCostOfWaiting) {
                if (badge) { badge.style.display = 'block'; badge.textContent = 'Phase 2 Complete \u2022 The Bleeding Stopped'; }
                if (headline) { headline.textContent = 'The Leak is Plugged. Portfolio Live.'; }
                if (subline) { subline.textContent = 'You saw what waiting costs. Now the money has somewhere to go. Both phases done.'; }
                if (reinforcement) { reinforcement.textContent = 'You stopped calculating the damage and started building the fix. That is rare.'; }
            }
        }

        // =========================================
        // ECOSYSTEM PROGRESS
        // Reads localStorage flags from all apps.
        // Calculates Architect Level. Shows Command
        // Center as the sole destination.
        // =========================================
        function renderEcosystemProgress() {
            var container = document.getElementById('ecoApps');
            var completedCount = 0;

            for (var a = 0; a < ECOSYSTEM_APPS.length; a++) {
                var app = ECOSYSTEM_APPS[a];
                var isCompleted = false;
                try { isCompleted = localStorage.getItem(app.flag) === 'true'; } catch(e) {}
                if (isCompleted) completedCount++;

                var div = document.createElement('div');
                div.className = 'eco-app ' + (isCompleted ? 'completed' : 'locked');
                div.innerHTML =
                    '<span class="eco-app-icon">' + (isCompleted ? '\u2705' : app.icon) + '</span>' +
                    '<span class="eco-app-name">' + app.name + '</span>' +
                    '<span class="eco-app-status">' + (isCompleted ? 'Completed' : 'Locked') + '</span>';
                container.appendChild(div);
            }

            // Architect Level based on completions
            var levelEl = document.getElementById('ecoLevel');
            if (completedCount >= 5) levelEl.textContent = 'Level 5 \u2022 Architect';
            else if (completedCount >= 4) levelEl.textContent = 'Level 4 \u2022 Builder';
            else if (completedCount >= 3) levelEl.textContent = 'Level 3 \u2022 Strategist';
            else if (completedCount >= 2) levelEl.textContent = 'Level 2 \u2022 Planner';
            else levelEl.textContent = 'Level 1 \u2022 Starter';
        }

        // =========================================
        // MAIN LOAD ORCHESTRATOR
        // New users: Processing Theater -> Render -> Confetti
        // Returning users: Render immediately (no theater, no confetti)
        // =========================================
        function loadPortfolio() {
            var portfolio = loadPortfolioData();
            if (!portfolio) { showError(); return; }

            // Set email bridge flag (signals Investment Simplifier that email was captured)
            localStorage.setItem('investmentSimplifier_bridge_email', 'true');

            var newUser = isNewUser();

            if (newUser) {
                // NEW USER: Processing Theater, then render, then confetti
                runProcessingTheater(portfolio, function() {
                    personalizeForUpstream();
                    renderPortfolio(portfolio);
                    renderEcosystemProgress();
                    // Mark as visited so they skip theater on return
                    localStorage.setItem('bridge_investment_visited', 'true');
                    setTimeout(function() {
                        animateCountUp('proj-30', portfolio.projections.year30);
                        setTimeout(function() { triggerConfetti(); }, 1500);
                    }, 400);
                });
            } else {
                // RETURNING USER: Skip theater, render immediately, no confetti
                personalizeForUpstream();
                renderPortfolio(portfolio);
                renderEcosystemProgress();
                setTimeout(function() {
                    animateCountUp('proj-30', portfolio.projections.year30);
                }, 400);
            }
        }

        // =========================================
        // RENDER PORTFOLIO
        // =========================================
        function renderPortfolio(p) {
            document.getElementById('display-age').textContent = p.age;
            document.getElementById('display-style').textContent = styleLabels[p.style] || p.style;
            document.getElementById('display-id').textContent = 'ID: ' + p.portfolioId;
            document.getElementById('display-stocks').textContent = p.stockPercent + '%';
            document.getElementById('display-bonds').textContent = p.bondPercent + '%';
            document.getElementById('display-monthly').textContent = p.monthlyInvestment ? p.monthlyInvestment.toLocaleString() : '500';

            document.getElementById('proj-10').textContent = formatCurrency(p.projections.year10);
            document.getElementById('proj-20').textContent = formatCurrency(p.projections.year20);

            var multiplier = (p.projections.year30 / 87000).toFixed(1);
            document.getElementById('comp-you').textContent = formatCurrency(p.projections.year30);
            document.getElementById('comp-multiplier').textContent = multiplier + 'x ahead of the pack';

            var reinforcementSub = document.getElementById('reinforcement-sub');
            if (p.age && p.age < 30) {
                reinforcementSub.textContent = 'The average American has $0 invested at ' + p.age + '. You\'re now ahead of 80% of your generation.';
            } else {
                reinforcementSub.textContent = 'Most people never build a portfolio. You just did it in 60 seconds.';
            }

            renderStrategyExplainer(p);

            // Share card data
            document.getElementById('share-value').textContent = formatCurrency(p.projections.year30);
            document.getElementById('share-comparison').textContent = multiplier + 'x ahead of the average American';
            document.getElementById('share-stocks').textContent = p.stockPercent + '%';
            document.getElementById('share-bonds').textContent = p.bondPercent + '%';
            document.getElementById('share-id').textContent = 'ID: ' + p.portfolioId;

            // ETF grid
            var etfGrid = document.getElementById('etf-grid');
            etfGrid.innerHTML = '';
            for (var i = 0; i < p.etfs.length; i++) {
                var etf = p.etfs[i];
                var meta = etfMeta[etf.ticker] || { expense: 'N/A', type: 'Fund' };
                var card = document.createElement('div');
                card.className = 'etf-card ' + etf.type;
                card.innerHTML =
                    '<div class="etf-info">' +
                        '<span class="etf-ticker">' + etf.ticker + '</span>' +
                        '<span class="etf-name">' + etf.name + '</span>' +
                        (etf.description ? '<span class="etf-desc">' + etf.description + '</span>' : '') +
                        '<div class="etf-meta">' +
                            '<span class="etf-meta-tag expense">' + meta.expense + ' fee</span>' +
                            '<span class="etf-meta-tag type">' + meta.type + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div><span class="etf-percent">' + etf.percent + '%</span></div>';
                etfGrid.appendChild(card);
            }

            renderPersonalizedSteps(p);
            startCostTicker(p.projections.year30);
        }

        function renderStrategyExplainer(p) {
            var desc = styleDescriptions[p.style] || styleDescriptions.balanced;
            document.getElementById('strategyExplainerText').textContent = desc.summary;
            var details = document.getElementById('strategyDetails');
            details.innerHTML =
                '<div class="strategy-detail-item"><div class="strategy-detail-label">Risk Level</div><div class="strategy-detail-value">' + desc.riskLevel + '</div></div>' +
                '<div class="strategy-detail-item"><div class="strategy-detail-label">Best Held For</div><div class="strategy-detail-value">' + desc.timeHorizon + '</div></div>' +
                '<div class="strategy-detail-item"><div class="strategy-detail-label">Best For</div><div class="strategy-detail-value">' + desc.bestFor + '</div></div>';
        }

        function renderPersonalizedSteps(p) {
            var lumpSum = 1000;
            var step2Detail = '';
            for (var i = 0; i < p.etfs.length; i++) {
                var etf = p.etfs[i];
                var amount = Math.round(lumpSum * etf.percent / 100);
                step2Detail += '<span class="step-etf-detail">' + etf.ticker + '</span> \u2192 Search "' + etf.ticker + '" in your brokerage, buy $' + amount.toLocaleString() + ' worth (that\'s ' + etf.percent + '% of $' + lumpSum.toLocaleString() + ')';
                if (i < p.etfs.length - 1) step2Detail += '<br><br>';
            }
            document.getElementById('step2-detail').innerHTML = '<strong>Your exact buy list with $' + lumpSum.toLocaleString() + ' to start:</strong><br><br>' + step2Detail;

            var monthly = p.monthlyInvestment || 500;
            document.getElementById('step3-title').textContent = 'Set Up Automatic $' + monthly.toLocaleString() + '/Month Buys';
            document.getElementById('step3-text').textContent = 'In your brokerage, look for "Recurring Investments" or "Automatic Investments." Set each ETF to buy automatically every month on the same day (like payday). Your $' + monthly.toLocaleString() + '/month gets split across your ETFs based on the percentages above.';
        }

        // =========================================
        // ANIMATIONS + TICKERS
        // =========================================
        function animateCountUp(elementId, target) {
            var el = document.getElementById(elementId);
            var duration = 1500;
            var start = performance.now();
            function update(now) {
                var elapsed = now - start;
                var progress = Math.min(elapsed / duration, 1);
                var eased = 1 - Math.pow(1 - progress, 3);
                el.textContent = formatCurrency(Math.round(target * eased));
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        function startCostTicker(projectedValue) {
            var dailyCost = projectedValue / (30 * 365);
            var costPerMs = dailyCost / 86400000;
            var el = document.getElementById('costTickerValue');
            var startTime = performance.now();
            function tick(now) {
                var elapsed = now - startTime;
                var accumulated = elapsed * costPerMs;
                el.textContent = '$' + accumulated.toFixed(2);
                requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        }

        // =========================================
        // SHARE FUNCTIONS
        // =========================================
        function copyCaption() {
            var data = loadPortfolioData();
            if (!data) return;
            var multiplier = (data.projections.year30 / 87000).toFixed(1);
            var caption = 'I just found out I could be ' + multiplier + 'x richer than the average American by retirement.\n\nBuilt my portfolio in 60 seconds. What\'s your number?\n\n' + data.stockPercent + '% Stocks / ' + data.bondPercent + '% Bonds\n30-Year Projection: ' + formatCurrency(data.projections.year30) + '\n\nBuild yours free \u2193\n@koutalksmoney\n\n#moneytok #investingforbeginners #etfportfolio #buildwealth #financialliteracy';
            navigator.clipboard.writeText(caption).then(function() {
                var btn = event.target.closest('.btn');
                var original = btn.innerHTML;
                btn.innerHTML = '<span>\u2713</span> Copied!';
                setTimeout(function() { btn.innerHTML = original; }, 2000);
            });
        }

        function downloadCard() {
            var shareCard = document.getElementById('share-card-inner');
            if (!shareCard) return;
            var btn = event.target.closest('.btn');
            var original = btn.innerHTML;
            btn.innerHTML = '<span>\u23F3</span> Generating...';
            html2canvas(shareCard, {
                backgroundColor: '#0f1629',
                scale: 2,
                useCORS: true,
                logging: false
            }).then(function(canvas) {
                var link = document.createElement('a');
                link.download = 'my-portfolio-koutalksmoney.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                btn.innerHTML = '<span>\u2713</span> Downloaded!';
                setTimeout(function() { btn.innerHTML = original; }, 2000);
            }).catch(function() {
                btn.innerHTML = original;
                alert('Long-press the share card above to screenshot, then post to your story and tag @koutalksmoney');
            });
        }

        // =========================================
        // CONFETTI (new users only)
        // =========================================
        function triggerConfetti() {
            var canvas = document.getElementById('confetti-canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            var particles = [];
            var colors = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899'];
            for (var i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    size: Math.random() * 8 + 4,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * Math.PI * 2,
                    spin: (Math.random() - 0.5) * 0.2
                });
            }
            var frame = 0;
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (var j = 0; j < particles.length; j++) {
                    var p = particles[j];
                    p.y += p.speed;
                    p.x += Math.sin(p.angle) * 0.5;
                    p.angle += p.spin;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.angle);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    ctx.restore();
                }
                frame++;
                if (frame < 180) requestAnimationFrame(animate);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            animate();
        }

        // =========================================
        // ERROR STATE
        // =========================================
        function showError() {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
        }

        // =========================================
        // INIT
        // =========================================
        document.addEventListener('DOMContentLoaded', loadPortfolio);
    </script>
</body>
</html>
