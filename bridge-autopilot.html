<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autopilot | Saving Your System...</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #0a0a0a;
            color: #e5e5e5;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            text-align: center;
            padding: 40px 20px;
            max-width: 500px;
        }
        .spinner {
            width: 48px; height: 48px;
            border: 3px solid #333;
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status { color: #22c55e; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px; }
        .message { color: #888; font-size: 12px; margin-bottom: 24px; }
        .progress-bar { width: 200px; height: 4px; background: #222; border-radius: 2px; margin: 0 auto 16px; overflow: hidden; }
        .progress-fill { height: 100%; background: #22c55e; border-radius: 2px; transition: width 0.3s; width: 0%; }
        .error { color: #ef4444; font-size: 12px; margin-top: 16px; display: none; }
        .error a { color: #22c55e; text-decoration: underline; }
        .manual-link { margin-top: 20px; display: none; }
        .manual-link a { color: #22c55e; font-size: 12px; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <div class="status" id="status">SYSTEM SAVED</div>
        <div class="message" id="message">Generating your Architect Certificate...</div>
        <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
        <div class="error" id="error">
            Something went wrong. <a href="https://spacekou5-oss.github.io/cashvault-funnel/autopilot-system.html">Return to Autopilot</a>
        </div>
        <div class="manual-link" id="manualLink">
            <a href="https://spacekou5-oss.github.io/cashvault-funnel/autopilot-system.html">Go to your certificate</a>
        </div>
    </div>

    <script>
        // ============================================================
        // BRIDGE-AUTOPILOT: Recovery page after Beehiiv email capture
        // 
        // Problem: Beehiiv iframe doesn't reliably fire postMessage 
        // back to the parent app. So completeGate() never runs, and
        // the user has no Architect ID when they land here.
        //
        // Solution: Auto-generate the Architect ID from localStorage
        // data (userName), set all required flags, then redirect back
        // to the main autopilot app which will show Module 6 (cert).
        // ============================================================

        const AUTOPILOT_URL = 'https://spacekou5-oss.github.io/cashvault-funnel/autopilot-system.html';

        function generateIdFromName(name) {
            const email = name + '@architect.system';
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            const n = email.toLowerCase().trim();
            let h1 = 0, h2 = 5381;
            for (let i = 0; i < n.length; i++) {
                const c = n.charCodeAt(i);
                h1 = ((h1 << 5) - h1) + c;
                h1 = h1 & h1;
                h2 = ((h2 << 5) + h2) + c;
            }
            const combined = Math.abs(h1) + Math.abs(h2);
            let id = 'KOU-';
            let wh = combined;
            for (let i = 0; i < 6; i++) {
                const ci = (wh + (n.charCodeAt(i % n.length) * (i + 1))) % chars.length;
                id += chars.charAt(Math.abs(ci));
                wh = Math.floor(wh / 7) + ci;
            }
            return id;
        }

        function setProgress(pct) {
            document.getElementById('progress').style.width = pct + '%';
        }

        function setStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function setMessage(text) {
            document.getElementById('message').textContent = text;
        }

        function showError() {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }

        function showManualLink() {
            document.getElementById('manualLink').style.display = 'block';
        }

        (function run() {
            try {
                setProgress(20);
                setMessage('Reading your system data...');

                // Step 1: Check if Architect ID already exists
                let architectId = localStorage.getItem('cashvault_architect_id');
                
                // Step 2: If no ID, auto-generate from stored data
                if (!architectId) {
                    setProgress(40);
                    setMessage('Generating your Architect ID...');

                    // Try to get userName from stored system data
                    let userName = '';
                    const savedData = localStorage.getItem('autopilot_system_data');
                    if (savedData) {
                        try {
                            const parsed = JSON.parse(savedData);
                            userName = parsed.userName || '';
                        } catch(e) {}
                    }

                    // Fallback: check URL hash for name parameter
                    if (!userName) {
                        try {
                            const hash = window.location.hash.slice(1);
                            const params = new URLSearchParams(hash);
                            userName = params.get('n') || '';
                        } catch(e) {}
                    }

                    // Last resort: generate from timestamp
                    if (!userName) {
                        userName = 'architect_' + Date.now();
                    }

                    // Generate the ID (same algorithm as main app)
                    architectId = generateIdFromName(userName);
                }

                setProgress(60);
                setMessage('Setting up your certificate...');

                // Step 3: Set ALL required localStorage flags
                // These are the same flags that completeGate() sets
                localStorage.setItem('autopilot_email_captured', 'true');
                localStorage.setItem('cashvault_architect_id', architectId);
                localStorage.setItem('autopilot_completed', 'true');
                localStorage.setItem('command_center_architect_id', architectId);

                // Preserve ETF choice if it exists in system data
                const savedData = localStorage.getItem('autopilot_system_data');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.etfChoice) {
                            localStorage.setItem('autopilot_etf_choice', JSON.stringify(parsed.etfChoice));
                        }
                        // Calculate and store monthly invest
                        if (parsed.income && parsed.bills) {
                            const deployable = Math.max(0, parsed.income - parsed.bills);
                            const investAmount = deployable * 0.20;
                            localStorage.setItem('architect_monthly_invest', Math.round(investAmount).toString());
                        }
                    } catch(e) {}
                }

                setProgress(80);
                setMessage('Finalizing...');

                // Step 4: Also signal the parent app via cross-tab storage event
                // (In case the main app is still open in another tab)
                // Writing to localStorage triggers the 'storage' event in other tabs

                // Step 5: Try to notify parent window (if opened in iframe/popup)
                try {
                    if (window.opener) {
                        window.opener.postMessage({ type: 'AUTOPILOT_EMAIL_CAPTURED', verified: true }, '*');
                    }
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({ type: 'AUTOPILOT_EMAIL_CAPTURED', verified: true }, '*');
                    }
                } catch(e) {}

                setProgress(100);
                setStatus('CERTIFICATE READY');
                setMessage('Redirecting to your certificate...');

                // Step 6: Redirect back to the main app (lands on Module 6)
                setTimeout(function() {
                    window.location.href = AUTOPILOT_URL;
                }, 1500);

                // Fallback: show manual link if redirect doesn't work
                setTimeout(function() {
                    showManualLink();
                }, 4000);

            } catch(e) {
                console.error('Bridge recovery failed:', e);
                showError();
            }
        })();
    </script>
</body>
</html>
