<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autopilot Elite | Your Certificate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <!-- IFRAME BREAKOUT + GUARDED STATE SET (OPT Bridge #7) -->
    <script>
        (function() {
            try { if (window.self !== window.top) { window.top.location.href = window.location.href; return; } } catch(e) {}
            // GUARD: Only set completion flags if user actually went through the funnel
            var hasData = localStorage.getItem('autopilot_system_data');
            var urlHasData = window.location.search.indexOf('aid=') > -1;
            if (hasData || urlHasData) {
                localStorage.setItem('autopilot_email_captured', 'true');
                localStorage.setItem('autopilot_completed', 'true');
                localStorage.setItem('autopilot_current_module', '6');
            }
            if (!localStorage.getItem('cashvault_architect_id')) {
                var p = new URLSearchParams(window.location.search);
                if (p.get('aid')) {
                    localStorage.setItem('cashvault_architect_id', p.get('aid'));
                    localStorage.setItem('command_center_architect_id', p.get('aid'));
                }
            }
        })();
    </script>
    
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'JetBrains Mono',monospace;background:#0a0a0a;color:#e5e5e5;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
        .card-font{font-family:'Share Tech Mono',monospace}
        .wrap{width:100%;max-width:420px;margin:0 auto}
        
        /* Animations */
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes certReveal{0%{opacity:0;transform:scale(.9) rotateX(10deg)}50%{box-shadow:0 0 60px rgba(255,255,255,.3),0 0 120px rgba(34,197,94,.2)}100%{opacity:1;transform:scale(1) rotateX(0);box-shadow:0 25px 50px -12px rgba(0,0,0,.8)}}
        @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.4)}50%{box-shadow:0 0 0 8px rgba(34,197,94,0)}}
        @keyframes shimmer{0%{background-position:-250% 0}100%{background-position:250% 0}}
        
        .fade-in{animation:fadeIn .5s ease-out both}
        .cert-reveal{animation:certReveal .8s cubic-bezier(.34,1.56,.64,1) both}
        .pulse-ring{animation:pulse 2s infinite}
        
        /* Certificate */
        .cert{position:relative;border-radius:12px;overflow:hidden;border:1px solid #333;margin-bottom:24px}
        .cert-bg{position:absolute;inset:0;background:linear-gradient(135deg,#1a1a1a,#000,#111);z-index:0}
        .cert-shimmer{position:absolute;inset:0;z-index:1;pointer-events:none;background:linear-gradient(105deg,transparent 20%,rgba(255,255,255,.08) 50%,transparent 80%);background-size:200% 100%;animation:shimmer 6s infinite linear}
        .cert-inner{position:relative;z-index:2;padding:24px;display:flex;flex-direction:column;justify-content:space-between;min-height:280px}
        .cert-header{display:flex;justify-content:space-between;align-items:flex-start}
        .cert-logo{display:flex;align-items:center;gap:8px}
        .cert-dot-wrap{width:32px;height:32px;border-radius:50%;border:2px solid var(--accent);display:flex;align-items:center;justify-content:center}
        .cert-dot{width:16px;height:16px;border-radius:50%;background:var(--accent)}
        .cert-badge{font-size:10px;color:#666;border:1px solid #444;padding:4px 8px;border-radius:4px}
        .cert-chip{width:48px;height:36px;background:linear-gradient(135deg,#fde68a,#f59e0b,#d97706);border-radius:6px;margin-bottom:12px;opacity:.9}
        .cert-wealth{font-family:'Share Tech Mono',monospace;font-size:20px;color:#d4d4d4;letter-spacing:.15em;text-shadow:0 1px 2px rgba(0,0,0,.8)}
        .cert-label{font-size:8px;color:#666;text-transform:uppercase;letter-spacing:.15em;margin-top:4px}
        .cert-footer{display:flex;justify-content:space-between;align-items:flex-end}
        .cert-name{font-family:'Share Tech Mono',monospace;color:#fff;font-weight:700;text-transform:uppercase;letter-spacing:.15em;font-size:14px;text-shadow:0 1px 2px rgba(0,0,0,.8)}
        .cert-since{font-size:8px;color:#666;margin-top:4px}
        .cert-verified{font-size:12px;font-weight:700;color:var(--accent)}

        /* Buttons */
        .btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px;border-radius:6px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;cursor:pointer;text-decoration:none;border:none;font-family:inherit;transition:all .2s}
        .btn:hover{transform:translateY(-2px)}
        .btn-primary{background:var(--accent);color:#000}
        .btn-outline{background:transparent;color:#888;border:1px solid #333}
        .btn-outline:hover{border-color:var(--accent);color:var(--accent)}
        .btn-outline.copied{background:var(--accent);color:#000;border-color:var(--accent)}
        .btn-ig{background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);color:#fff}
        .btn-x{background:#000;color:#fff;border:1px solid #333}
        .btn-li{background:#0077B5;color:#fff}
        .btn-download{background:transparent;color:var(--accent);border:2px solid var(--accent)}

        /* Layout helpers */
        .card{background:#111;border:1px solid #333;border-radius:6px;padding:16px;margin-bottom:16px}
        .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .text-center{text-align:center}
        .text-xs{font-size:10px}
        .text-sm{font-size:12px}
        .text-gray{color:#666}
        .text-white{color:#fff}
        .mt-2{margin-top:8px}
        .mt-4{margin-top:16px}
        .mb-2{margin-bottom:8px}
        .mb-4{margin-bottom:16px}
        .mb-6{margin-bottom:24px}
        .fw-bold{font-weight:700}
        .tracking{letter-spacing:.15em;text-transform:uppercase}
        .hidden{display:none}
        .border-accent{border:2px solid var(--accent)}

        /* Verify CTA */
        .verify-bar{background:linear-gradient(135deg,#111,#0a0a0a);border:2px solid var(--accent);border-radius:8px;padding:16px;margin-bottom:24px;display:flex;flex-direction:column;gap:12px;align-items:center}
        @media(min-width:480px){.verify-bar{flex-direction:row}}
        .verify-btns{display:flex;gap:8px;width:100%}
        @media(min-width:480px){.verify-btns{width:auto}}
        .verify-btns .btn{flex:1;padding:10px 20px;font-size:11px}

        /* Social proof */
        .proof-box{background:rgba(17,17,17,.6);border:1px solid #444;border-radius:6px;padding:16px;text-align:center;margin-bottom:24px}
        .proof-num{font-size:24px;font-weight:700;color:#fff;font-family:'JetBrains Mono',monospace}

        /* Next step cards */
        .next-card{display:block;background:#111;border:1px solid #333;padding:16px;border-radius:6px;text-decoration:none;transition:all .2s;margin-bottom:12px}
        .next-card:hover{border-color:#555}
        .next-card-inner{display:flex;justify-content:space-between;align-items:center}
        .next-card h4{color:#fff;font-size:13px;font-weight:700}
        .next-card p{color:#666;font-size:10px;margin-top:2px}
        .next-card .arrow{color:#555;font-size:16px}

        /* Confetti canvas */
        #confetti{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999}
        
        /* Recovery screen */
        .recovery{text-align:center;padding:40px 20px}
        .recovery input{background:#000;border:1px solid #333;color:#fff;padding:12px;width:100%;max-width:300px;font-family:inherit;font-size:14px;text-align:center;margin:16px 0;outline:none}
        .recovery input:focus{border-color:var(--accent)}
    </style>
</head>
<body>
    <div class="wrap" id="app"></div>
    <canvas id="confetti"></canvas>

    <script>
        // === CONFIG ===
        var ACCENT = '#22c55e';
        var LINKS = {
            INSTAGRAM: 'https://instagram.com/koutalksmoney',
            COMMAND_CENTER: 'https://spacekou5-oss.github.io/cashvault-funnel/command-center.html',
            INVESTMENT_SIMPLIFIER: 'https://spacekou5-oss.github.io/cashvault-funnel/Investment-Simplifier.html',
            VERIFY_BASE: 'https://spacekou5-oss.github.io/cashvault-funnel/verify.html',
            BUDGET_CALC: "https://spacekou5-oss.github.io/cashvault-funnel/Kou's-Budget-Calculator.html"
        };

        // Resolve theme from context
        (function() {
            try {
                var ctx = JSON.parse(localStorage.getItem('cashvault_context') || '{}');
                if (ctx.source === 'ticker') ACCENT = '#DC2626';
                else if (ctx.source === 'score') ACCENT = '#FACC15';
            } catch(e) {}
            document.documentElement.style.setProperty('--accent', ACCENT);
        })();

        // === COMPOUND INTEREST ===
        function calcFV(monthly, years) {
            var r = 0.10, n = 12;
            return monthly * ((Math.pow(1 + r/n, n * years) - 1) / (r/n));
        }

        // === DATA HYDRATION: URL first, localStorage second (OPT Bridge #2) ===
        function getData() {
            var p = new URLSearchParams(window.location.search);
            var result = { userName: 'AUTHORIZED USER', architectId: null, monthlyInvest: 0, etfTicker: '', projectedWealth: 0 };

            // PRIORITY 1: URL params
            if (p.get('aid')) {
                result.architectId = p.get('aid');
                result.userName = p.get('n') ? decodeURIComponent(p.get('n')) : result.userName;
                result.monthlyInvest = parseFloat(p.get('inv')) || 0;
                result.etfTicker = p.get('etf') || '';
                result.projectedWealth = parseFloat(p.get('w')) || (result.monthlyInvest > 0 ? calcFV(result.monthlyInvest, 30) : 0);
            }

            // PRIORITY 2: localStorage
            if (!result.architectId) result.architectId = localStorage.getItem('cashvault_architect_id');
            if (!result.architectId) return null; // No data at all

            if (result.monthlyInvest === 0) {
                var mi = parseFloat(localStorage.getItem('architect_monthly_invest'));
                if (mi > 0) result.monthlyInvest = mi;
            }
            if (!result.etfTicker) {
                try { var etf = JSON.parse(localStorage.getItem('autopilot_etf_choice') || '{}'); result.etfTicker = etf.ticker || ''; } catch(e) {}
            }
            if (result.userName === 'AUTHORIZED USER') {
                try { var sd = JSON.parse(localStorage.getItem('autopilot_system_data') || '{}'); if (sd.userName) result.userName = sd.userName; } catch(e) {}
            }
            if (result.monthlyInvest === 0) {
                try {
                    var sd2 = JSON.parse(localStorage.getItem('autopilot_system_data') || '{}');
                    var deploy = Math.max(0, (sd2.income || 0) - (sd2.bills || 0));
                    result.monthlyInvest = deploy * 0.20;
                } catch(e) {}
            }
            result.projectedWealth = result.projectedWealth || (result.monthlyInvest > 0 ? calcFV(result.monthlyInvest, 30) : 0);
            return result;
        }

        // === CONFETTI (lightweight vanilla) ===
        var confetti = {
            canvas: null, ctx: null, particles: [], running: false,
            init: function() { this.canvas = document.getElementById('confetti'); this.ctx = this.canvas.getContext('2d'); this.resize(); window.addEventListener('resize', this.resize.bind(this)); },
            resize: function() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
            launch: function() {
                if (this.running) return; this.running = true; this.particles = [];
                var self = this, start = Date.now(), colors = ['#22c55e','#16a34a','#fbbf24','#4ade80'];
                var si = setInterval(function() {
                    if (Date.now() - start > 1800) { clearInterval(si); return; }
                    for (var i = 0; i < 3 && self.particles.length < 25; i++) {
                        self.particles.push({ x: Math.random()*self.canvas.width, y: -20, c: colors[Math.floor(Math.random()*4)], s: Math.random()*14+12, vy: Math.random()*2.5+2, vx: (Math.random()-.5)*3, r: Math.random()*360, rs: (Math.random()-.5)*8, o: 1, w: Math.random()*10, ws: Math.random()*.08+.04 });
                    }
                }, 150);
                var animate = function() {
                    self.ctx.clearRect(0,0,self.canvas.width,self.canvas.height);
                    self.particles = self.particles.filter(function(p) {
                        p.y+=p.vy; p.x+=p.vx+Math.sin(p.w)*.5; p.r+=p.rs; p.w+=p.ws;
                        if(p.y>self.canvas.height-100) p.o-=.04;
                        if(p.o<=0) return false;
                        self.ctx.save(); self.ctx.translate(p.x,p.y); self.ctx.rotate(p.r*Math.PI/180); self.ctx.globalAlpha=p.o; self.ctx.fillStyle=p.c; self.ctx.font=p.s+'px Arial'; self.ctx.textAlign='center'; self.ctx.fillText('$',0,0); self.ctx.restore();
                        return true;
                    });
                    if(self.particles.length>0||Date.now()-start<3000) requestAnimationFrame(animate);
                    else { self.running=false; self.ctx.clearRect(0,0,self.canvas.width,self.canvas.height); }
                };
                animate();
            }
        };

        // === RENDER ===
        function render() {
            var data = getData();
            var app = document.getElementById('app');

            // RECOVERY SCREEN if no data
            if (!data) {
                app.innerHTML = '<div class="recovery fade-in"><h2 class="text-white fw-bold" style="font-size:18px;margin-bottom:8px">Certificate Not Found</h2><p class="text-gray mb-4" style="font-size:12px">We couldn\'t load your data. If you completed the Autopilot System, enter your Architect ID below.</p><input id="recovery-id" placeholder="KOU-XXXXXX" maxlength="10"><br><button class="btn btn-primary" style="max-width:300px;margin:0 auto" onclick="recoverById()">Load Certificate</button><p class="text-gray mt-4" style="font-size:11px">Don\'t have an ID? <a href="https://spacekou5-oss.github.io/cashvault-funnel/autopilot-system.html" style="color:'+ACCENT+'">Build your system first</a></p></div>';
                return;
            }

            var wealthStr = Math.round(data.projectedWealth).toLocaleString();
            var verifyUrl = LINKS.VERIFY_BASE + '?id=' + data.architectId + '&n=' + encodeURIComponent(data.userName) + '&inv=' + Math.round(data.monthlyInvest) + '&etf=' + data.etfTicker + '&w=' + Math.round(data.projectedWealth);
            var isHighValue = data.monthlyInvest >= 500;

            var captions = {
                INSTAGRAM: 'I just automated $' + Math.round(data.monthlyInvest) + '/mo into ' + (data.etfTicker || 'ETFs') + '. Projected value: $' + wealthStr + '. Built with @koutalksmoney',
                TWITTER: 'Just automated $' + Math.round(data.monthlyInvest) + '/mo into ' + (data.etfTicker || 'ETFs') + '.\n\nProjected: $' + wealthStr + ' in 30 years.\n\nVerify: ' + verifyUrl + '\n\n@koutalksmoney',
                LINKEDIN: 'I completed the Autopilot Money System. I now auto-invest $' + Math.round(data.monthlyInvest) + '/mo into ' + (data.etfTicker || 'diversified ETFs') + '. Verify: ' + verifyUrl + ' #PersonalFinance',
                TIKTOK: 'POV: You automated $' + Math.round(data.monthlyInvest) + '/mo into ' + (data.etfTicker || 'ETFs') + ' and your wealth is building itself. ' + verifyUrl + ' @koutalksmoney'
            };

            var linkedInCertUrl = 'https://www.linkedin.com/profile/add?startTask=CERTIFICATION_NAME&name=' + encodeURIComponent('Autopilot Money System') + '&organizationName=' + encodeURIComponent('Kou Talks Money') + '&certUrl=' + encodeURIComponent(verifyUrl) + '&certId=' + encodeURIComponent(data.architectId);
            var tweetUrl = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(captions.TWITTER);
            var liShareUrl = 'https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(verifyUrl);

            var html = '';

            // Download button
            html += '<div class="text-center mb-4 fade-in"><button id="download-btn" class="btn btn-download pulse-ring" style="max-width:320px;margin:0 auto;font-size:11px"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> DOWNLOAD HIGH-RES CERTIFICATE</button></div>';

            // Certificate card
            html += '<div id="cert-card" class="cert cert-reveal"><div class="cert-bg"></div><div class="cert-shimmer"></div><div class="cert-inner">';
            html += '<div class="cert-header"><div class="cert-logo"><div class="cert-dot-wrap"><div class="cert-dot"></div></div><span class="fw-bold text-white" style="letter-spacing:.15em;font-size:13px">AUTOPILOT<span style="color:'+ACCENT+'">ELITE</span></span></div><span class="cert-badge">WEALTH ARCHITECT</span></div>';
            html += '<div><div class="mb-2"><p class="cert-label">Architect ID</p><p style="color:'+ACCENT+';font-family:JetBrains Mono;font-size:18px;font-weight:700;letter-spacing:.15em">'+data.architectId+'</p></div>';
            html += '<div class="cert-chip"></div>';
            html += '<div class="cert-wealth" id="wealth-counter">$0</div>';
            html += '<div class="cert-label">Projected Net Worth (30yr)</div></div>';
            html += '<div class="cert-footer"><div><p class="cert-name">'+data.userName+'</p><p class="cert-since">MEMBER SINCE '+new Date().getFullYear()+'</p></div><div style="color:'+ACCENT+';font-size:12px;font-weight:700">\u2713 VERIFIED</div></div>';
            html += '</div></div>';

            // Verify bar
            html += '<div class="verify-bar fade-in" style="animation-delay:.2s"><div style="flex:1;text-align:center"><p class="text-white fw-bold text-sm">Your Verification Page is Live</p><p class="text-gray text-xs mt-2">Drop this link in your bio, resume, or DMs.</p></div><div class="verify-btns"><a href="'+verifyUrl+'" target="_blank" class="btn btn-primary" style="font-size:11px">View Page</a><button class="btn btn-outline" style="font-size:11px" onclick="copyText(\''+verifyUrl+'\',this)">Copy Link</button></div></div>';

            // Social proof
            html += '<div class="proof-box fade-in" style="animation-delay:.3s"><p class="text-gray text-xs fw-bold tracking mb-2">Your Position</p><p class="proof-num" id="proof-count">Architect #...</p><p class="text-gray text-xs mt-2" id="proof-total"></p></div>';

            // Next steps (OPT #9)
            html += '<div class="fade-in mb-6" style="animation-delay:.4s"><p class="text-gray text-xs tracking text-center mb-4">What\'s Next</p>';
            html += '<a href="'+LINKS.COMMAND_CENTER+'" class="next-card"><div class="next-card-inner"><div><h4>Command Center</h4><p>Track your system. Monitor your progress.</p></div><span class="arrow">\u2192</span></div></a>';
            html += '<a href="'+LINKS.INVESTMENT_SIMPLIFIER+'" class="next-card"><div class="next-card-inner"><div><h4>Investment Simplifier</h4><p>Build a custom portfolio beyond a single ETF.</p></div><span class="arrow">\u2192</span></div></a></div>';

            // LinkedIn certification
            html += '<a href="'+linkedInCertUrl+'" target="_blank" class="btn btn-li mb-6 fade-in" style="animation-delay:.5s">Add to LinkedIn Profile</a>';

            // Claim section
            html += '<div class="card fade-in" style="animation-delay:.6s;position:relative;overflow:hidden"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:'+ACCENT+'"></div>';
            html += '<h3 class="text-white fw-bold text-center" style="font-size:16px;margin-bottom:4px">UNLOCK THE PROMPT VAULT</h3><p class="text-gray text-xs text-center mb-6">Choose your path.</p>';

            // Path A
            html += '<div style="background:#000;border:1px solid #333;border-radius:6px;overflow:hidden;margin-bottom:12px"><div style="padding:12px 16px;border-bottom:1px solid #333;background:rgba(255,255,255,.02);display:flex;justify-content:space-between;align-items:center"><span class="text-gray text-xs fw-bold tracking">Path A: Quick Claim</span><span class="text-gray text-xs" style="border:1px solid #444;padding:2px 8px;border-radius:4px">1 REWARD</span></div><div style="padding:16px"><div style="display:flex;gap:12px;align-items:flex-start"><div style="width:28px;height:28px;border-radius:50%;background:#666;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#000;flex-shrink:0">1</div><div><p class="text-white fw-bold text-sm">DM "ARCHITECT" to <span style="color:'+ACCENT+'">@koutalksmoney</span></p><p class="text-gray" style="font-size:11px;margin-top:4px">Instant delivery. ManyChat replies in seconds.</p></div></div><div style="margin-top:12px;margin-left:40px;display:flex;align-items:center;gap:8px"><span class="text-gray text-xs">You get:</span><span class="text-white fw-bold text-xs" style="background:#222;padding:2px 8px;border-radius:4px">Prompt Vault Cheat Sheet</span></div></div></div>';

            // Path B
            html += '<div style="border-radius:6px;border:2px solid '+ACCENT+';overflow:hidden;position:relative;margin-bottom:16px"><div style="position:absolute;top:0;right:0;padding:2px 8px;font-size:9px;font-weight:700;color:#000;background:'+ACCENT+';text-transform:uppercase;letter-spacing:.05em">Recommended</div><div style="padding:12px 16px;border-bottom:1px solid #333;background:rgba(255,255,255,.02);display:flex;justify-content:space-between;align-items:center"><span class="fw-bold text-xs tracking" style="color:'+ACCENT+'">Path B: Full Unlock</span><span class="fw-bold text-xs" style="color:'+ACCENT+';border:1px solid '+ACCENT+';padding:2px 8px;border-radius:4px">2 REWARDS</span></div><div style="padding:16px">';
            var steps = [
                {n:1, t:'Download your certificate (button above)', s:'Or screenshot it. Both work.'},
                {n:2, t:'Post it to your story and tag <span style="color:'+ACCENT+'">@koutalksmoney</span>', s:'Any platform works.'},
                {n:3, t:'DM "ARCHITECT" to <span style="color:'+ACCENT+'">@koutalksmoney</span>', s:'Mention you posted. Both rewards delivered instantly.'}
            ];
            for (var i = 0; i < steps.length; i++) {
                html += '<div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:12px"><div style="width:28px;height:28px;border-radius:50%;background:'+ACCENT+';display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#000;flex-shrink:0">'+steps[i].n+'</div><div><p class="text-white fw-bold text-sm">'+steps[i].t+'</p><p class="text-gray" style="font-size:11px">'+steps[i].s+'</p></div></div>';
            }
            html += '<div style="margin-left:40px;display:flex;flex-wrap:wrap;align-items:center;gap:8px"><span class="text-gray text-xs">You get:</span><span class="text-white fw-bold text-xs" style="background:#222;padding:2px 8px;border-radius:4px">Prompt Vault Cheat Sheet</span><span class="text-gray text-xs">+</span><span class="fw-bold text-xs" style="color:'+ACCENT+';background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.25);padding:2px 8px;border-radius:4px">Budget Calculator Secret Code</span></div>';
            html += '</div></div>';

            // Tiered upsell
            if (isHighValue) {
                html += '<div style="border-top:1px solid #333;padding-top:16px;margin-bottom:16px"><div style="background:#000;border:1px solid rgba(250,204,21,.3);border-radius:6px;padding:16px;text-align:center"><p style="color:#facc15;font-size:10px;text-transform:uppercase;letter-spacing:.15em;font-weight:700;margin-bottom:4px">High-Value Architect Detected</p><p class="text-white fw-bold text-sm mb-2">Want a personalized portfolio review?</p><p class="text-gray text-xs mb-4">You\'re investing $'+Math.round(data.monthlyInvest)+'/mo. Get a 1-on-1 strategy session.</p><a href="'+LINKS.INSTAGRAM+'" target="_blank" class="btn" style="background:#facc15;color:#000;max-width:280px;margin:0 auto;font-size:11px">DM "STRATEGY" to Book</a></div></div>';
            } else {
                html += '<div style="border-top:1px solid #333;padding-top:16px;margin-bottom:16px"><div style="background:#000;border:1px solid #333;border-radius:6px;padding:16px;text-align:center"><p class="text-gray text-xs fw-bold tracking mb-2">Level Up</p><p class="text-white fw-bold text-sm mb-2">Want to increase your investable income?</p><p class="text-gray text-xs mb-4">The Budget Calculator finds hidden cash. Most users find $50-$200/mo.</p><a href="'+LINKS.BUDGET_CALC+'" target="_blank" class="btn btn-outline" style="max-width:280px;margin:0 auto;font-size:11px">Open Budget Calculator</a></div></div>';
            }

            // Share links
            html += '<div style="border-top:1px solid #333;padding-top:16px"><p class="text-gray text-xs tracking text-center mb-4">Quick Share Links</p><div class="grid-2 mb-4"><a href="'+LINKS.INSTAGRAM+'" target="_blank" class="btn btn-ig" style="grid-column:span 2">Open Instagram</a><a href="'+tweetUrl+'" target="_blank" class="btn btn-x">Open X</a><a href="'+liShareUrl+'" target="_blank" class="btn btn-li">Open LinkedIn</a></div></div>';

            // Personalized captions
            html += '<div style="border-top:1px solid #333;padding-top:16px"><p class="text-gray text-xs tracking text-center mb-4">Copy Your Personalized Captions</p><div class="grid-2">';
            var platforms = ['INSTAGRAM','TWITTER','LINKEDIN','TIKTOK'];
            for (var j = 0; j < platforms.length; j++) {
                html += '<button class="btn btn-outline text-xs" style="padding:8px" onclick="copyCaption(\''+platforms[j]+'\',this)">' + platforms[j] + '</button>';
            }
            html += '</div></div></div>';

            html += '<p class="text-gray text-xs text-center mt-4" style="padding-bottom:48px">Your Architect ID is permanent. Share it anywhere to prove you built the machine.</p>';

            app.innerHTML = html;

            // Store captions globally for copy function
            window._captions = captions;

            // Animated wealth counter
            animateCounter(data.projectedWealth);

            // Confetti after short delay
            setTimeout(function() { confetti.launch(); }, 800);

            // Load architect count
            loadArchitectCount();

            // Download handler
            document.getElementById('download-btn').addEventListener('click', function() {
                var btn = this;
                btn.textContent = 'GENERATING...';
                btn.disabled = true;
                html2canvas(document.getElementById('cert-card'), { backgroundColor: '#0a0a0a', scale: 3, useCORS: true }).then(function(canvas) {
                    var link = document.createElement('a');
                    link.download = 'autopilot-certificate-' + data.architectId + '.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    btn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> DOWNLOAD HIGH-RES CERTIFICATE';
                    btn.disabled = false;
                }).catch(function() { btn.textContent = 'DOWNLOAD FAILED'; btn.disabled = false; });
            });
        }

        function animateCounter(target) {
            var el = document.getElementById('wealth-counter');
            if (!el || target <= 0) { el.textContent = '$0'; return; }
            var start = Date.now(), duration = 2500;
            function tick() {
                var elapsed = Date.now() - start;
                var progress = Math.min(elapsed / duration, 1);
                var eased = 1 - Math.pow(1 - progress, 3);
                el.textContent = '$' + Math.round(target * eased).toLocaleString();
                if (progress < 1) requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        }

        async function loadArchitectCount() {
            var count = 47; // Believable floor
            try {
                if (window.storage) {
                    var r = await window.storage.get('architects-recent', true);
                    if (r) count = JSON.parse(r.value).length;
                }
            } catch(e) {}
            var el = document.getElementById('proof-count');
            var el2 = document.getElementById('proof-total');
            if (el) el.textContent = 'Architect #' + (count + 1);
            if (el2) el2.textContent = 'of ' + (count + 1) + ' total systems installed';
        }

        function copyText(text, btn) {
            navigator.clipboard.writeText(text);
            var orig = btn.textContent;
            btn.textContent = '\u2713 Copied';
            btn.classList.add('copied');
            setTimeout(function() { btn.textContent = orig; btn.classList.remove('copied'); }, 2000);
        }

        function copyCaption(platform, btn) {
            if (window._captions && window._captions[platform]) {
                navigator.clipboard.writeText(window._captions[platform]);
                var orig = btn.textContent;
                btn.textContent = '\u2713 Copied';
                btn.classList.add('copied');
                setTimeout(function() { btn.textContent = orig; btn.classList.remove('copied'); }, 2000);
            }
        }

        function recoverById() {
            var id = document.getElementById('recovery-id').value.trim().toUpperCase();
            if (id && id.startsWith('KOU-')) {
                localStorage.setItem('cashvault_architect_id', id);
                localStorage.setItem('command_center_architect_id', id);
                render();
            }
        }

        // Init
        confetti.init();
        render();
    </script>
</body>
</html>
